# IEC 104 数采平台

## 1. 概述

IEC 104 数采平台是 Zero-Service 的核心功能模块之一，专门用于处理 IEC 104 协议的工业数据采集和转发。该平台包含三个核心服务组件，采用 gRPC 协议进行消息转发，支持将 IEC 104 消息转换为统一格式，并存储到 TDengine 时序数据库中。

## 2. 转发协议定义

平台默认使用 gRPC 协议进行 IEC 104 消息转发，协议定义在 [`streamevent.proto`](facade/streamevent/streamevent.proto) 文件中。该协议支持将 IEC 104 消息转换为统一格式，并通过 gRPC 接口进行推送，同时支持 mqtt/kafka 协议进行数据推送。

### 2.1 推送接口

```protobuf
// 推送 chunk asdu 104协议消息
rpc PushChunkAsdu (PushChunkAsduReq) returns (PushChunkAsduRes) {}
```

### 2.2 消息体结构

```protobuf
// 消息体结构
message MsgBody {
  // 消息ID
  string msgId = 1 [json_name = "msgId"];
  // 采集设备地址
  string host = 2 [json_name = "host"];
  // 采集设备端口号
  int32 port = 3 [json_name = "port"];
  // ASDU类型名称
  string asdu = 4 [json_name = "asdu"];
  // ASDU类型标识符
  int32 typeId = 5 [json_name = "typeId"];
  // 信息体类型标识符
  int32 dataType = 6 [json_name = "dataType"];
  // 公共地址（范围：1-65534,全局地址65535保留）
  uint32 coa = 7 [json_name = "coa"];
  // 信息体对象（结构随typeId变化）
  string bodyRaw = 8 [json_name = "bodyRaw"];
  // 消息推送时间戳（格式：`YYYY-MM-DD HH:mm:ss.SSSSSS`,UTC+8时区）
  string time = 9 [json_name = "time"];
  // 应用级元数据（如：应用ID、用户信息、场站信息等）
  string metaDataRaw = 10 [json_name = "metaDataRaw"];
}
```

### 2.3 支持的信息体类型

协议支持多种 IEC 104 信息体类型，包括：

| 信息体类型 | 描述 |
|------------|------|
| SinglePointInfo | 单点遥信 |
| DoublePointInfo | 双点遥信 |
| MeasuredValueScaledInfo | 标度化遥测值 |
| MeasuredValueNormalInfo | 无品质描述的规一化遥测值 |
| StepPositionInfo | 步位置信息 |
| BitString32Info | 32位比特串 |
| MeasuredValueFloatInfo | 短浮点数遥测值 |
| BinaryCounterReadingInfo | 累计量 |
| EventOfProtectionEquipmentInfo | 继电保护事件 |
| PackedStartEventsOfProtectionEquipmentInfo | 继电器保护设备成组启动事件 |
| PackedOutputCircuitInfo | 继电器保护设备成组输出电路信息 |
| PackedSinglePointWithSCDInfo | 带变位检出的成组单点信息 |

## 3. 平台实现

IEC 104 数采平台包含三个核心服务组件，目前只实现采集原生指令数据功能：

### 3.1 ieccaller 服务

**功能描述**：实现 IEC 104 主站功能，负责与多个 IEC 104 从站通信，并支持 Kafka/MQTT/GRPC 推送数据，支持内嵌 SQLite 数据库进行动态配置管理。

**核心特性**：
- 支持与多个 IEC 104 从站同时通信
- 实现完整的 IEC 60870-5-104 协议栈
- 支持多种 ASDU 类型的解析和处理
- 支持 Kafka/MQTT/GRPC 多协议数据推送
- 支持配置驱动的设备管理
- 支持内嵌 SQLite 数据库，实现动态配置推送指令
- 可选择开启或关闭内嵌数据库功能
- 支持基于点位的推送控制，通过 `enable_push` 字段控制数据是否推送
- 采用弱校验模式：只有配置了点位且 `enable_push=0` 时才不推送数据，未配置点位时默认推送

**应用场景**：
- 智能电网监控系统
- 工业自动化数据采集
- 新能源设备监控
- 多协议数据融合场景
- 自定义数据采集系统
- 动态配置需求的场景
- 需要灵活控制数据推送的场景

### 3.2 iecstash 服务

**功能描述**：类似于 `go-stash` 或 `log-stash`，负责消费 Kafka 消息，对 ASDU 数据进行压缩合并处理，并转发给 streamevent 服务。

**核心特性**：
- 高效的 Kafka 消息消费
- ASDU 数据压缩合并处理
- Chunk 任务处理机制
- 支持批量数据处理
- 下游 RPC 服务调用

**应用场景**：
- 大规模 IEC 104 数据采集和转发
- 日志收集和处理
- 实时数据流处理

### 3.3 streamevent 服务

**功能描述**：基于 gRPC 协议的流事件接收服务，主要用于接收和处理 iecstash 压缩合并后的 ASDU 数据。目前只实现采集原生指令数据功能，其他业务处理功能暂不实现。

**核心特性**：
- 接收 iecstash 压缩合并后的 ASDU 数据
- 采集原生指令数据
- 点位设备嵌入式数据库
- 高性能内存缓存
- 支持多语言客户端
- 高并发消息处理
- 基于 streamevent.proto 协议
- 支持多种消息类型

**应用场景**：
- IEC 104 消息接收和处理
- 跨语言消息交互
- 实时数据采集
- 原生指令数据采集

**未来规划**：
- 添加主变监测采集功能
- 实现告警采集和处理
- 添加低电压告警等业务规则
- 支持自定义业务逻辑扩展
- 实现业务处理插件机制
- 支持实时数据分析和统计

### 3.4 数据处理流程

平台对接收的消息进行以下处理：

1. **消息解析**：解析消息体，提取关键信息
2. **配置查询**：根据点位信息查询配置
3. **数据转换**：将数据转换为适合存储的格式
4. **质量检查**：检查数据质量和有效性
5. **数据路由**：根据配置将数据路由到不同的存储或转发目标

### 3.5 数据存储

平台支持将处理后的数据存储到 TDengine 时序数据库中，主要存储以下类型的数据：

1. **原始数据**：完整的 IEC 104 消息原始数据
2. **处理后的数据**：根据配置处理后的数据
3. **统计数据**：根据需求生成的统计数据

### 3.6 轻量化配置

平台使用 SQLite 内嵌数据库进行点位配置管理，主要配置表包括：

#### 3.6.1 点位映射表

```sql
CREATE TABLE IF NOT EXISTS device_point_mapping (
    id INTEGER PRIMARY KEY AUTOINCREMENT,       -- 自增主键ID
    create_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,  -- 创建时间
    update_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,  -- 更新时间
    delete_time TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,  -- 删除时间（软删除标记）
    del_state INTEGER NOT NULL DEFAULT 0,       -- 删除状态：0-未删除，1-已删除
    version INTEGER NOT NULL DEFAULT 0,         -- 版本号（乐观锁）

    tag_station VARCHAR(64) NOT NULL DEFAULT '', -- 与 TDengine tag_station 对应
    coa INTEGER NOT NULL DEFAULT 0,              -- 与 TDengine coa 对应
    ioa INTEGER NOT NULL DEFAULT 0,              -- 与 TDengine ioa 对应
    device_id VARCHAR(64) NOT NULL DEFAULT '',   -- 设备编号/ID
    device_name VARCHAR(128) NOT NULL DEFAULT '',-- 设备名称
    td_table_type VARCHAR(255) NOT NULL DEFAULT '',-- TDengine 表类型
    enable_push INTEGER NOT NULL DEFAULT 1,      -- 是否允许caller服务推送数据：0-不允许，1-允许
    enable_raw_insert INTEGER NOT NULL DEFAULT 1,-- 是否允许插入 raw 原生数据
    description VARCHAR(256) NOT NULL DEFAULT '' -- 备注信息
);
```

**新增字段说明**：
- `enable_push`：控制 ieccaller 服务是否将该点位的数据推送到下游服务，默认值为 1（允许推送）
- 与现有 `enable_raw_insert` 字段配合，实现分层拦截策略

**分层拦截策略**：
| 场景 | 点位配置 | enable_push | enable_raw_insert | 行为 |
|------|----------|-------------|-------------------|------|
| 1 | 未配置 | - | - | caller 推送，默认允许通过 |
| 2 | 已配置 | 0 | 0 | caller 不推送，数据不会到达 facade |
| 3 | 已配置 | 0 | 1 | caller 不推送，数据不会到达 facade |
| 4 | 已配置 | 1 | 0 | caller 推送，facade 层不插入 TDengine |
| 5 | 已配置 | 1 | 1 | caller 推送，facade 层插入 TDengine |

## 4. 数据流向

IEC 104 数采平台三个服务组件之间的数据流向如下：

1. **ieccaller 服务**：
   - 与 IEC 104 从站建立连接并通信
   - 接收从站发送的 IEC 104 消息
   - 将消息转换为内部格式
   - 查询内嵌 SQLite 数据库获取点位配置
   - **弱校验模式**：只有配置了点位且 `enable_push=0` 时才不推送数据，未配置点位时默认推送
   - 根据配置将消息发送到 Kafka 或 MQTT
   - 支持直接转发给 streamevent 服务
   - 支持 Kafka/MQTT/GRPC 多协议数据推送

2. **iecstash 服务**：
   - 从 Kafka 主题消费 IEC 104 相关消息
   - 对 ASDU 数据进行压缩合并处理
   - 使用 chunk 任务处理机制对消息进行批量处理
   - 将压缩合并后的 ASDU 数据通过 gRPC 推送到 streamevent 服务

3. **streamevent 服务**：
   - 接收来自 ieccaller 或 iecstash 服务的 gRPC 消息
   - 查询 SQLite 内嵌数据库获取点位配置
   - 根据配置对消息进行处理和转换
   - 将处理后的数据存储到 TDengine 时序数据库
   - 根据配置将数据转发到其他系统（可选）

**整体数据流程**：
```
IEC 104 从站 → ieccaller 服务 → Kafka → iecstash 服务 → streamevent 服务 → TDengine
                              ↓
                              → MQTT → 自定义数据采集系统
                              ↓
                              → streamevent 服务 → TDengine
```

**协议支持说明**：
- ieccaller 服务支持 Kafka/MQTT/GRPC 多协议数据推送
- 平台默认采用 Kafka 进行 IEC 104 数据采集
- 用户可根据需求配置 MQTT 协议用于其他数据采集场景
- 两种协议可独立使用，也可同时启用

**灵活配置**：
- 支持通过配置文件动态调整协议类型
- 支持不同数据来源使用不同协议
- 支持协议级别的优先级设置
- 支持自定义协议路由规则

## 5. 使用方法

### 5.1 协议实现

任何语言只要实现了 streamevent.proto 定义的 gRPC 协议，就可以与 IEC 104 数采平台交互

### 5.2 配置管理

#### 5.2.1 ieccaller 服务 SQLite 配置

ieccaller 服务新增了 SQLite 内嵌数据库支持，可以通过配置文件选择开启或关闭该功能：

```yaml
# 数据库配置, 配置后将根据点位表推送数据
#SqliteDB:
#  DataSource: file:./model/sql/default.db?_busy_timeout=5000&_journal_mode=WAL
```

**配置说明**：
- 取消注释 `SqliteDB` 配置块即可开启内嵌数据库功能
- `DataSource`：指定 SQLite 数据库文件路径和连接参数
  - `_busy_timeout=5000`：设置数据库繁忙超时时间为 5 秒
  - `_journal_mode=WAL`：使用 WAL 模式提高并发性能

**开启内嵌数据库后的功能**：
- ieccaller 服务将查询点位表获取 `enable_push` 配置
- 根据 `enable_push` 字段决定是否推送数据
- 配置变更后需要重启服务才能生效

#### 5.2.2 配置管理方式

平台使用 SQLite 内嵌数据库进行配置管理，可以通过以下方式管理配置：

1. **直接操作数据库**：使用 SQLite 数据库工具直接管理配置
2**配置文件**：通过配置文件初始化系统配置
3**批量导入**：使用 `model/sql/insert_mass_data.sql` 脚本批量生成点位配置

### 5.3 测试数据生成

平台提供了测试数据生成脚本，用于生成测试点位和数据：

- `model/sql/sqlite.sql`：基础测试数据（10个点位）
- `model/sql/insert_mass_data.sql`：批量测试数据生成脚本（1-10万个点位）

## 6. TDengine 数据库设计

平台将数据存储到 TDengine 时序数据库中，主要表结构如下：

### 6.1 原始数据总表

```sql
CREATE STABLE IF NOT EXISTS iec104.raw_point_data (
  ts TIMESTAMP,
  msg_id varchar(64),
  host_v varchar(64),
  port_v INT,
  asdu varchar(32),
  type_id INT,
  data_type INT,
  coa INT,
  ioa INT,
  ioa_value varchar(1048),
  raw_msg varchar(5000)
) TAGS (tag_station varchar(64),tag_coa INT,tag_ioa INT);
```

### 6.2 遥信表

```sql
CREATE STABLE IF NOT EXISTS iec104.tele_signal_data (
  ts TIMESTAMP,
  msg_id varchar(64),
  data_type INT,
  signal_value bool  -- 遥信值：true/false
) TAGS (tag_station varchar(64), device_id varchar(64), tag_coa INT, tag_ioa INT);
```

### 6.3 遥测表

```sql
CREATE STABLE IF NOT EXISTS iec104.telemetry_data (
  ts TIMESTAMP,
  msg_id varchar(64),
  data_type INT,
  telemetry_value double  -- 遥测值：数值类型
) TAGS (tag_station varchar(64), device_id varchar(64), tag_coa INT, tag_ioa INT);
```

## 7. 性能优化

### 7.1 高并发设计

平台采用以下技术实现高并发处理：

1. **协程池**：使用协程池处理并发请求
2. **批量处理**：支持批量消息处理
3. **异步存储**：异步将数据存储到数据库
4. **连接池**：使用数据库连接池管理数据库连接

## 8. 监控与告警

平台提供了监控和告警功能，包括：

1. **系统监控**：监控系统运行状态和性能指标
2. **数据监控**：监控数据质量和完整性
4. **日志管理**：详细记录系统运行日志

## 9. 扩展与定制

平台设计灵活，易于扩展和定制，支持以下扩展方式：

1. **协议扩展**：支持扩展新的工业协议
2. **存储扩展**：支持扩展新的存储系统
3. **转发扩展**：支持扩展新的转发目标
4. **功能扩展**：支持扩展新的功能模块

## 10. 总结

IEC 104 数采平台是 Zero-Service 的核心功能模块之一，提供了高效、可靠的 IEC 104 数据采集和转发功能。平台采用 gRPC 协议实现语言无关的消息推送，使用 SQLite 内嵌数据库进行轻量化配置管理，将数据存储到 TDengine 时序数据库中。

目前平台只实现采集原生指令数据功能，其他业务处理功能（如主变监测、告警采集等）暂不实现。平台设计考虑了可扩展性，后续可根据需求灵活扩展新功能。