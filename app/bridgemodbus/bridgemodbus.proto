syntax = "proto3";

package bridgemodbus;
option go_package = "./bridgemodbus";
option java_multiple_files = true;
option java_package = "com.github.bridgemodbus.grpc";
option java_outer_classname = "BridgeModbusProto";

// Modbus 协议桥接服务
service BridgeModbus {
  rpc Ping(Req) returns (Res);

  // -------------------- 配置管理 --------------------

  // 保存（新增或更新）配置
  rpc SaveConfig(SaveConfigReq) returns (SaveConfigRes);

  // 删除配置（支持批量）
  rpc DeleteConfig(DeleteConfigReq) returns (DeleteConfigRes);

  // 分页查询配置列表
  rpc PageListConfig(PageListConfigReq) returns (PageListConfigRes);

  // 根据编码查询详情
  rpc GetConfigByCode(GetConfigByCodeReq) returns (GetConfigByCodeRes);

  // 根据编码数组查询详情
  rpc BatchGetConfigByCode(BatchGetConfigByCodeReq) returns (BatchGetConfigByCodeRes);

  // -------------------- Bit Access --------------------

  // 读取线圈状态 (Function Code 0x01)
  rpc ReadCoils(ReadCoilsReq) returns (ReadCoilsRes);

  // 读取离散输入状态 (Function Code 0x02)
  rpc ReadDiscreteInputs(ReadDiscreteInputsReq) returns (ReadDiscreteInputsRes);

  // 写单个线圈 (Function Code 0x05)
  rpc WriteSingleCoil(WriteSingleCoilReq) returns (WriteSingleCoilRes);

  // 写多个线圈 (Function Code 0x0F)
  rpc WriteMultipleCoils(WriteMultipleCoilsReq) returns (WriteMultipleCoilsRes);

  // -------------------- 16-bit Register Access --------------------

  // 读取输入寄存器 (Function Code 0x04)
  rpc ReadInputRegisters(ReadInputRegistersReq) returns (ReadInputRegistersRes);

  // 读取保持寄存器 (Function Code 0x03)
  rpc ReadHoldingRegisters(ReadHoldingRegistersReq) returns (ReadHoldingRegistersRes);

  // 写单个保持寄存器 (Function Code 0x06)
  rpc WriteSingleRegister(WriteSingleRegisterReq) returns (WriteSingleRegisterRes);

  // 写多个保持寄存器 (Function Code 0x10)
  rpc WriteMultipleRegisters(WriteMultipleRegistersReq) returns (WriteMultipleRegistersRes);

  // 读写多个保持寄存器 (Function Code 0x17)
  rpc ReadWriteMultipleRegisters(ReadWriteMultipleRegistersReq) returns (ReadWriteMultipleRegistersRes);

  // 屏蔽写保持寄存器 (Function Code 0x16)
  rpc MaskWriteRegister(MaskWriteRegisterReq) returns (MaskWriteRegisterRes);

  // 读取 FIFO 队列 (Function Code 0x18)
  rpc ReadFIFOQueue(ReadFIFOQueueReq) returns (ReadFIFOQueueRes);

  // -------------------- Device Identification --------------------

  // 读取设备标识 (Function Code 0x2B / 0x0E)
  rpc ReadDeviceIdentification(ReadDeviceIdentificationReq) returns (ReadDeviceIdentificationRes);

  // 读取特定 Object ID 的设备标识 (Function Code 0x2B / 0x0E)
  rpc ReadDeviceIdentificationSpecificObject(ReadDeviceIdentificationSpecificObjectReq) returns (ReadDeviceIdentificationSpecificObjectRes);
}

// -------------------- 通用请求/响应 --------------------

message Req {
  string ping = 1; // 健康检查请求内容
}

message Res {
  string pong = 1; // 健康检查返回内容
}

// -------------------- 请求与响应定义 --------------------

// Modbus 从站配置结构
message PbModbusConfig {
  // 主键ID
  int64 id = 1;
  // 创建时间
  string createTime = 2;
  // 更新时间
  string updateTime = 3;
  // Modbus链路编号
  string modbusCode = 4;
  // 从站通信地址（如TCP地址或串口）
  string slaveAddress = 5;
  // 从站地址（Slave ID）
  uint32 slave = 6;
  // 通信超时时间（毫秒）
  uint32 timeout = 7;
  // 空闲超时时间（毫秒）
  uint32 idleTimeout = 8;
  // 链路重连超时时间（毫秒）
  uint32 linkRecoveryTimeout = 9;
  // 协议恢复超时时间（毫秒）
  uint32 protocolRecoveryTimeout = 10;
  // 建链延迟时间（毫秒）
  uint32 connectDelay = 11;
  // 是否启用TLS加密
  uint32 enableTls = 12;
  // TLS证书文件路径
  string tlsCertFile = 13;
  // TLS私钥文件路径
  string tlsKeyFile = 14;
  // TLS CA证书文件路径
  string tlsCaFile = 15;
  // 当前状态（0=禁用，1=启用）
  uint32 status = 16;
  // 备注信息
  string remark = 17;
}

message SaveConfigReq {
  // Modbus链路编号
  string modbusCode = 1;
  // 从站通信地址（如TCP地址或串口）
  string slaveAddress = 2;
  // 从站地址（Slave ID）
  uint32 slave = 3;
}

message SaveConfigRes {
  int64 id = 1;
}

message DeleteConfigReq {
  repeated int64 ids = 1;
}

message DeleteConfigRes {
}

message PageListConfigReq {
  int64 page = 1; // 页码
  int64 pageSize = 2; // 每页大小
  string keyword = 3; // 模糊匹配 modbusCode
  uint32 status = 4;  // 可选过滤状态
}

message PageListConfigRes {
  uint32 total = 1;
  repeated PbModbusConfig cfg = 2;
}

message GetConfigByCodeReq {
  string modbusCode = 1;
}

message GetConfigByCodeRes {
  PbModbusConfig cfg = 1;
}

message BatchGetConfigByCodeReq {
  repeated string modbusCode = 1;
}

message BatchGetConfigByCodeRes {
  repeated PbModbusConfig cfg = 1;
}

// -------------------- Bit Access --------------------

message ReadCoilsReq {
  string modbusCode = 1; // Modbus配置唯一编码 空-默认文件配置 否则为自定义配置
  uint32 address = 2;   // 起始线圈地址
  uint32 quantity = 3;  // 读取数量（1–2000）
}
message ReadCoilsRes {
  bytes results = 1;    // 按位表示的线圈状态（bit0 对应起始地址）
  repeated bool values = 2;  // 每个元素对应一个线圈状态
}

message ReadDiscreteInputsReq {
  string modbusCode = 1; // Modbus配置唯一编码 空-默认文件配置 否则为自定义配置
  uint32 address = 2;   // 起始离散输入地址
  uint32 quantity = 3;  // 读取数量（1–2000）
}
message ReadDiscreteInputsRes {
  bytes results = 1;    // 按位表示的离散输入状态
  repeated bool values = 2;  // 每个元素对应一个离散输入
}

message WriteSingleCoilReq {
  string modbusCode = 1; // Modbus配置唯一编码 空-默认文件配置 否则为自定义配置
  uint32 address = 2;   // 线圈地址
  uint32 value = 3;     // 写入值：0x0000=OFF, 0xFF00=ON
}
message WriteSingleCoilRes {
  bytes results = 1;    // 回显写入后的线圈值
}

message WriteMultipleCoilsReq {
  string modbusCode = 1; // Modbus配置唯一编码 空-默认文件配置 否则为自定义配置
  uint32 address = 2;   // 起始线圈地址
  uint32 quantity = 3;  // 写入数量
  bytes values = 4;     // 每 bit 对应一个线圈状态，0=OFF，1=ON
}
message WriteMultipleCoilsRes {
  bytes results = 1;    // 回显写入的数量
}

// -------------------- 16-bit Register Access --------------------

message ReadInputRegistersReq {
  string modbusCode = 1; // Modbus配置唯一编码 空-默认文件配置 否则为自定义配置
  uint32 address = 2;   // 起始寄存器地址
  uint32 quantity = 3;  // 读取数量（1–125）
}
message ReadInputRegistersRes {
  bytes results = 1;    // 输入寄存器数据，每寄存器 2 字节，高字节在前
  repeated string values = 2; // 每个寄存器值按 16 进制字符串返回，例如 "0xFF01"
}

message ReadHoldingRegistersReq {
  string modbusCode = 1; // Modbus配置唯一编码 空-默认文件配置 否则为自定义配置
  uint32 address = 2;   // 起始寄存器地址
  uint32 quantity = 3;  // 读取数量（1–125）
}
message ReadHoldingRegistersRes {
  bytes results = 1;    // 保持寄存器数据，每寄存器 2 字节
  repeated string values = 2; // 每个寄存器值按 16 进制字符串返回，例如 "0xFF01"
}

message WriteSingleRegisterReq {
  string modbusCode = 1; // Modbus配置唯一编码 空-默认文件配置 否则为自定义配置
  uint32 address = 2;   // 寄存器地址
  uint32 value = 3;     // 写入的 16-bit 值
}
message WriteSingleRegisterRes {
  bytes results = 1;    // 回显写入后的寄存器值
}

message WriteMultipleRegistersReq {
  string modbusCode = 1; // Modbus配置唯一编码 空-默认文件配置 否则为自定义配置
  uint32 address = 2;   // 起始寄存器地址
  uint32 quantity = 3;  // 写入数量
  bytes values = 4;     // 按寄存器顺序的字节数组，每寄存器 2 字节
}
message WriteMultipleRegistersRes {
  bytes results = 1;    // 回显写入的数量
}

message ReadWriteMultipleRegistersReq {
  string modbusCode = 1; // Modbus配置唯一编码 空-默认文件配置 否则为自定义配置
  uint32 readAddress = 2;     // 读取起始寄存器地址
  uint32 readQuantity = 3;    // 读取数量
  uint32 writeAddress = 4;    // 写入起始寄存器地址
  uint32 writeQuantity = 5;   // 写入数量
  bytes values = 6;            // 写入数据，每寄存器 2 字节
}
message ReadWriteMultipleRegistersRes {
  bytes results = 1;           // 读取到的寄存器数据
}

message MaskWriteRegisterReq {
  string modbusCode = 1; // Modbus配置唯一编码 空-默认文件配置 否则为自定义配置
  uint32 address = 2;   // 寄存器地址
  uint32 andMask = 3;  // AND 掩码
  uint32 orMask = 4;   // OR 掩码
}
message MaskWriteRegisterRes {
  bytes results = 1;    // 回显写入后的寄存器值
}

message ReadFIFOQueueReq {
  string modbusCode = 1; // Modbus配置唯一编码 空-默认文件配置 否则为自定义配置
  uint32 address = 2;   // FIFO 队列寄存器地址
}
message ReadFIFOQueueRes {
  bytes results = 1;    // FIFO 队列内容
}

// -------------------- Device Identification --------------------

message ReadDeviceIdentificationReq {
  string modbusCode = 1; // Modbus配置唯一编码 空-默认文件配置 否则为自定义配置
  uint32 readDeviceIdCode = 2; // 读取类型：0x01=基本, 0x02=常规, 0x03=扩展
}
message ReadDeviceIdentificationRes {
  // 原始对象 ID 映射 (十进制)，方便协议调试/直接对应 Modbus 规范
  map<uint32, string> results = 1;
  // 对象 ID 用十六进制字符串表示，例如 "0x00", "0x01"
  map<string, string> hexResults = 2;
  // 语义化映射 (如果对象 ID 有标准含义，就用名字；否则 fallback 成 Object_0xXX)
  map<string, string> semanticResults = 3;
}

message ReadDeviceIdentificationSpecificObjectReq {
  string modbusCode = 1; // Modbus配置唯一编码 空=默认配置
  // 常见对象 ID 对照表：
  //   0x00 = 厂商名称 (VendorName)
  //   0x01 = 产品代码 (ProductCode)
  //   0x02 = 版本号 (MajorMinorRevision)
  //   0x03 = 厂商网址 (VendorURL)
  //   0x04 = 产品名称 (ProductName)
  //   0x05 = 型号名称 (ModelName)
  //   0x06 = 用户应用名称 (UserApplicationName)
  uint32 objectId = 2;   // 要读取的对象 ID (例如 0x00~0xFF)
}

message ReadDeviceIdentificationSpecificObjectRes {
  // 原始对象 ID 映射 (十进制)，方便协议调试/直接对应 Modbus 规范
  map<uint32, string> results = 1;
  // 对象 ID 用十六进制字符串表示，例如 "0x00", "0x01"
  map<string, string> hexResults = 2;
  // 语义化映射 (如果对象 ID 有标准含义，就用名字；否则 fallback 成 Object_0xXX)
  map<string, string> semanticResults = 3;
}