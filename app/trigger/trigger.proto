syntax = "proto3";

package trigger;

import "validate/validate.proto";
import "extproto.proto";

option go_package = "./trigger";
option java_multiple_files = true;
option java_package = "com.github.trigger.grpc";
option java_outer_classname = "TriggerProto";

service TriggerRpc {
  rpc Ping (Req) returns (Res);
  // 发送 http-post-json 回调
  rpc SendTrigger(SendTriggerReq) returns(SendTriggerRes);
  // 发送 grpc proto字节码 回调
  rpc SendProtoTrigger(SendProtoTriggerReq) returns (SendProtoTriggerRes);
  // 获取队列列表
  rpc Queues(QueuesReq) returns (QueuesRes);
  // 获取队列信息
  rpc GetQueueInfo(GetQueueInfoReq) returns (GetQueueInfoRes);
  // 归档任务
  rpc ArchiveTask(ArchiveTaskReq) returns (ArchiveTaskRes);
  // 删除任务
  rpc DeleteTask(DeleteTaskReq) returns (DeleteTaskRes);
  // 获取任务
  rpc GetTaskInfo(GetTaskInfoReq) returns (GetTaskInfoRes);
  // 删除所有已完成任务
  rpc DeleteAllCompletedTasks(DeleteAllCompletedTasksReq) returns (DeleteAllCompletedTasksRes);
  // 删除所有已归档任务
  rpc DeleteAllArchivedTasks(DeleteAllArchivedTasksReq) returns (DeleteAllArchivedTasksRes);
  // 获取任务历史统计
  rpc HistoricalStats(HistoricalStatsReq) returns (HistoricalStatsRes);
  // 获取活跃任务列表
  rpc ListActiveTasks(ListActiveTasksReq) returns (ListActiveTasksRes);
  // 获取待处理任务列表
  rpc ListPendingTasks(ListPendingTasksReq) returns (ListPendingTasksRes);
  // 获取聚合任务列表
  rpc ListAggregatingTasks(ListAggregatingTasksReq) returns (ListAggregatingTasksRes);
  // 获取预定任务列表
  rpc ListScheduledTasks(ListScheduledTasksReq) returns (ListScheduledTasksRes);
  // 获取重试任务列表
  rpc ListRetryTasks(ListRetryTasksReq) returns (ListRetryTasksRes);
  // 获取已归档任务列表
  rpc ListArchivedTasks(ListArchivedTasksReq) returns (ListArchivedTasksRes);
  // 获取已完成任务列表
  rpc ListCompletedTasks(ListCompletedTasksReq) returns (ListCompletedTasksRes);
  // 运行任务
  rpc RunTask(RunTaskReq) returns (RunTaskRes);


  // 计算计划任务日期
  rpc CalcPlanTaskDate(CalcPlanTaskDateReq) returns (CalcPlanTaskDateRes);
  // 创建计划任务
  rpc CreatePlanTask(CreatePlanTaskReq) returns (CreatePlanTaskRes);
  // 暂停计划
  rpc PausePlan(PausePlanReq) returns (PausePlanRes);
  // 终止计划
  rpc TerminatePlan(TerminatePlanReq) returns (TerminatePlanRes);
  // 恢复计划
  rpc ResumePlan(ResumePlanReq) returns (ResumePlanRes);
  // 暂停计划批次
  rpc PausePlanBatch(PausePlanBatchReq) returns (PausePlanBatchRes);
  // 终止计划批次
  rpc TerminatePlanBatch(TerminatePlanBatchReq) returns (TerminatePlanBatchRes);
  // 恢复计划批次
  rpc ResumePlanBatch(ResumePlanBatchReq) returns (ResumePlanBatchRes);

  // 暂停执行项
  rpc PausePlanExecItem(PausePlanExecItemReq) returns (PausePlanExecItemRes);
  // 终止执行项
  rpc TerminatePlanExecItem(TerminatePlanExecItemReq) returns (TerminatePlanExecItemRes);
  // 立即执行计划项
  rpc RunPlanExecItem(RunPlanExecItemReq) returns (RunPlanExecItemRes);
  // 恢复执行项
  rpc ResumePlanExecItem(ResumePlanExecItemReq) returns (ResumePlanExecItemRes);


  // 获取计划详情
  rpc GetPlan(GetPlanReq) returns (GetPlanRes);
  // 分页获取计划列表
  rpc ListPlans(ListPlansReq) returns (ListPlansRes);
  // 获取计划批次详情
  rpc GetPlanBatch(GetPlanBatchReq) returns (GetPlanBatchRes);
  // 分页获取计划批次列表
  rpc ListPlanBatches(ListPlanBatchesReq) returns (ListPlanBatchesRes);
  // 获取执行项详情
  rpc GetPlanExecItem(GetPlanExecItemReq) returns (GetPlanExecItemRes);
  // 分页获取执行项列表
  rpc ListPlanExecItems(ListPlanExecItemsReq) returns (ListPlanExecItemsRes);


  // 获取计划触发日志详情
  rpc GetPlanExecLog(GetPlanExecLogReq) returns (GetPlanExecLogRes);
  // 分页获取计划触发日志列表
  rpc ListPlanExecLogs(ListPlanExecLogsReq) returns (ListPlanExecLogsRes);


  // 回调计划执行项 ongoing 回执
  rpc CallbackPlanExecItem(CallbackPlanExecItemReq) returns (CallbackPlanExecItemRes);
}

// 执行项调度状态枚举定义
enum PbExecItemStatus {
  // 初始等待调度，可扫表触发
  EXEC_ITEM_STATUS_WAITING = 0;
  // 延期等待（业务失败重试或业务延期），可扫表触发
  EXEC_ITEM_STATUS_DELAYED = 10;
  // 已下发，等待业务回调，扫表时需判断超时
  EXEC_ITEM_STATUS_RUNNING = 100;
  // 执行项暂停（不扫表、不触发）
  EXEC_ITEM_STATUS_PAUSED = 150;
  // 执行完成终态，不再触发
  EXEC_ITEM_STATUS_COMPLETED = 200;
  // 人工/策略/超过重试次数终止，终态
  EXEC_ITEM_STATUS_TERMINATED = 300;
}

message PbTaskInfo {
  // ID is the identifier of the task.
  string id = 1;
  // Queue is the name of the queue in which the task belongs.
  string queue = 2;
  // Type is the type name of the task.
  string type = 3;
  // Payload is the payload data of the task.
  string payload = 4;
  // State indicates the task state.
  int32 state = 5; // 建议配合 enum TaskState 使用
  // MaxRetry is the maximum number of times the task can be retried.
  int32 maxRetry = 6;
  // Retried is the number of times the task has retried so far.
  int32 retried = 7;
  // LastErr is the error message from the last failure.
  string lastErr = 8;
  // LastFailedAt is the time of the last failure.
  string lastFailedAt = 9;
  // Timeout is the duration the task can be processed before being retried.
  int64 timeout = 10; // 使用秒为单位的 duration
  // Deadline is the deadline for the task.
  string deadline = 11;
  // Group is the name of the group in which the task belongs.
  string group = 12;
  // NextProcessAt is the time the task is scheduled to be processed.
  string nextProcessAt = 13;
  // IsOrphaned indicates if the task is left in active state with no worker.
  bool isOrphaned = 14;
  // Retention is duration of the retention period.
  int64 retention = 15; // 使用秒为单位的 duration
  // CompletedAt is the time when the task is processed successfully.
  string completedAt = 16; // 或 google.protobuf.Timestamp
  // Result holds the result data associated with the task.
  string result = 17;
}

message PbDailyStats  {
  // Name of the queue.
  string queue = 1;
  // Total number of tasks being processed during the given date.
  // The number includes both succeeded and failed tasks.
  int64 processed = 2;
  // Total number of tasks failed to be processed during the given date.
  int64 failed = 3;
  // Date this stats was taken.
  string date = 4;
}

message PbQueueInfo  {
  // Name of the queue.
  string Queue = 1;
  // Total number of bytes that the queue and its tasks require to be stored in redis.
  // It is an approximate memory usage value in bytes since the value is computed by sampling.
  int64 memoryUsage = 2;
  // Latency of the queue, measured by the oldest pending task in the queue.
  string latency = 3;
  // Size is the total number of tasks in the queue.
  // The value is the sum of Pending, Active, Scheduled, Retry, Aggregating and Archived.
  int64 size = 4;
  // Groups is the total number of groups in the queue.
  int64 groups = 5;
  // Number of pending tasks.
  int64 pending = 6;
  // Number of active tasks.
  int64 active = 7;
  // Number of scheduled tasks.
  int64 scheduled = 8;
  // Number of retry tasks.
  int64 retry = 9;
  // Number of archived tasks.
  int64 archived = 10;
  // Number of stored completed tasks.
  int64 completed = 11;
  // Number of aggregating tasks.
  int64 aggregating = 12;
  // Total number of tasks being processed within the given date (counter resets daily).
  // The number includes both succeeded and failed tasks.
  int64 processed = 13;
  // Total number of tasks failed to be processed within the given date (counter resets daily).
  int64 failed = 14;
  // Total number of tasks processed (cumulative).
  int64 processedTotal = 15;
  // Total number of tasks failed (cumulative).
  int64 failedTotal = 16;
  // Paused indicates whether the queue is paused.
  // If true, tasks in the queue will not be processed.
  bool paused = 17;
  // Time when this queue info snapshot was taken.
  string timestamp = 18;
}

message Req {
  string ping = 1;
}

message Res {
  string pong = 1;
}

message SendTriggerReq {
  extproto.CurrentUser currentUser = 100;

  // 秒
  uint64 processIn = 1;
  // 触发时间 2019-01-01 00:00:00 二选一 该字段存在时，优先使用
  string triggerTime = 2;
  // POST json提交 不可为空
  string url = 3;
  // 重试次数 可为空 默认: 25
  int64 maxRetry = 4;
  // 唯一消息 id 可为空
  string msgId = 5;
  // 触发内容，可为空
  string body = 6;
}

message SendTriggerRes {
  // 唯一追踪 id
  string traceId = 1;
  // Queue is the name of the queue in which the task belongs.
  string queue = 2;
  // ID is the identifier of the task.
  string id = 3;
}

message SendProtoTriggerReq {
  extproto.CurrentUser currentUser = 100;

  // 秒
  uint64 processIn = 1;
  // 触发时间 2019-01-01 00:00:00 二选一 该字段存在时，优先使用
  string triggerTime = 2;
  // 最大重试次数（可为空，默认 25 次）
  //
  // 任务失败后会重试，重试间隔采用指数退避策略，时间间隔随重试次数成倍增长：
  //   - 第 1 次重试间隔约 1 秒，
  //   - 第 2 次重试间隔约 2 秒，
  //   - 第 3 次重试间隔约 4 秒，
  //   - 依此类推，间隔时间不断翻倍，
  //   - 重试间隔最高封顶为 30 分钟（1800 秒）。
  //
  // 具体时间区间示例：
  //   1 次重试：约 1 秒
  //   5 次重试：约 16 秒
  //   7 次重试：约 64 秒（约 1 分钟）
  //   10 次重试：约 8 分钟
  //   12 次及以上重试：间隔固定为 30 分钟
  //
  // 总之，重试间隔从秒级开始，逐步增长到分钟、十几分钟，最终封顶 30 分钟。
  int64 maxRetry = 3;
  // 唯一消息 id 可为空
  string msgId = 4;
  // 服务名称 不可为空 示例 127.0.0.1:8080 direct:///127.0.0.1:8080,127.0.0.2:8080,nacos://nacos:nacos@127.0.0.1:8848/service?namespaceid=public&timeout=5000s
  string grpcServer = 5;
  // 方法 不可为空
  string method = 6;
  // pb 字节数据 不可为空
  bytes payload = 7;
  // 请求超时时间 单位: 毫秒 可为空
  int64 requestTimeout = 8;
}

message SendProtoTriggerRes {
  // 唯一追踪 id
  string traceId = 1;
  // Queue is the name of the queue in which the task belongs.
  string queue = 2;
  // ID is the identifier of the task.
  string id = 3;
}

message QueuesReq {
  extproto.CurrentUser currentUser = 100;
}

message QueuesRes {
  repeated string queues = 1;
}

message GetQueueInfoReq {
  extproto.CurrentUser currentUser = 100;

  // Queue is the name of the queue in which the task belongs.
  string queue = 1 [(validate.rules).string = {min_len: 1}]; // 默认 critical
}

message GetQueueInfoRes {
  PbQueueInfo queueInfo = 1;
}

message ArchiveTaskReq {
  extproto.CurrentUser currentUser = 100;

  // Queue is the name of the queue in which the task belongs.
  string queue = 1 [(validate.rules).string = {min_len: 1}]; // 默认 critical
  // ID is the identifier of the task.
  string id = 2 [(validate.rules).string = {min_len: 1}];
}

message ArchiveTaskRes {
}

message DeleteTaskReq {
  extproto.CurrentUser currentUser = 100;

  // Queue is the name of the queue in which the task belongs.
  string queue = 1 [(validate.rules).string = {min_len: 1}]; // 默认 critical
  // ID is the identifier of the task.
  string id = 2 [(validate.rules).string = {min_len: 1}];
}

message DeleteTaskRes {
}

message GetTaskInfoReq {
  extproto.CurrentUser currentUser = 100;

  // Queue is the name of the queue in which the task belongs.
  string queue = 1 [(validate.rules).string = {min_len: 1}]; // 默认 critical
  // ID is the identifier of the task.
  string id = 2 [(validate.rules).string = {min_len: 1}];
}

message GetTaskInfoRes {
  PbTaskInfo taskInfo = 1;
}

message DeleteAllCompletedTasksReq {
  extproto.CurrentUser currentUser = 100;

  // Queue is the name of the queue in which the task belongs.
  string queue = 1 [(validate.rules).string = {min_len: 1}]; // 默认 critical
}

message DeleteAllCompletedTasksRes {
  int64 count = 1;
}

message DeleteAllArchivedTasksReq {
  extproto.CurrentUser currentUser = 100;

  // Queue is the name of the queue in which the task belongs.
  string queue = 1 [(validate.rules).string = {min_len: 1}]; // 默认 critical
}

message DeleteAllArchivedTasksRes {
  int64 count = 1;
}

message HistoricalStatsReq {
  extproto.CurrentUser currentUser = 100;

  // Queue is the name of the queue in which the task belongs.
  string queue = 1 [(validate.rules).string = {min_len: 1}]; // 默认 critical
  // 天
  uint32 n = 2 [(validate.rules).uint32 = {gte:1, lte:90}];
}

message HistoricalStatsRes {
  repeated PbDailyStats dailyStat = 1;
}

message ListActiveTasksReq {
  extproto.CurrentUser currentUser = 100;

  int64 pageSize = 1 [(validate.rules).int64 = {gte:0}];
  int64 pageNum = 2 [(validate.rules).int64 = {gte:0}];
  string queue = 3 [(validate.rules).string = {min_len: 1}]; // 默认 critical
}

message ListActiveTasksRes {
  PbQueueInfo queueInfo = 1;
  repeated PbTaskInfo tasksInfo = 2;
}

message ListPendingTasksReq {
  extproto.CurrentUser currentUser = 100;

  int64 pageSize = 1 [(validate.rules).int64 = {gte:0}];
  int64 pageNum = 2 [(validate.rules).int64 = {gte:0}];
  string queue = 3 [(validate.rules).string = {min_len: 1}]; // 默认 critical
}

message ListPendingTasksRes {
  PbQueueInfo queueInfo = 1;
  repeated PbTaskInfo tasksInfo = 2;
}

message ListAggregatingTasksReq {
  extproto.CurrentUser currentUser = 100;

  int64 pageSize = 1 [(validate.rules).int64 = {gte:0}];
  int64 pageNum = 2 [(validate.rules).int64 = {gte:0}];
  string queue = 3 [(validate.rules).string = {min_len: 1}]; // 默认 critical
  string group = 4 [(validate.rules).string = {min_len: 1}];
}

message ListAggregatingTasksRes {
  PbQueueInfo queueInfo = 1;
  repeated PbTaskInfo tasksInfo = 2;
}

message ListScheduledTasksReq {
  extproto.CurrentUser currentUser = 100;

  int64 pageSize = 1 [(validate.rules).int64 = {gte:0}];
  int64 pageNum = 2 [(validate.rules).int64 = {gte:0}];
  string queue = 3 [(validate.rules).string = {min_len: 1}]; // 默认 critical
}

message ListScheduledTasksRes {
  PbQueueInfo queueInfo = 1;
  repeated PbTaskInfo tasksInfo = 2;
}

message ListRetryTasksReq {
  extproto.CurrentUser currentUser = 100;

  int64 pageSize = 1 [(validate.rules).int64 = {gte:0}];
  int64 pageNum = 2 [(validate.rules).int64 = {gte:0}];
  string queue = 3 [(validate.rules).string = {min_len: 1}]; // 默认 critical
}

message ListRetryTasksRes {
  PbQueueInfo queueInfo = 1;
  repeated PbTaskInfo tasksInfo = 2;
}

message ListArchivedTasksReq {
  extproto.CurrentUser currentUser = 100;

  int64 pageSize = 1 [(validate.rules).int64 = {gte:0}];
  int64 pageNum = 2 [(validate.rules).int64 = {gte:0}];
  string queue = 3 [(validate.rules).string = {min_len: 1}]; // 默认 critical
}

message ListArchivedTasksRes {
  PbQueueInfo queueInfo = 1;
  repeated PbTaskInfo tasksInfo = 2;
}

message ListCompletedTasksReq {
  extproto.CurrentUser currentUser = 100;

  int64 pageSize = 1 [(validate.rules).int64 = {gte:0}];
  int64 pageNum = 2 [(validate.rules).int64 = {gte:0}];
  string queue = 3 [(validate.rules).string = {min_len: 1}]; // 默认 critical
}

message ListCompletedTasksRes {
  PbQueueInfo queueInfo = 1;
  repeated PbTaskInfo tasksInfo = 2;
}

message RunTaskReq {
  extproto.CurrentUser currentUser = 100;

  // Queue is the name of the queue in which the task belongs.
  string queue = 1 [(validate.rules).string = {min_len: 1}]; // 默认 critical
  // ID is the identifier of the task.
  string id = 2 [(validate.rules).string = {min_len: 1}];
}

message RunTaskRes {
}

message CalcPlanTaskDateReq {
  extproto.CurrentUser currentUser = 100;
  // 规则生效开始时间
  // 不传默认本年
  // 格式：yyyy-MM-dd HH:mm:ss
  string startTime = 1;
  // 规则生效结束时间
  // 不传默认本年
  // 格式：yyyy-MM-dd HH:mm:ss
  string endTime = 2;
  // 计划规则项 默认 规则项 MINUTELY
  PbPlanRule rule = 3 [(validate.rules).message = {required: true}];
}

message CalcPlanTaskDateRes {
  repeated string planDates = 1;
}

message CreatePlanTaskReq {
  extproto.CurrentUser currentUser = 100;
  // 机构code
  string deptCode = 101 [(validate.rules).string = {min_len: 1}];

  // 计划任务ID,全局唯一
  string planId = 1 [(validate.rules).string = {min_len: 1}];
  // 计划任务名称
  string planName = 2 [(validate.rules).string = {min_len: 1}];
  // 任务类型
  string type = 3 [(validate.rules).string = {min_len: 1}];
  // 计划组ID,用于分组管理计划任务
  string groupId = 4;
  // 描述
  string description = 5 [(validate.rules).string = {max_len: 200}];
  // 规则生效开始时间
  // 不传默认本年
  // 格式：yyyy-MM-dd HH:mm:ss
  string startTime = 6;
  // 规则生效结束时间
  // 不传默认本年
  // 格式：yyyy-MM-dd HH:mm:ss
  string endTime = 7;
  // 计划规则项 默认 规则项 MINUTELY
  PbPlanRule rule = 8 [(validate.rules).message = {required: true}];
  // 间隔时间 单位: 毫秒
  int64 intervalTime = 9 [(validate.rules).int64 = {gte: 0}];
  // 间隔类型 0-不间隔（同时发起） 1-往后顺延 2-间隔时间内偏移
  int32 intervalType = 10 [(validate.rules).int32 = {gte: 0, lte: 2}];
  // 计划执行项-根据规则项生成日期批次-batchId 并生成对应批次执行项-execId
  repeated CreatePlanExecItem execItems = 11 [(validate.rules).repeated = {min_items: 1}];

  // 扩展字段
  string ext1 = 50;
  string ext2 = 51;
  string ext3 = 52;
  string ext4 = 53;
  string ext5 = 54;
}

message PbPlanRule {
  // 规则项 0-YEARLY 1-MONTHLY 2-WEEKLY 3-DAILY 4-HOURLY 5-MINUTELY
  int32 freq = 1 [(validate.rules).int32 = {gte: 0, lte: 5}];
  // 月（1-12）
  repeated int32 month = 2 [
    (validate.rules).repeated = {
      items: {int32: {gte: 1, lte: 12}}
    }
  ];
  // 月中的第几天（1-31 / -1 表示倒数第 1 天）
  repeated int32 day = 3 [
    (validate.rules).repeated = {
      items: {int32: {gte: -31, lte: 31, not_in: [0]}}
    }
  ];
  // 星期（1-7，1=周一，7=周日）
  repeated int32 week = 4 [
    (validate.rules).repeated = {
      items: {int32: {gte: 1, lte: 7}}
    }
  ];
  // 执行小时（0-23）
  repeated int32 hours = 5 [
    (validate.rules).repeated = {
      min_items: 1,
      items: {int32: {gte: 0, lte: 23}}
    }
  ];
  // 执行分钟（0-59）
  repeated int32 minutes = 6 [
    (validate.rules).repeated = {
      min_items: 1,
      items: {int32: {gte: 0, lte: 59}}
    }
  ];
}

message CreatePlanExecItem {
  // 执行项ID,业务字段,例如工单号
  string itemId = 1 [(validate.rules).string = {min_len: 1}];
  // 执行项类型,业务字段
  string itemType = 2;
  // 执行项名称,业务字段
  string itemName = 3;
  // 点位id,业务字段
  string pointId = 4;
  // 业务负载（必填）：序列化的业务专属参数（设备参数/转账金额/订单信息等）
  string payload = 5;
  // 请求超时时间 单位: 毫秒 可为空
  int64 requestTimeout = 6;

  // 扩展字段
  string ext1 = 50;
  string ext2 = 51;
  string ext3 = 52;
  string ext4 = 53;
  string ext5 = 54;
}

message CreatePlanTaskRes {
  // 计划主键ID
  int64 id = 1;
  // 计划ID
  string planId = 2;
  // 计划批次数
  int64 batchCnt = 3;
  // 执行计划数
  int64 execCnt = 4;
}

message PausePlanReq {
  extproto.CurrentUser currentUser = 100;
  int64 id = 1;
  string planId = 2;
  // 暂停原因
  string reason = 3 [(validate.rules).string = {max_len: 200}];
}

message PausePlanRes {
}

message TerminatePlanReq {
  extproto.CurrentUser currentUser = 100;
  int64 id = 1;
  string planId = 2;
  // 终止原因
  string reason = 3 [(validate.rules).string = {max_len: 200}];
}

message TerminatePlanRes {
}

message ResumePlanReq {
  extproto.CurrentUser currentUser = 100;
  int64 id = 1;
  string planId = 2;
}

message ResumePlanRes {
}

message PausePlanBatchReq {
  extproto.CurrentUser currentUser = 100;
  int64 id = 1;
  string batchId = 2;
  // 暂停原因
  string reason = 3 [(validate.rules).string = {max_len: 200}];
}

message PausePlanBatchRes {
}

message TerminatePlanBatchReq {
  extproto.CurrentUser currentUser = 100;
  int64 id = 1;
  string batchId = 2;
  // 终止原因
  string reason = 3 [(validate.rules).string = {max_len: 200}];
}

message TerminatePlanBatchRes {
}

message ResumePlanBatchReq {
  extproto.CurrentUser currentUser = 100;
  int64 id = 1;
  string batchId = 2;
}

message ResumePlanBatchRes {
}

message PausePlanExecItemReq {
  extproto.CurrentUser currentUser = 100;
  int64 id = 1;
  string execId = 2;
  // 暂停原因
  string reason = 3 [(validate.rules).string = {max_len: 200}];
}

message PausePlanExecItemRes {
}

message TerminatePlanExecItemReq {
  extproto.CurrentUser currentUser = 100;
  int64 id = 1;
  string execId = 2;
  // 终止原因
  string reason = 3 [(validate.rules).string = {max_len: 200}];
}

message TerminatePlanExecItemRes {
}

message ResumePlanExecItemReq {
  extproto.CurrentUser currentUser = 100;
  int64 id = 1;
  string execId = 2;
}

message ResumePlanExecItemRes {
}

// 立即执行计划项请求
message RunPlanExecItemReq {
  extproto.CurrentUser currentUser = 100;
  int64 id = 1;
  string execId = 2;
}

// 立即执行计划项响应
message RunPlanExecItemRes {
}

message GetPlanReq {
  extproto.CurrentUser currentUser = 100;
  int64 id = 1;
  string planId = 2;
}

message GetPlanRes {
  PbPlan plan = 1;
}

message PbPlan{
  // 创建时间
  string createTime = 101;
  // 更新时间
  string updateTime = 102;
  // 创建人
  string createUser = 103;
  // 更新人
  string updateUser = 104;
  // 机构code
  string deptCode = 105;

  // 自增主键ID
  int64 id = 50;
  // 计划ID
  string planId = 1;
  // 计划名称
  string planName = 2;
  // 任务类型
  string type = 3;
  // 计划组ID,用于分组管理计划任务
  string groupId = 4;
  // 描述
  string description = 5;
  // 规则生效开始时间
  string startTime = 6;
  // 规则生效结束时间
  string endTime = 7;
  // 计划规则项
  PbPlanRule rule = 8;
  // 状态：1-启用，2-暂停，3-终止
  int32 status = 9;
  // 终止原因
  string terminatedReason = 10;
  // 暂停时间
  string pausedTime = 11;
  // 暂停原因
  string pausedReason = 12;
  // 执行进度 0.00-100.00
  float progress = 13;
  // 扩展字段1
  string ext1 = 14;
  // 扩展字段2
  string ext2 = 15;
  // 扩展字段3
  string ext3 = 16;
  // 扩展字段4
  string ext4 = 17;
  // 扩展字段5
  string ext5 = 18;
}

message ListPlansReq {
  extproto.CurrentUser currentUser = 100;
  // 分页大小
  int64 pageSize = 1 [(validate.rules).int64 = {gte: 0}];
  // 页码
  int64 pageNum = 2 [(validate.rules).int64 = {gte: 0}];
  // 计划ID模糊查询
  string planId = 3;
  // 计划名称模糊查询
  string planName = 4;
  // 状态：1-启用，2-暂停，3-终止
  repeated int32 status = 5;
  // 任务类型
  string type = 6;
}

message ListPlansRes {
  // 计划列表
  repeated PbPlan plans = 1;
  // 总记录数
  int64 total = 2;
}

message GetPlanBatchReq {
  extproto.CurrentUser currentUser = 100;
  int64 id = 1;
  string batchId = 2;
}

message GetPlanBatchRes {
  PbPlanBatch planBatch = 1;
}

message ListPlanBatchesReq {
  extproto.CurrentUser currentUser = 100;
  // 分页大小
  int64 pageSize = 1 [(validate.rules).int64 = {gte: 0}];
  // 页码
  int64 pageNum = 2 [(validate.rules).int64 = {gte: 0}];
  // 计划主键ID
  int64 planPk = 3;
  // 计划ID
  string planId = 4;
  // 批次ID
  string batchId = 5;
  // 状态：1-启用，2-暂停，3-终止
  repeated int32 status = 6;
}

message ListPlanBatchesRes {
  // 批次列表
  repeated PbPlanBatch planBatches = 1;
  // 总记录数
  int64 total = 2;
}

message GetPlanExecItemReq {
  extproto.CurrentUser currentUser = 100;
  int64 id = 1;
  string execId = 2;
}

message GetPlanExecItemRes {
  repeated PbPlanExecItem planExecItem = 1;
}

message PbPlanExecItem {
  // 创建时间
  string createTime = 101;
  // 更新时间
  string updateTime = 102;
  // 创建人
  string createUser = 103;
  // 更新人
  string updateUser = 104;
  // 机构code
  string deptCode = 105;

  // 自增主键ID
  int64 id = 50;
  // 关联的计划主键ID
  int64 planPk = 1;
  // 计划ID
  string planId = 2;
  // 批主键ID
  int64 batchPk = 4;
  // 批ID
  string batchId = 5;
  // 执行ID 全局唯一
  string execId = 6;
  // 执行项ID
  string itemId = 7;
  // 执行项类型
  string itemType = 8;
  // 执行项名称
  string itemName = 9;
  // 点位id
  string PointId = 10;
  // 业务负载
  string payload = 11;
  // 请求超时时间（毫秒）
  int64 requestTimeout = 12;
  // 间隔时间 单位: 毫秒
  int64 intervalTime = 13;
  // 间隔类型 0-不间隔（同时发起） 1-往后顺延 2-间隔时间内偏移
  int32 intervalType = 14;
  // 偏移百分比（0-100），仅当 intervalType=2 时生效
  int32 offsetPercent = 15;
  // 计划触发时间
  string planTriggerTime = 16;
  // 下次触发时间
  string nextTriggerTime = 17;
  // 上次触发时间
  string lastTriggerTime = 18;
  // 触发次数
  int32 triggerCount = 19;
  // 状态
  PbExecItemStatus status = 20;
  // 上次执行结果
  string lastResult = 21;
  // 上次结果描述
  string lastMessage = 22;
  // 上次结果原因
  string lastReason = 23;
  // 终止原因
  string terminatedReason = 24;
  // 暂停时间
  string pausedTime = 25;
  // 暂停原因
  string pausedReason = 26;
  // 扩展字段1
  string ext1 = 51;
  // 扩展字段2
  string ext2 = 52;
  // 扩展字段3
  string ext3 = 53;
  // 扩展字段4
  string ext4 = 54;
  // 扩展字段5
  string ext5 = 55;
}

message ListPlanExecItemsReq {
  extproto.CurrentUser currentUser = 100;
  // 分页大小
  int64 pageSize = 1 [(validate.rules).int64 = {gte: 0}];
  // 页码
  int64 pageNum = 2 [(validate.rules).int64 = {gte: 0}];
  // 计划主键 id
  int64 id = 3 [(validate.rules).int64 = {gte: 0}];
  // 执行ID（唯一索引）
  string execId = 4;
  // 计划ID
  string planId = 5;
  // 批ID
  string batchId = 6;
  // 执行项ID模糊查询
  string itemId = 7;
  // 执行项名称模糊查询
  string itemName = 8;
  repeated PbExecItemStatus status = 9;
}

message ListPlanExecItemsRes {
  // 执行项列表
  repeated PbPlanExecItem  planExecItems = 1;
  // 总记录数
  int64 total = 2;
}

message GetPlanExecLogReq {
  extproto.CurrentUser currentUser = 100;
  int64 id = 1 [(validate.rules).int64 = {gte: 1}];
}

message GetPlanExecLogRes {
  PbPlanExecLog planExecLog = 1;
}


// 分页获取计划触发日志列表请求
message ListPlanExecLogsReq {
  extproto.CurrentUser currentUser = 100;
  // 分页大小
  int64 pageSize = 1 [(validate.rules).int64 = {gte: 0}];
  // 页码
  int64 pageNum = 2 [(validate.rules).int64 = {gte: 0}];
  // 计划ID
  string planId = 3;
  // 批ID
  string batchId = 4;
  // 执行项ID
  string itemId = 5;
  // 执行ID
  string execId = 6;
  // 开始时间
  string startTime = 7;
  // 结束时间
  string endTime = 8;
  // 执行结果：1-成功，2-失败，3-延期
  repeated int32 execResult = 9;
}

// 分页获取计划触发日志列表响应
message ListPlanExecLogsRes {
  // 日志列表
  repeated PbPlanExecLog planExecLogs = 1;
  // 总记录数
  int64 total = 2;
}

message PbPlanExecLog {
  // 创建时间
  string createTime = 101;
  // 更新时间
  string updateTime = 102;
  // 创建人
  string createUser = 103;
  // 更新人
  string updateUser = 104;
  // 机构code
  string deptCode = 105;

  // 自增主键ID
  int64 id = 50;
  // 关联的计划主键ID
  int64 planPk = 1;
  // 计划ID
  string planId = 2;
  // 计划名称
  string planName = 3;
  // 批主键ID
  int64 batchPk = 4;
  // 批ID
  string batchId = 5;
  // 关联的执行项主键ID
  int64 itemPk = 6;
  // 执行ID 全局唯一
  string execId = 7;
  // 执行项ID
  string itemId = 8;
  // 执行项类型
  string itemType = 9;
  // 执行项名称
  string itemName = 10;
  // 点位id
  string pointId = 11;
  // 触发时间
  string triggerTime = 12;
  // 执行结果：completed-业务执行完成，failed-业务执行失败，delayed-业务执行延期，ongoing-业务正在执行
  string execResult = 13;
  // 结果描述
  string message = 14;
}

// 计划批次数据模型
message PbPlanBatch {
  // 创建时间
  string createTime = 101;
  // 更新时间
  string updateTime = 102;
  // 创建人
  string createUser = 103;
  // 更新人
  string updateUser = 104;
  // 机构code
  string deptCode = 105;

  // 自增主键ID
  int64 id = 50;
  // 关联的计划主键ID
  int64 planPk = 1;
  // 计划ID
  string planId = 2;
  // 批ID
  string batchId = 3;
  // 批次名称
  string batchName = 4;
  // 状态：1-启用，2-暂停，3-终止
  int32 status = 5;
  // 计划触发时间
  string planTriggerTime = 6;
  // 终止原因
  string terminatedReason = 7;
  // 暂停时间
  string pausedTime = 8;
  // 暂停原因
  string pausedReason = 9;
  // 结束时间
  string finishedTime = 10;
  // 状态统计map，key为状态值，value为对应数量
  map<string, int64> statusCountMap = 11;
  // 执行计划数
  int64 execCnt = 12;
  // 扩展字段1
  string ext1 = 13;
  // 扩展字段2
  string ext2 = 14;
  // 扩展字段3
  string ext3 = 15;
  // 扩展字段4
  string ext4 = 16;
  // 扩展字段5
  string ext5 = 17;
}

message CallbackPlanExecItemReq {
  extproto.CurrentUser currentUser = 100;

  // 自增主键ID
  int64 id = 1;
  // 执行ID 全局唯一
  string execId = 2;
  // 回调设计 参考 grpc status 用于分布式事务
  // 执行结果：completed-业务执行完成, terminated-业务终止, failed-业务执行失败, delayed-业务执行延期, ongoing-业务正在执行（未回调或部分异步）
  string execResult = 3 [(validate.rules).string = {in: ["completed", "terminated", "failed", "delayed"]}];
  // 结果描述  可以定义自己状态码，等下次回调判断业务场景
  string message = 4;
  // 结果原因 （成功/失败/延期原因，如“设备离线，延期至2024-01-01 09:00:00”）
  string reason = 5;
  // 延期配置：delayed-自定义延期
  PbDelayConfig delayConfig = 6;
}

message PbDelayConfig {
  // 下次触发时间（格式：yyyy-MM-dd HH:mm:ss，定时扫描的核心筛选条件）
  string nextTriggerTime = 1;
  // 延期原因
  string delayReason = 2;
}

message CallbackPlanExecItemRes {
}