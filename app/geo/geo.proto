syntax = "proto3";

package geo;
option go_package = "./geo";
option java_multiple_files = true;
option java_package = "com.github.geo.grpc";
option java_outer_classname = "GeoProto";

// 坐标系类型枚举（覆盖国内主流场景，后续可扩展）
enum CoordType {
  COORD_TYPE_UNSPECIFIED = 0; // 未指定（默认无效值，用于校验）
  COORD_TYPE_WGS84 = 1;       // WGS84：GPS原生坐标（国际通用）
  COORD_TYPE_GCJ02 = 2;       // GCJ02：高德/腾讯/谷歌中国坐标（火星加密）
  COORD_TYPE_BD09 = 3;        // BD09：百度坐标（在GCJ02基础上二次加密）
}

// GEO 相关服务
service Geo {
  rpc Ping (Req) returns (Res);
  // 计算 geohash
  rpc EncodeGeoHash (EncodeGeoHashReq) returns (EncodeGeoHashRes);
  // 解码 geohash -> 经纬度
  rpc DecodeGeoHash (DecodeGeoHashReq) returns (DecodeGeoHashRes);
  // 一次性生成围栏 cells（小围栏）
  rpc GenerateFenceCells (GenFenceCellsReq) returns (GenFenceCellsRes);
  // 点是否命中电子围栏（单个）
  rpc PointInFence (PointInFenceReq) returns (PointInFenceRes);
  // 点是否命中电子围栏（多个围栏）
  rpc PointInFences (PointInFencesReq) returns (PointInFencesRes);
  // 计算两个点之间的距离（米）
  rpc Distance (DistanceReq) returns (DistanceRes);
  // 获取某点附近多少 km 的围栏（粗过滤）
  rpc NearbyFences (NearbyFencesReq) returns (NearbyFencesRes);
  // 单个坐标转换
  rpc TransformCoord (TransformCoordReq) returns (TransformCoordRes);
  // 批量坐标转换
  rpc BatchTransformCoord (BatchTransformCoordReq) returns (BatchTransformCoordRes);
}

message Req {
  string ping = 1;
}

message Res {
  string pong = 1;
}

message Point {
  double lat = 1; // 纬度
  double lon = 2; // 经度
}

message EncodeGeoHashReq {
  Point point = 1;
  uint32 precision = 2; // 默认 7 max-12
}

message EncodeGeoHashRes {
  string geohash = 1;
}

message DecodeGeoHashReq {
  string geohash = 1;
}

message DecodeGeoHashRes {
  Point point = 1; // 中心点
  double latMin = 2; // 最小纬度
  double latMax = 3; // 最大纬度
  double lonMin = 4; // 最小经度
  double lonMax = 5; // 最大经度
}

message GenFenceCellsReq {
  string fenceId = 1;          // 可选：已有 fence ID
  repeated Point points = 2;   // polygon 顶点（当 fenceId 不存在时直接传 polygon）
  uint32 precision = 3;        // geohash 精度，默认 7
  bool includeNeighbors = 4;   // 是否扩展周边格子（默认 false）
}

message GenFenceCellsRes {
  repeated string geohashes = 1; // geohash 列表（去重后的前缀）
}

message Fence {
  string id = 1;
  repeated Point points = 2; // polygon
}

message PointInFenceReq {
  Point point = 1;
  Fence fence = 2;
}

message PointInFenceRes {
  bool hit = 1;
}

message PointInFencesReq {
  Point point = 1;
  repeated Fence fences = 2;
}

message PointInFencesRes {
  repeated string hitFenceIds = 1; // 命中的 fence ID 列表
}

message DistanceReq {
  Point a = 1;
  Point b = 2;
}

message DistanceRes {
  double meters = 1;
}

message NearbyFencesReq {
  Point point = 1;
  double km = 2;
}

message NearbyFencesRes {
  repeated string fenceIds = 1; // 粗过滤候选
}

message TransformCoordReq {
  Point point = 1;             // 待转换的点
  CoordType sourceType = 2;   // 源坐标系（必填）
  CoordType targetType = 3;   // 目标坐标系（必填）
}

message TransformCoordRes {
  Point transformedPoint = 1; // 转换后的点
}

message BatchTransformCoordReq {
  repeated Point points = 1;   // 待转换的点列表（必填）
  CoordType sourceType = 2;   // 源坐标系（必填）
  CoordType targetType = 3;   // 目标坐标系（必填）
}

message BatchTransformCoordRes {
  repeated Point transformedPoints = 1; // 转换后的点列表（与输入顺序一致）
}