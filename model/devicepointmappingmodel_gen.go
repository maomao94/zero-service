// Code generated by goctl. DO NOT EDIT.
// versions:
//  goctl version: 1.7.1

package model

import (
	"context"
	"database/sql"
	"fmt"
	"strings"
	"time"

	"github.com/Masterminds/squirrel"
	"github.com/pkg/errors"
	"github.com/zeromicro/go-zero/core/stores/builder"
	"github.com/zeromicro/go-zero/core/stores/sqlx"
	"github.com/zeromicro/go-zero/core/stringx"
)

var (
	devicePointMappingFieldNames          = builder.RawFieldNames(&DevicePointMapping{})
	devicePointMappingRows                = strings.Join(devicePointMappingFieldNames, ",")
	devicePointMappingRowsExpectAutoSet   = strings.Join(stringx.Remove(devicePointMappingFieldNames, "`id`", "`create_at`", "`create_time`", "`created_at`", "`update_at`", "`update_time`", "`updated_at`"), ",")
	devicePointMappingRowsWithPlaceHolder = strings.Join(stringx.Remove(devicePointMappingFieldNames, "`id`", "`create_at`", "`create_time`", "`created_at`", "`update_at`", "`update_time`", "`updated_at`"), "=?,") + "=?"
)

type (
	devicePointMappingModel interface {
		Insert(ctx context.Context, session sqlx.Session, data *DevicePointMapping) (sql.Result, error)
		FindOne(ctx context.Context, id int64) (*DevicePointMapping, error)
		FindOneByTagStationCoaIoa(ctx context.Context, tagStation string, coa int64, ioa int64) (*DevicePointMapping, error)
		Update(ctx context.Context, session sqlx.Session, data *DevicePointMapping) (sql.Result, error)
		UpdateWithVersion(ctx context.Context, session sqlx.Session, data *DevicePointMapping) error
		Trans(ctx context.Context, fn func(ctx context.Context, session sqlx.Session) error) error
		ExecCtx(ctx context.Context, session sqlx.Session, query string, args ...any) (sql.Result, error)
		SelectWithBuilder(ctx context.Context, builder squirrel.SelectBuilder) ([]*DevicePointMapping, error)
		SelectOneWithBuilder(ctx context.Context, builder squirrel.SelectBuilder) (*DevicePointMapping, error)
		InsertWithBuilder(ctx context.Context, session sqlx.Session, builder squirrel.InsertBuilder) (sql.Result, error)
		UpdateWithBuilder(ctx context.Context, session sqlx.Session, builder squirrel.UpdateBuilder) (sql.Result, error)
		DeleteWithBuilder(ctx context.Context, session sqlx.Session, builder squirrel.DeleteBuilder) (sql.Result, error)
		SelectBuilder() squirrel.SelectBuilder
		InsertBuilder() squirrel.InsertBuilder
		UpdateBuilder() squirrel.UpdateBuilder
		DeleteBuilder() squirrel.DeleteBuilder
		DeleteSoft(ctx context.Context, session sqlx.Session, id int64) error
		FindSum(ctx context.Context, sumBuilder squirrel.SelectBuilder, field string) (float64, error)
		FindCount(ctx context.Context, countBuilder squirrel.SelectBuilder, field string) (int64, error)
		FindAll(ctx context.Context, rowBuilder squirrel.SelectBuilder, orderBy ...string) ([]*DevicePointMapping, error)
		FindPageListByPage(ctx context.Context, rowBuilder squirrel.SelectBuilder, page, pageSize int64, orderBy ...string) ([]*DevicePointMapping, error)
		FindPageListByPageWithTotal(ctx context.Context, rowBuilder squirrel.SelectBuilder, page, pageSize int64, orderBy ...string) ([]*DevicePointMapping, int64, error)
		FindPageListByIdDESC(ctx context.Context, rowBuilder squirrel.SelectBuilder, preMinId, pageSize int64) ([]*DevicePointMapping, error)
		FindPageListByIdASC(ctx context.Context, rowBuilder squirrel.SelectBuilder, preMaxId, pageSize int64) ([]*DevicePointMapping, error)
		Delete(ctx context.Context, session sqlx.Session, id int64) error
	}

	defaultDevicePointMappingModel struct {
		conn  sqlx.SqlConn
		table string
	}

	DevicePointMapping struct {
		Id              int64        `db:"id"`                // 自增主键ID
		CreateTime      time.Time    `db:"create_time"`       // 创建时间
		UpdateTime      time.Time    `db:"update_time"`       // 更新时间
		DeleteTime      sql.NullTime `db:"delete_time"`       // 删除时间（软删除标记）
		DelState        int64        `db:"del_state"`         // 删除状态：0-未删除，1-已删除
		Version         int64        `db:"version"`           // 版本号（乐观锁）
		TagStation      string       `db:"tag_station"`       // 与 TDengine tag_station 对应
		Coa             int64        `db:"coa"`               // 与 TDengine coa 对应
		Ioa             int64        `db:"ioa"`               // 与 TDengine ioa 对应
		DeviceId        string       `db:"device_id"`         // 设备编号/ID
		DeviceName      string       `db:"device_name"`       // 设备名称
		TdTableType     string       `db:"td_table_type"`     // TDengine 表类型（遥信表/遥测表等，逗号分隔）
		EnablePush      int64        `db:"enable_push"`       // 是否允许caller服务推送数据：0-不允许，1-允许
		EnableRawInsert int64        `db:"enable_raw_insert"` // 是否允许插入 raw 原生数据：0-否，1-是
		Description     string       `db:"description"`       // 备注信息
		Ext1            string       `db:"ext_1"`             // 扩展字段1，如：alarm, normal, control等，用于主题拆分
		Ext2            string       `db:"ext_2"`             // 扩展字段2
		Ext3            string       `db:"ext_3"`             // 扩展字段3
		Ext4            string       `db:"ext_4"`             // 扩展字段4
		Ext5            string       `db:"ext_5"`             // 扩展字段5
	}
)

func newDevicePointMappingModel(conn sqlx.SqlConn) *defaultDevicePointMappingModel {
	return &defaultDevicePointMappingModel{
		conn:  conn,
		table: "`device_point_mapping`",
	}
}

func (m *defaultDevicePointMappingModel) Delete(ctx context.Context, session sqlx.Session, id int64) error {
	query := fmt.Sprintf("delete from %s where `id` = ?", m.table)
	if session != nil {
		_, err := session.ExecCtx(ctx, query, id)
		return err
	}
	_, err := m.conn.ExecCtx(ctx, query, id)
	return err
}
func (m *defaultDevicePointMappingModel) FindOne(ctx context.Context, id int64) (*DevicePointMapping, error) {
	query := fmt.Sprintf("select %s from %s where `id` = ? and del_state = ? limit 1", devicePointMappingRows, m.table)
	var resp DevicePointMapping
	err := m.conn.QueryRowCtx(ctx, &resp, query, id, 0)
	switch err {
	case nil:
		return &resp, nil
	case sqlx.ErrNotFound:
		return nil, ErrNotFound
	default:
		return nil, err
	}
}

func (m *defaultDevicePointMappingModel) FindOneByTagStationCoaIoa(ctx context.Context, tagStation string, coa int64, ioa int64) (*DevicePointMapping, error) {
	var resp DevicePointMapping
	query := fmt.Sprintf("select %s from %s where `tag_station` = ? and `coa` = ? and `ioa` = ?  and del_state = ? limit 1", devicePointMappingRows, m.table)
	err := m.conn.QueryRowCtx(ctx, &resp, query, tagStation, coa, ioa, 0)
	switch err {
	case nil:
		return &resp, nil
	case sqlx.ErrNotFound:
		return nil, ErrNotFound
	default:
		return nil, err
	}
}

func (m *defaultDevicePointMappingModel) Insert(ctx context.Context, session sqlx.Session, data *DevicePointMapping) (sql.Result, error) {
	data.DeleteTime = sql.NullTime{
		Valid: false,
	}
	data.DelState = 0

	query := fmt.Sprintf("insert into %s (%s) values (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)", m.table, devicePointMappingRowsExpectAutoSet)
	if session != nil {
		return session.ExecCtx(ctx, query, data.DeleteTime, data.DelState, data.Version, data.TagStation, data.Coa, data.Ioa, data.DeviceId, data.DeviceName, data.TdTableType, data.EnablePush, data.EnableRawInsert, data.Description, data.Ext1, data.Ext2, data.Ext3, data.Ext4, data.Ext5)
	}
	return m.conn.ExecCtx(ctx, query, data.DeleteTime, data.DelState, data.Version, data.TagStation, data.Coa, data.Ioa, data.DeviceId, data.DeviceName, data.TdTableType, data.EnablePush, data.EnableRawInsert, data.Description, data.Ext1, data.Ext2, data.Ext3, data.Ext4, data.Ext5)
}

func (m *defaultDevicePointMappingModel) Update(ctx context.Context, session sqlx.Session, newData *DevicePointMapping) (sql.Result, error) {
	newData.DeleteTime = sql.NullTime{
		Valid: false,
	}
	newData.DelState = 0
	query := fmt.Sprintf("update %s set %s where `id` = ?", m.table, devicePointMappingRowsWithPlaceHolder)
	if session != nil {
		return session.ExecCtx(ctx, query, newData.DeleteTime, newData.DelState, newData.Version, newData.TagStation, newData.Coa, newData.Ioa, newData.DeviceId, newData.DeviceName, newData.TdTableType, newData.EnablePush, newData.EnableRawInsert, newData.Description, newData.Ext1, newData.Ext2, newData.Ext3, newData.Ext4, newData.Ext5, newData.Id)
	}
	return m.conn.ExecCtx(ctx, query, newData.DeleteTime, newData.DelState, newData.Version, newData.TagStation, newData.Coa, newData.Ioa, newData.DeviceId, newData.DeviceName, newData.TdTableType, newData.EnablePush, newData.EnableRawInsert, newData.Description, newData.Ext1, newData.Ext2, newData.Ext3, newData.Ext4, newData.Ext5, newData.Id)
}

func (m *defaultDevicePointMappingModel) UpdateWithVersion(ctx context.Context, session sqlx.Session, newData *DevicePointMapping) error {

	oldVersion := newData.Version
	newData.Version += 1

	var sqlResult sql.Result
	var err error

	query := fmt.Sprintf("update %s set %s where `id` = ? and version = ? ", m.table, devicePointMappingRowsWithPlaceHolder)
	if session != nil {
		sqlResult, err = session.ExecCtx(ctx, query, newData.DeleteTime, newData.DelState, newData.Version, newData.TagStation, newData.Coa, newData.Ioa, newData.DeviceId, newData.DeviceName, newData.TdTableType, newData.EnablePush, newData.EnableRawInsert, newData.Description, newData.Ext1, newData.Ext2, newData.Ext3, newData.Ext4, newData.Ext5, newData.Id, oldVersion)
	} else {
		sqlResult, err = m.conn.ExecCtx(ctx, query, newData.DeleteTime, newData.DelState, newData.Version, newData.TagStation, newData.Coa, newData.Ioa, newData.DeviceId, newData.DeviceName, newData.TdTableType, newData.EnablePush, newData.EnableRawInsert, newData.Description, newData.Ext1, newData.Ext2, newData.Ext3, newData.Ext4, newData.Ext5, newData.Id, oldVersion)
	}

	if err != nil {
		return err
	}
	updateCount, err := sqlResult.RowsAffected()
	if err != nil {
		return err
	}
	if updateCount == 0 {
		return ErrNoRowsUpdate
	}

	return nil
}

func (m *defaultDevicePointMappingModel) DeleteSoft(ctx context.Context, session sqlx.Session, id int64) error {
	data, err := m.FindOne(ctx, id)
	if err != nil {
		return err
	}
	data.DelState = 1
	data.DeleteTime = sql.NullTime{
		Time:  time.Now(),
		Valid: true,
	}
	if err := m.UpdateWithVersion(ctx, session, data); err != nil {
		return errors.Wrapf(errors.New("delete soft failed "), "DevicePointMappingModel delete err : %+v", err)
	}
	return nil
}

func (m *defaultDevicePointMappingModel) FindSum(ctx context.Context, builder squirrel.SelectBuilder, field string) (float64, error) {

	if len(field) == 0 {
		return 0, errors.Wrapf(errors.New("FindSum Least One Field"), "FindSum Least One Field")
	}

	builder = builder.Columns("IFNULL(SUM(" + field + "),0)")

	query, values, err := builder.Where("del_state = ?", 0).ToSql()
	if err != nil {
		return 0, err
	}

	var resp float64

	err = m.conn.QueryRowCtx(ctx, &resp, query, values...)

	switch err {
	case nil:
		return resp, nil
	default:
		return 0, err
	}
}

func (m *defaultDevicePointMappingModel) FindCount(ctx context.Context, builder squirrel.SelectBuilder, field string) (int64, error) {

	if len(field) == 0 {
		return 0, errors.Wrapf(errors.New("FindCount Least One Field"), "FindCount Least One Field")
	}

	builder = builder.Columns("COUNT(" + field + ")")

	query, values, err := builder.Where("del_state = ?", 0).ToSql()
	if err != nil {
		return 0, err
	}

	var resp int64

	err = m.conn.QueryRowCtx(ctx, &resp, query, values...)

	switch err {
	case nil:
		return resp, nil
	default:
		return 0, err
	}
}

func (m *defaultDevicePointMappingModel) FindAll(ctx context.Context, builder squirrel.SelectBuilder, orderBy ...string) ([]*DevicePointMapping, error) {

	builder = builder.Columns(devicePointMappingRows)

	if len(orderBy) == 0 {
		builder = builder.OrderBy("id DESC")
	} else {
		builder = builder.OrderBy(orderBy...)
	}

	query, values, err := builder.Where("del_state = ?", 0).ToSql()
	if err != nil {
		return nil, err
	}

	var resp []*DevicePointMapping

	err = m.conn.QueryRowsCtx(ctx, &resp, query, values...)

	switch err {
	case nil:
		return resp, nil
	default:
		return nil, err
	}
}

func (m *defaultDevicePointMappingModel) FindPageListByPage(ctx context.Context, builder squirrel.SelectBuilder, page, pageSize int64, orderBy ...string) ([]*DevicePointMapping, error) {

	builder = builder.Columns(devicePointMappingRows)

	if len(orderBy) == 0 {
		builder = builder.OrderBy("id DESC")
	} else {
		builder = builder.OrderBy(orderBy...)
	}

	if page < 1 {
		page = 1
	}
	offset := (page - 1) * pageSize

	query, values, err := builder.Where("del_state = ?", 0).Offset(uint64(offset)).Limit(uint64(pageSize)).ToSql()
	if err != nil {
		return nil, err
	}

	var resp []*DevicePointMapping

	err = m.conn.QueryRowsCtx(ctx, &resp, query, values...)

	switch err {
	case nil:
		return resp, nil
	default:
		return nil, err
	}
}

func (m *defaultDevicePointMappingModel) FindPageListByPageWithTotal(ctx context.Context, builder squirrel.SelectBuilder, page, pageSize int64, orderBy ...string) ([]*DevicePointMapping, int64, error) {

	total, err := m.FindCount(ctx, builder, "id")
	if err != nil {
		return nil, 0, err
	}

	builder = builder.Columns(devicePointMappingRows)

	if len(orderBy) == 0 {
		builder = builder.OrderBy("id DESC")
	} else {
		builder = builder.OrderBy(orderBy...)
	}

	if page < 1 {
		page = 1
	}
	offset := (page - 1) * pageSize

	query, values, err := builder.Where("del_state = ?", 0).Offset(uint64(offset)).Limit(uint64(pageSize)).ToSql()
	if err != nil {
		return nil, total, err
	}

	var resp []*DevicePointMapping

	err = m.conn.QueryRowsCtx(ctx, &resp, query, values...)

	switch err {
	case nil:
		return resp, total, nil
	default:
		return nil, total, err
	}
}

func (m *defaultDevicePointMappingModel) FindPageListByIdDESC(ctx context.Context, builder squirrel.SelectBuilder, preMinId, pageSize int64) ([]*DevicePointMapping, error) {

	builder = builder.Columns(devicePointMappingRows)

	if preMinId > 0 {
		builder = builder.Where(" id < ? ", preMinId)
	}

	query, values, err := builder.Where("del_state = ?", 0).OrderBy("id DESC").Limit(uint64(pageSize)).ToSql()
	if err != nil {
		return nil, err
	}

	var resp []*DevicePointMapping

	err = m.conn.QueryRowsCtx(ctx, &resp, query, values...)

	switch err {
	case nil:
		return resp, nil
	default:
		return nil, err
	}
}

func (m *defaultDevicePointMappingModel) FindPageListByIdASC(ctx context.Context, builder squirrel.SelectBuilder, preMaxId, pageSize int64) ([]*DevicePointMapping, error) {

	builder = builder.Columns(devicePointMappingRows)

	if preMaxId > 0 {
		builder = builder.Where(" id > ? ", preMaxId)
	}

	query, values, err := builder.Where("del_state = ?", 0).OrderBy("id ASC").Limit(uint64(pageSize)).ToSql()
	if err != nil {
		return nil, err
	}

	var resp []*DevicePointMapping

	err = m.conn.QueryRowsCtx(ctx, &resp, query, values...)

	switch err {
	case nil:
		return resp, nil
	default:
		return nil, err
	}
}

func (m *defaultDevicePointMappingModel) Trans(ctx context.Context, fn func(ctx context.Context, session sqlx.Session) error) error {

	return m.conn.TransactCtx(ctx, func(ctx context.Context, session sqlx.Session) error {
		return fn(ctx, session)
	})

}

func (m *defaultDevicePointMappingModel) ExecCtx(ctx context.Context, session sqlx.Session, query string, args ...any) (sql.Result, error) {
	if session != nil {
		return session.ExecCtx(ctx, query, args...)
	}
	return m.conn.ExecCtx(ctx, query, args...)
}

func (m *defaultDevicePointMappingModel) SelectWithBuilder(ctx context.Context, builder squirrel.SelectBuilder) ([]*DevicePointMapping, error) {
	query, args, err := builder.ToSql()
	if err != nil {
		return nil, err
	}

	var resp []*DevicePointMapping

	err = m.conn.QueryRowsPartialCtx(ctx, &resp, query, args...)
	switch err {
	case nil:
		return resp, nil
	default:
		return nil, err
	}
}

func (m *defaultDevicePointMappingModel) SelectOneWithBuilder(ctx context.Context, builder squirrel.SelectBuilder) (*DevicePointMapping, error) {
	query, args, err := builder.ToSql()
	if err != nil {
		return nil, err
	}

	var resp DevicePointMapping
	err = m.conn.QueryRowPartialCtx(ctx, &resp, query, args...)
	switch err {
	case nil:
		return &resp, nil
	case sqlx.ErrNotFound:
		return nil, ErrNotFound
	default:
		return nil, err
	}
}

func (m *defaultDevicePointMappingModel) InsertWithBuilder(ctx context.Context, session sqlx.Session, builder squirrel.InsertBuilder) (sql.Result, error) {
	query, args, err := builder.ToSql()
	if err != nil {
		return nil, err
	}

	return m.ExecCtx(ctx, session, query, args...)
}

func (m *defaultDevicePointMappingModel) UpdateWithBuilder(ctx context.Context, session sqlx.Session, builder squirrel.UpdateBuilder) (sql.Result, error) {
	query, args, err := builder.ToSql()
	if err != nil {
		return nil, err
	}

	return m.ExecCtx(ctx, session, query, args...)
}

func (m *defaultDevicePointMappingModel) DeleteWithBuilder(ctx context.Context, session sqlx.Session, builder squirrel.DeleteBuilder) (sql.Result, error) {
	query, args, err := builder.ToSql()
	if err != nil {
		return nil, err
	}

	return m.ExecCtx(ctx, session, query, args...)
}

func (m *defaultDevicePointMappingModel) SelectBuilder() squirrel.SelectBuilder {
	return squirrel.Select().From(m.table)
}

func (m *defaultDevicePointMappingModel) UpdateBuilder() squirrel.UpdateBuilder {
	return squirrel.Update(m.table)
}

func (m *defaultDevicePointMappingModel) DeleteBuilder() squirrel.DeleteBuilder {
	return squirrel.Delete(m.table)
}

func (m *defaultDevicePointMappingModel) InsertBuilder() squirrel.InsertBuilder {
	return squirrel.Insert(m.table)
}

func (m *defaultDevicePointMappingModel) tableName() string {
	return m.table
}
