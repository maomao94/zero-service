<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Go-Zero Stats 日志分析工具</title>
    <!-- 引入外部资源 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>

    <!-- 配置Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#36CFC9',
                        success: '#52C41A',
                        warning: '#FAAD14',
                        danger: '#FF4D4F',
                        dark: '#1D2129',
                        'dark-2': '#4E5969',
                        'light-1': '#F2F3F5',
                        'light-2': '#E5E6EB'
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    boxShadow: {
                        'card': '0 4px 20px rgba(0, 0, 0, 0.08)',
                        'card-hover': '0 8px 30px rgba(0, 0, 0, 0.12)',
                    }
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-transition {
                transition: all 0.3s ease;
            }
            .gradient-bg {
                background: linear-gradient(135deg, #165DFF 0%, #0A4BDB 100%);
            }
            .chart-container {
                min-height: 350px;
                width: 100%;
            }
            .hide-scrollbar::-webkit-scrollbar {
                display: none;
            }
            .hide-scrollbar {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .data-table th {
                font-weight: 500;
            }
            .data-table tr {
                transition: all 0.3s ease;
            }
            .data-table tr:hover {
                background-color: rgba(22, 93, 255, 0.06);
                transform: translateY(-1px);
            }
            .table-row-animation {
                animation: fadeIn 0.5s ease;
            }
            @keyframes fadeIn {
                from {
                    opacity: 0;
                    transform: translateY(10px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            .table-loading {
                position: relative;
                overflow: hidden;
            }
            .table-loading::after {
                content: '';
                position: absolute;
                top: 0;
                left: -100%;
                width: 50%;
                height: 100%;
                background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
                animation: shimmer 1.5s infinite;
            }
            @keyframes shimmer {
                0% { left: -100%; }
                100% { left: 150%; }
            }
            .card-shadow-hover {
                transition: box-shadow 0.3s ease;
            }
            .card-shadow-hover:hover {
                box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
            }
            .pulse-animation {
                animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
            }
            @keyframes pulse {
                0%, 100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.8;
                }
            }
            .upload-animation {
                transition: all 0.3s ease;
            }
            .upload-animation.active {
                transform: scale(1.02);
                box-shadow: 0 10px 30px rgba(22, 93, 255, 0.15);
            }
            .custom-scrollbar::-webkit-scrollbar {
                width: 6px;
                height: 6px;
            }
            .custom-scrollbar::-webkit-scrollbar-track {
                background: #f1f1f1;
                border-radius: 10px;
            }
            .custom-scrollbar::-webkit-scrollbar-thumb {
                background: #c1c1c1;
                border-radius: 10px;
            }
            .custom-scrollbar::-webkit-scrollbar-thumb:hover {
                background: #a1a1a1;
            }
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-dark min-h-screen">
<!-- 顶部导航 -->
<header class="bg-white shadow-sm sticky top-0 z-50">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between items-center h-16">
            <div class="flex items-center">
                <div class="flex-shrink-0 flex items-center">
                    <i class="fa fa-line-chart text-primary text-2xl mr-2"></i>
                    <span class="text-xl font-semibold">Go-Zero Stats 分析</span>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <button class="text-dark-2 hover:text-primary transition-colors" id="helpBtn">
                    <i class="fa fa-question-circle"></i>
                    <span class="ml-1 hidden sm:inline">使用帮助</span>
                </button>
            </div>
        </div>
    </div>
</header>

<!-- 帮助提示框 -->
<div id="helpModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center">
    <div class="bg-white rounded-xl p-6 w-full max-w-lg">
        <div class="flex justify-between items-center mb-4">
            <h3 class="font-medium text-lg">使用帮助</h3>
            <button id="closeHelpModal" class="text-dark-2 hover:text-primary transition-colors">
                <i class="fa fa-times"></i>
            </button>
        </div>
        <div class="space-y-4 text-sm">
            <div>
                <h4 class="font-medium mb-1">支持的日志类型：</h4>
                <ul class="list-disc pl-5 text-dark-2 space-y-1">
                    <li>内存使用统计 (CPU: xxm, MEMORY: Alloc=xxMi)</li>
                    <li>限流状态统计 (shedding_stat [1m], cpu: xx, total: xx, pass: xx, drop: xx)</li>
                    <li>性能指标统计 (qps: xx.x/s, drops: xx, avg time: xx.xms)</li>
                </ul>
            </div>
            <div>
                <h4 class="font-medium mb-1">图表操作：</h4>
                <ul class="list-disc pl-5 text-dark-2 space-y-1">
                    <li><i class="fa fa-search-plus text-primary"></i> 鼠标滚轮：缩放图表</li>
                    <li><i class="fa fa-arrows text-primary"></i> 按住鼠标拖动：选择区域</li>
                    <li><i class="fa fa-refresh text-primary"></i> 双击图表：重置视图</li>
                    <li><i class="fa fa-expand text-primary"></i> 点击全屏按钮：查看大图</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- 主内容区 -->
<main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- 页面标题和描述 -->
    <div class="mb-8 text-center">
        <h1 class="text-[clamp(1.75rem,3vw,2.5rem)] font-bold text-dark mb-2">Go-Zero Stats 日志分析工具</h1>
        <p class="text-dark-2 max-w-2xl mx-auto">
            专业解析Go-Zero微服务stat日志，可视化展示内存使用、CPU占用、QPS和限流状态
        </p>
    </div>

    <!-- 文件上传区域 -->
    <div class="mb-10" id="uploadSection">
        <div id="uploadCard" class="bg-white rounded-xl shadow-card p-6 sm:p-8 card-transition hover:shadow-card-hover upload-animation">
            <div class="flex flex-col items-center justify-center">
                <div id="dropArea" class="border-2 border-dashed border-light-2 rounded-lg w-full py-12 px-4 text-center mb-6 cursor-pointer hover:border-primary transition-colors hover:bg-primary/5">
                    <input type="file" id="fileInput" accept=".txt,.log" class="hidden" />
                    <i class="fa fa-cloud-upload text-4xl text-primary mb-4 pulse-animation"></i>
                    <h3 class="text-lg font-medium mb-2">拖放Go-Zero stat日志文件到此处，或点击选择文件</h3>
                    <p class="text-dark-2 text-sm">支持 .txt 和 .log 格式，自动处理1天级日志数据</p>
                </div>

                <div id="fileInfo" class="hidden w-full mb-6 p-4 bg-light-1 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fa fa-file-text-o text-primary mr-3"></i>
                            <div>
                                <p id="fileName" class="font-medium truncate max-w-md"></p>
                                <p id="fileSize" class="text-sm text-dark-2"></p>
                            </div>
                        </div>
                        <button id="removeFile" class="text-dark-2 hover:text-danger transition-colors">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                </div>

                <button id="parseBtn" class="gradient-bg text-white px-6 py-3 rounded-lg font-medium flex items-center opacity-70 cursor-not-allowed transition-all hover:opacity-100 hover:shadow-lg active:scale-98">
                    <i class="fa fa-play-circle mr-2"></i>
                    开始分析
                </button>
            </div>
        </div>
    </div>

    <!-- 状态提示 -->
    <div id="statusMessage" class="mb-8 hidden">
        <div class="p-4 rounded-lg flex items-center">
            <i id="statusIcon" class="mr-3 text-xl"></i>
            <span id="statusText"></span>
        </div>
    </div>

    <!-- 分析结果区域（默认隐藏） -->
    <div id="resultsArea" class="hidden">
        <!-- 数据概览 -->
        <div class="bg-white rounded-xl shadow-card p-6 mb-8">
            <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                <h2 class="text-xl font-semibold">数据概览</h2>
                <div class="text-sm text-dark-2">
                    <span id="timeRange">-- 至 --</span>
                </div>
            </div>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                <div class="p-4 rounded-lg bg-light-1">
                    <p class="text-dark-2 text-xs mb-1">总日志条目</p>
                    <p id="totalEntries" class="text-2xl font-bold">0</p>
                </div>
                <div class="p-4 rounded-lg bg-light-1">
                    <p class="text-dark-2 text-xs mb-1">服务数量</p>
                    <p id="serviceCount" class="text-2xl font-bold">0</p>
                </div>
                <div class="p-4 rounded-lg bg-light-1">
                    <p class="text-dark-2 text-xs mb-1">平均内存</p>
                    <p id="avgMemory" class="text-2xl font-bold">0.00 MiB</p>
                </div>
                <div class="p-4 rounded-lg bg-light-1">
                    <p class="text-dark-2 text-xs mb-1">总丢弃请求</p>
                    <p id="totalDrops" class="text-2xl font-bold">0</p>
                </div>
            </div>
        </div>

        <!-- 关键指标图表 -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- 内存趋势图 -->
            <div class="bg-white rounded-xl shadow-card p-6 card-shadow-hover">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold">内存使用趋势 (MiB)</h3>
                    <div class="flex space-x-2">
                        <button class="chart-action-btn p-1.5 rounded hover:bg-light-1 text-dark-2 transition-colors" data-chart="memoryTrend">
                            <i class="fa fa-refresh"></i>
                        </button>
                        <button class="chart-action-btn p-1.5 rounded hover:bg-light-1 text-dark-2 transition-colors" data-chart="memoryTrend">
                            <i class="fa fa-expand"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-container" id="memoryTrendChart"></div>
            </div>

            <!-- QPS和丢弃数趋势 -->
            <div class="bg-white rounded-xl shadow-card p-6 card-shadow-hover">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold">QPS和丢弃数趋势</h3>
                    <div class="flex space-x-2">
                        <button class="chart-action-btn p-1.5 rounded hover:bg-light-1 text-dark-2 transition-colors" data-chart="qpsTrend">
                            <i class="fa fa-refresh"></i>
                        </button>
                        <button class="chart-action-btn p-1.5 rounded hover:bg-light-1 text-dark-2 transition-colors" data-chart="qpsTrend">
                            <i class="fa fa-expand"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-container" id="qpsTrendChart"></div>
            </div>
        </div>

        <!-- 服务性能和限流状态 -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <!-- 服务分布 -->
            <div class="bg-white rounded-xl shadow-card p-6 card-shadow-hover">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold">服务分布</h3>
                    <div class="flex space-x-2">
                        <button class="chart-action-btn p-1.5 rounded hover:bg-light-1 text-dark-2 transition-colors" data-chart="serviceDistribution">
                            <i class="fa fa-refresh"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-container" id="serviceDistributionChart"></div>
            </div>

            <!-- CPU占用趋势 -->
            <div class="bg-white rounded-xl shadow-card p-6 card-shadow-hover lg:col-span-2">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-semibold">系统指标综合图</h3>
                    <div class="flex space-x-2">
                        <button class="chart-action-btn p-1.5 rounded hover:bg-light-1 text-dark-2 transition-colors" data-chart="cpuTrend">
                            <i class="fa fa-refresh"></i>
                        </button>
                        <button class="chart-action-btn p-1.5 rounded hover:bg-light-1 text-dark-2 transition-colors" data-chart="cpuTrend">
                            <i class="fa fa-expand"></i>
                        </button>
                    </div>
                </div>
                <div class="chart-container" id="cpuTrendChart"></div>
            </div>
        </div>

        <!-- 限流状态分析 -->
        <div class="bg-white rounded-xl shadow-card p-6 mb-8 card-shadow-hover">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-semibold">限流状态分析</h3>
                <div class="flex space-x-2">
                    <button class="chart-action-btn p-1.5 rounded hover:bg-light-1 text-dark-2 transition-colors" data-chart="sheddingStats">
                        <i class="fa fa-refresh"></i>
                    </button>
                    <button class="chart-action-btn p-1.5 rounded hover:bg-light-1 text-dark-2 transition-colors" data-chart="sheddingStats">
                        <i class="fa fa-expand"></i>
                    </button>
                </div>
            </div>
            <div class="chart-container" id="sheddingStatsChart"></div>
        </div>

        <!-- 限流趋势图 -->
        <div class="bg-white rounded-xl shadow-card p-6 mb-8 card-shadow-hover">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-semibold">限流趋势图</h3>
                <div class="flex space-x-2">
                    <button class="chart-action-btn p-1.5 rounded hover:bg-light-1 text-dark-2 transition-colors" data-chart="sheddingTrend">
                        <i class="fa fa-refresh"></i>
                    </button>
                    <button class="chart-action-btn p-1.5 rounded hover:bg-light-1 text-dark-2 transition-colors" data-chart="sheddingTrend">
                        <i class="fa fa-expand"></i>
                    </button>
                </div>
            </div>
            <div class="chart-container" id="sheddingTrendChart"></div>
        </div>

        <!-- 服务性能详情 -->
        <div class="mb-8">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-semibold">服务性能详情</h3>
                <div>
                    <select id="serviceFilter" class="border border-light-2 rounded px-3 py-1.5 text-sm focus:outline-none focus:ring-1 focus:ring-primary">
                        <option value="all">所有服务</option>
                        <!-- 服务选项将动态生成 -->
                    </select>
                </div>
            </div>

            <!-- 表格容器 -->
            <div id="tableContainer" class="bg-white rounded-xl shadow-card overflow-hidden">
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="w-full text-sm data-table">
                        <thead>
                        <tr class="bg-light-1">
                            <th class="px-6 py-3 text-left font-medium text-dark-2 cursor-pointer hover:bg-light-2 transition-colors" data-field="time">
                                日志时间
                                <span class="ml-1 text-primary">
                                    <i class="fa fa-sort-down"></i>
                                </span>
                            </th>
                            <th class="px-6 py-3 text-left font-medium text-dark-2 cursor-pointer hover:bg-light-2 transition-colors" data-field="service">
                                服务名
                                <span class="ml-1">
                                    <i class="fa fa-sort"></i>
                                </span>
                            </th>
                            <th class="px-6 py-3 text-left font-medium text-dark-2 cursor-pointer hover:bg-light-2 transition-colors" data-field="cpu">
                                CPU占用(m)
                                <span class="ml-1">
                                    <i class="fa fa-sort"></i>
                                </span>
                            </th>
                            <th class="px-6 py-3 text-left font-medium text-dark-2 cursor-pointer hover:bg-light-2 transition-colors" data-field="alloc">
                                实时内存(MiB)
                                <span class="ml-1">
                                    <i class="fa fa-sort"></i>
                                </span>
                            </th>
                            <th class="px-6 py-3 text-left font-medium text-dark-2 cursor-pointer hover:bg-light-2 transition-colors" data-field="sys">
                                系统内存(MiB)
                                <span class="ml-1">
                                    <i class="fa fa-sort"></i>
                                </span>
                            </th>
                            <th class="px-6 py-3 text-left font-medium text-dark-2 cursor-pointer hover:bg-light-2 transition-colors" data-field="numGC">
                                GC次数
                                <span class="ml-1">
                                    <i class="fa fa-sort"></i>
                                </span>
                            </th>
                            <th class="px-6 py-3 text-left font-medium text-dark-2 cursor-pointer hover:bg-light-2 transition-colors" data-field="qps">
                                QPS
                                <span class="ml-1">
                                    <i class="fa fa-sort"></i>
                                </span>
                            </th>
                            <th class="px-6 py-3 text-left font-medium text-dark-2 cursor-pointer hover:bg-light-2 transition-colors" data-field="drops">
                                丢弃数
                                <span class="ml-1">
                                    <i class="fa fa-sort"></i>
                                </span>
                            </th>
                            <th class="px-6 py-3 text-left font-medium text-dark-2 cursor-pointer hover:bg-light-2 transition-colors" data-field="shedding">
                                限流状态
                                <span class="ml-1">
                                    <i class="fa fa-sort"></i>
                                </span>
                            </th>
                        </tr>
                        </thead>
                        <tbody id="logTableBody">
                        <!-- 表格内容将动态生成 -->
                        </tbody>
                    </table>
                </div>

                <!-- 分页控件 -->
                <div class="px-6 py-4 border-t border-light-2 flex justify-between items-center">
                    <div class="text-dark-2 text-sm">
                        显示 <span id="currentRange">0-0</span> 条，共 <span id="totalCount">0</span> 条
                    </div>
                    <div class="flex items-center space-x-2">
                        <select id="pageSize" class="border border-light-2 rounded px-2 py-1 text-sm focus:outline-none focus:ring-1 focus:ring-primary">
                            <option value="20">20条/页</option>
                            <option value="50">50条/页</option>
                            <option value="100">100条/页</option>
                        </select>
                        <div class="flex space-x-2">
                            <button id="prevPage" class="px-3 py-1 border border-light-2 rounded hover:bg-light-1 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <i class="fa fa-chevron-left"></i>
                            </button>
                            <span id="pageInfo" class="px-2 py-1 text-sm">第 1 页</span>
                            <button id="nextPage" class="px-3 py-1 border border-light-2 rounded hover:bg-light-1 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <i class="fa fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 空状态/初始状态 -->
    <div id="emptyState" class="flex flex-col items-center justify-center py-16 text-center">
        <div class="w-24 h-24 rounded-full bg-primary/10 flex items-center justify-center mb-6 pulse-animation">
            <i class="fa fa-line-chart text-4xl text-primary"></i>
        </div>
        <h3 class="text-xl font-semibold mb-2">准备好分析您的Go-Zero Stats日志了吗？</h3>
        <p class="text-dark-2 max-w-md mb-8">专业解析Go-Zero微服务stat日志，可视化展示内存使用、CPU占用、QPS和限流状态</p>
        <div class="flex flex-wrap justify-center gap-4">
            <div class="flex items-center bg-white px-4 py-3 rounded-lg shadow-sm transition-all hover:shadow-md hover:bg-primary/5 hover:-translate-y-1">
                <i class="fa fa-check-circle text-success mr-2"></i>
                <span>支持多种日志类型</span>
            </div>
            <div class="flex items-center bg-white px-4 py-3 rounded-lg shadow-sm transition-all hover:shadow-md hover:bg-primary/5 hover:-translate-y-1">
                <i class="fa fa-check-circle text-success mr-2"></i>
                <span>图表交互功能</span>
            </div>
            <div class="flex items-center bg-white px-4 py-3 rounded-lg shadow-sm transition-all hover:shadow-md hover:bg-primary/5 hover:-translate-y-1">
                <i class="fa fa-check-circle text-success mr-2"></i>
                <span>性能指标全面展示</span>
            </div>
        </div>
    </div>

    <!-- 加载状态 -->
    <div id="loadingState" class="hidden flex flex-col items-center justify-center py-16">
        <div class="w-16 h-16 border-4 border-light-2 border-t-primary rounded-full animate-spin mb-6"></div>
        <h3 class="text-lg font-medium mb-2">正在解析Go-Zero Stats日志数据...</h3>
        <p class="text-dark-2 mb-4" id="loadingProgress">准备解析文件</p>
        <div class="w-full max-w-md h-2 bg-light-2 rounded-full overflow-hidden">
            <div id="loadingBar" class="h-full bg-primary rounded-full w-0 transition-all duration-300"></div>
        </div>
    </div>

    <!-- 图表全屏查看模态框 -->
    <div id="chartModal" class="fixed inset-0 bg-black/70 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl w-full max-w-5xl max-h-[90vh] flex flex-col">
            <div class="p-4 border-b border-light-2 flex justify-between items-center">
                <h3 id="modalChartTitle" class="font-medium">图表详情</h3>
                <button id="closeChartModalHandler" class="text-dark-2 hover:text-primary transition-colors">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <div class="flex-grow p-2" id="modalChartContainer"></div>
        </div>
    </div>
</main>

<script>
    // DOM 元素
    const dropArea = document.getElementById('dropArea');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const removeFile = document.getElementById('removeFile');
    const parseBtn = document.getElementById('parseBtn');
    const statusMessage = document.getElementById('statusMessage');
    const statusIcon = document.getElementById('statusIcon');
    const statusText = document.getElementById('statusText');
    const resultsArea = document.getElementById('resultsArea');
    const emptyState = document.getElementById('emptyState');
    const loadingState = document.getElementById('loadingState');
    const loadingProgress = document.getElementById('loadingProgress');
    const loadingBar = document.getElementById('loadingBar');
    const logTableBody = document.getElementById('logTableBody');
    const prevPage = document.getElementById('prevPage');
    const nextPage = document.getElementById('nextPage');
    const currentRange = document.getElementById('currentRange');
    const totalCount = document.getElementById('totalCount');
    const pageInfo = document.getElementById('pageInfo');
    const pageSize = document.getElementById('pageSize');
    const serviceFilter = document.getElementById('serviceFilter');
    const helpBtn = document.getElementById('helpBtn');
    const helpModal = document.getElementById('helpModal');
    const closeHelpModal = document.getElementById('closeHelpModal');
    const chartModal = document.getElementById('chartModal');
    const closeChartModalHandler = document.getElementById('closeChartModalHandler');
    const modalChartContainer = document.getElementById('modalChartContainer');
    const tableContainer = document.getElementById('tableContainer');
    const modalChartTitle = document.getElementById('modalChartTitle');
    const timeRange = document.getElementById('timeRange');

    // 数据存储
    let logData = []; // 所有日志数据
    let services = []; // 识别到的服务列表
    let charts = {}; // 图表实例
    let currentPage = 1; // 当前页码
    let selectedFile = null; // 当前选择的文件

    // 初始化
    function init() {
        // 事件监听
        dropArea.addEventListener('click', () => fileInput.click());
        dropArea.addEventListener('dragover', handleDragOver);
        dropArea.addEventListener('dragleave', handleDragLeave);
        dropArea.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);
        removeFile.addEventListener('click', removeSelectedFile);
        parseBtn.addEventListener('click', parseLogFile);
        prevPage.addEventListener('click', goToPrevPage);
        nextPage.addEventListener('click', goToNextPage);
        pageSize.addEventListener('change', changePageSize);
        serviceFilter.addEventListener('change', filterTableData);
        helpBtn.addEventListener('click', () => helpModal.classList.remove('hidden'));
        closeHelpModal.addEventListener('click', () => helpModal.classList.add('hidden'));
        closeChartModalHandler.addEventListener('click', () => chartModal.classList.add('hidden'));
        window.addEventListener('resize', handleResize);
        document.querySelectorAll('.chart-action-btn').forEach(btn => {
            btn.addEventListener('click', handleChartAction);
        });
        
        // 添加表头点击排序事件
        document.querySelectorAll('th[data-field]').forEach(header => {
            header.addEventListener('click', handleHeaderClick);
        });
        
        // 初始化排序图标
        updateSortIcons();
    }

    // 文件拖放处理
    function handleDragOver(e) {
        e.preventDefault();
        dropArea.classList.add('border-primary', 'bg-primary/5');
        document.getElementById('uploadCard').classList.add('active');
    }

    function handleDragLeave() {
        dropArea.classList.remove('border-primary', 'bg-primary/5');
        document.getElementById('uploadCard').classList.remove('active');
    }

    function handleDrop(e) {
        e.preventDefault();
        handleDragLeave();
        if (e.dataTransfer.files.length) {
            handleFile(e.dataTransfer.files[0]);
        }
    }

    // 文件选择处理
    function handleFileSelect(e) {
        if (e.target.files.length) {
            handleFile(e.target.files[0]);
        }
    }

    // 处理选择的文件
    function handleFile(file) {
        selectedFile = file;
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        fileInfo.classList.remove('hidden');
        parseBtn.classList.remove('opacity-70', 'cursor-not-allowed');
        parseBtn.classList.add('opacity-100', 'cursor-pointer');
        hideStatus();
        
        // 添加选中文件的动画效果
        document.getElementById('uploadCard').classList.add('active');
        setTimeout(() => {
            document.getElementById('uploadCard').classList.remove('active');
        }, 300);
    }

    // 移除选择的文件
    function removeSelectedFile() {
        selectedFile = null;
        fileInput.value = '';
        fileInfo.classList.add('hidden');
        parseBtn.classList.add('opacity-70', 'cursor-not-allowed');
        parseBtn.classList.remove('opacity-100', 'cursor-pointer');
        hideStatus();
    }

    // 格式化文件大小
    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        else if (bytes < 1048576) return (bytes / 1024).toFixed(2) + ' KB';
        else return (bytes / 1048576).toFixed(2) + ' MB';
    }

    // 解析日志文件
    function parseLogFile() {
        if (!selectedFile) return;

        // 显示加载状态
        emptyState.classList.add('hidden');
        resultsArea.classList.add('hidden');
        loadingState.classList.remove('hidden');
        loadingProgress.textContent = '正在读取日志内容...';

        const reader = new FileReader();

        reader.onload = function(e) {
            try {
                loadingProgress.textContent = '正在解析日志数据...';
                loadingBar.style.width = '0%';
                const content = e.target.result;
                
                // 重置数据
                logData = [];
                services = [];
                
                // 解析日志内容
                parseLogContent(content);
                
                // 提取所有识别到的服务名
                const serviceSet = new Set(logData.map(item => item.service));
                services = Array.from(serviceSet).sort();
                
                // 更新服务过滤器
                updateServiceFilter();
                
                // 更新统计信息
                updateStats();
                
                // 渲染图表
                renderAllCharts();
                
                // 渲染表格
                currentPage = 1;
                renderTable();
                
                // 显示结果区域
                loadingState.classList.add('hidden');
                resultsArea.classList.remove('hidden');
                
                // 显示成功状态
                loadingBar.style.width = '100%';
                setTimeout(() => {
                    showStatus('success', `解析完成，共发现 ${logData.length} 条记录，识别到 ${services.length} 个服务`);
                }, 300);
            } catch (err) {
                loadingState.classList.add('hidden');
                emptyState.classList.remove('hidden');
                showStatus('error', `解析失败: ${err.message || '未知错误'}`);
                console.error('解析错误:', err);
            }
        };

        reader.onerror = function() {
            loadingState.classList.add('hidden');
            emptyState.classList.remove('hidden');
            showStatus('error', '读取文件时发生错误');
        };

        reader.readAsText(selectedFile, 'utf-8');
    }

    // 解析日志内容
    function parseLogContent(content) {
        const lines = content.split('\n').filter(line => line.trim() !== '');
        if (lines.length === 0) throw new Error('日志文件为空');

        const totalLines = lines.length;
        
        lines.forEach((line, index) => {
            // 更新加载进度
            if (index % 100 === 0) {
                const progress = Math.floor((index / totalLines) * 100);
                loadingProgress.textContent = `正在解析日志数据... ${progress}%`;
                loadingBar.style.width = `${progress}%`;
            }

            // 提取时间戳
            const timeMatch = line.match(/^(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}\+08:00)/);
            const time = timeMatch ? timeMatch[1] : '';
            
            if (!time) return; // 跳过无效行

            // 初始化日志条目
            const logEntry = {
                time,
                service: 'unknown',
                cpu: '0',
                alloc: '0.0',
                totalAlloc: '0.0',
                sys: '0.0',
                numGC: '0',
                qps: '0.0',
                drops: '0',
                shedding: '正常'
            };

            // 提取应用名
            const appMatch = line.match(/app=([\w.]+)/);
            if (appMatch) {
                logEntry.service = appMatch[1].toLowerCase();
            }

            // 提取CPU信息
            const cpuMatch = line.match(/CPU: (\d+)m/);
            if (cpuMatch) {
                logEntry.cpu = cpuMatch[1];
            }

            // 提取内存信息
            const allocMatch = line.match(/Alloc=(\d+\.\d+)Mi/);
            if (allocMatch) {
                logEntry.alloc = allocMatch[1];
            }

            const totalAllocMatch = line.match(/TotalAlloc=(\d+\.\d+)Mi/);
            if (totalAllocMatch) {
                logEntry.totalAlloc = totalAllocMatch[1];
            }

            const sysMatch = line.match(/Sys=(\d+\.\d+)Mi/);
            if (sysMatch) {
                logEntry.sys = sysMatch[1];
            }

            // 提取GC次数
            const numGCMatch = line.match(/NumGC=(\d+)/);
            if (numGCMatch) {
                logEntry.numGC = numGCMatch[1];
            }

            // 提取QPS信息
            const qpsMatch = line.match(/qps: (\d+\.\d+)\/s/);
            if (qpsMatch) {
                logEntry.qps = qpsMatch[1];
            }

            // 提取丢弃数
            const dropsMatch = line.match(/drops: (\d+)/);
            if (dropsMatch) {
                logEntry.drops = dropsMatch[1];
            }

            // 提取限流状态
            const sheddingMatch = line.match(/shedding_stat \[1m\], cpu: (\d+), total: (\d+), pass: (\d+), drop: (\d+)/);
            if (sheddingMatch) {
                const dropCount = parseInt(sheddingMatch[4]);
                logEntry.shedding = dropCount > 0 ? `丢弃: ${dropCount}` : '正常';
                logEntry.drops = sheddingMatch[4]; // 更新丢弃数
            }

            // 将日志条目添加到数据列表
            logData.push(logEntry);
        });

        // 按时间排序
        logData.sort((a, b) => new Date(a.time) - new Date(b.time));

        // 检查是否有有效数据
        if (logData.length === 0) throw new Error('未提取到有效日志数据，请检查日志格式');
    }

    // 更新服务过滤器
    function updateServiceFilter() {
        // 清空现有选项（保留"所有服务"选项）
        while (serviceFilter.options.length > 1) {
            serviceFilter.remove(1);
        }

        // 添加新的服务选项
        services.forEach(service => {
            const option = document.createElement('option');
            option.value = service;
            option.textContent = service;
            serviceFilter.appendChild(option);
        });
    }

    // 更新统计信息
    function updateStats() {
        const total = logData.length;
        const serviceCount = services.length;

        // 计算平均内存
        let totalMemory = 0;
        let memoryCount = 0;
        logData.forEach(item => {
            const memory = parseFloat(item.alloc);
            if (!isNaN(memory)) {
                totalMemory += memory;
                memoryCount++;
            }
        });
        const avgMemory = memoryCount > 0 ? (totalMemory / memoryCount).toFixed(2) : '0.00';

        // 计算总丢弃数
        let totalDrops = 0;
        logData.forEach(item => {
            totalDrops += parseInt(item.drops) || 0;
        });

        // 更新统计数字
        document.getElementById('totalEntries').textContent = total;
        document.getElementById('serviceCount').textContent = serviceCount;
        document.getElementById('avgMemory').textContent = `${avgMemory} MiB`;
        document.getElementById('totalDrops').textContent = totalDrops;

        // 更新时间范围
        if (logData.length > 0) {
            const startTime = formatDateTime(logData[0].time);
            const endTime = formatDateTime(logData[logData.length - 1].time);
            timeRange.textContent = `${startTime} 至 ${endTime}`;
        }

        // 更新表格总数
        totalCount.textContent = total;
    }

    // 格式化日期时间
    function formatDateTime(dateTimeStr) {
        const date = new Date(dateTimeStr);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}`;
    }

    // 格式化时间（图表显示用）
    function formatTime(dateTimeStr) {
        const date = new Date(dateTimeStr);
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${hours}:${minutes}`;
    }
    
    // 按分钟聚合数据 - 使用用户要求的逻辑：整分钟区间，无数据时用上一分钟数据
    function aggregateDataByMinute() {
        if (logData.length === 0) {
            return [];
        }
        
        // 初始化原始数据的分钟映射
        const originalMinuteData = {};
        // 按服务统计的映射
        const serviceStats = {};
        
        // 处理原始日志数据
        logData.forEach(item => {
            // 创建分钟级时间戳作为键
            const date = new Date(item.time);
            date.setSeconds(0);
            date.setMilliseconds(0);
            const minuteKey = date.toISOString();
            
            // 按服务统计
            if (!serviceStats[item.service]) {
                serviceStats[item.service] = { normal: 0, shedding: 0, count: 0 };
            }
            serviceStats[item.service].count++;
            if (item.shedding === '正常') {
                serviceStats[item.service].normal++;
            } else {
                serviceStats[item.service].shedding++;
            }
            
            // 初始化或累加统计数据
            if (!originalMinuteData[minuteKey]) {
                originalMinuteData[minuteKey] = {
                    time: minuteKey,
                    formattedTime: formatTime(item.time),
                    // 使用原始值
                    cpu: parseInt(item.cpu) || 0,
                    alloc: parseFloat(item.alloc) || 0,
                    sys: parseFloat(item.sys) || 0,
                    numGC: parseInt(item.numGC) || 0,
                    qps: parseFloat(item.qps) || 0,
                    drops: parseInt(item.drops) || 0,
                    // 统计正常和限流请求数
                    normalCount: item.shedding === '正常' ? 1 : 0,
                    sheddingCount: item.shedding !== '正常' ? 1 : 0,
                    totalCount: 1,
                    // 服务信息
                    serviceStats: JSON.parse(JSON.stringify(serviceStats))
                };
            } else {
                // 对于同一分钟内的多个数据点，累加相关数值
                const existing = originalMinuteData[minuteKey];
                existing.cpu += parseInt(item.cpu) || 0;
                existing.alloc += parseFloat(item.alloc) || 0;
                existing.sys += parseFloat(item.sys) || 0;
                existing.numGC += parseInt(item.numGC) || 0;
                existing.qps += parseFloat(item.qps) || 0;
                existing.drops += parseInt(item.drops) || 0;
                existing.totalCount++;
                
                if (item.shedding === '正常') {
                    existing.normalCount++;
                } else {
                    existing.sheddingCount++;
                }
                
                // 更新服务统计信息的深拷贝
                existing.serviceStats = JSON.parse(JSON.stringify(serviceStats));
            }
        });
        
        // 获取时间范围内的第一个和最后一个时间点
        const allKeys = Object.keys(originalMinuteData);
        const startTime = new Date(Math.min(...allKeys.map(k => new Date(k))));
        const endTime = new Date(Math.max(...allKeys.map(k => new Date(k))));
        
        // 创建完整的分钟序列
        const result = [];
        let currentMinute = new Date(startTime);
        let lastValidData = null;
        
        while (currentMinute <= endTime) {
            const minuteKey = currentMinute.toISOString();
            const formattedTime = formatTime(minuteKey);
            
            if (originalMinuteData[minuteKey]) {
                // 如果当前分钟有数据，使用它
                const data = originalMinuteData[minuteKey];
                result.push(data);
                lastValidData = data;
            } else if (lastValidData) {
                // 如果没有数据但有上一分钟的数据，使用上一分钟的数据
                // 创建新对象以避免引用问题
                const data = {
                    time: minuteKey,
                    formattedTime: formattedTime,
                    cpu: lastValidData.cpu,
                    alloc: lastValidData.alloc,
                    sys: lastValidData.sys,
                    numGC: lastValidData.numGC,
                    qps: lastValidData.qps,
                    drops: lastValidData.drops,
                    normalCount: lastValidData.normalCount,
                    sheddingCount: lastValidData.sheddingCount,
                    totalCount: lastValidData.totalCount
                };
                result.push(data);
            }
            
            // 移动到下一分钟
            currentMinute.setMinutes(currentMinute.getMinutes() + 1);
        }
        
        return result;
    }

    // 渲染所有图表
    function renderAllCharts() {
        // 销毁现有图表
        Object.values(charts).forEach(chart => chart.dispose());
        charts = {};

        // 渲染内存趋势图
        renderMemoryTrendChart();

        // 渲染QPS和丢弃数趋势图
        renderQpsTrendChart();

        // 渲染服务分布图
        renderServiceDistributionChart();

        // 渲染系统指标综合图
        renderSystemMetricsChart();

        // 渲染限流状态分析图
        renderSheddingStatsChart();
        
        // 渲染限流趋势图
        renderSheddingTrendChart();
    }

    // 渲染内存趋势图
    function renderMemoryTrendChart() {
        const chartDom = document.getElementById('memoryTrendChart');
        const chart = echarts.init(chartDom);
        charts['memoryTrend'] = chart;

        // 使用分钟聚合后的数据
        const aggregatedData = aggregateDataByMinute();

        // 处理数据
        const times = aggregatedData.map(item => item.formattedTime);
        const allocData = aggregatedData.map(item => {
            const value = parseFloat(item.alloc);
            return isNaN(value) ? 0 : value;
        });
        const sysData = aggregatedData.map(item => {
            const value = parseFloat(item.sys);
            return isNaN(value) ? 0 : value;
        });

        // 图表配置 - 全新设计
        const option = {
            backgroundColor: 'transparent',
            // 增强的tooltip
            tooltip: {
                trigger: 'axis',
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                borderColor: '#E0E6ED',
                borderWidth: 1,
                borderRadius: 8,
                padding: [12, 16],
                textStyle: { 
                    color: '#1D2129',
                    fontSize: 12
                },
                formatter: function(params) {
                    let result = `<div style="font-weight: 600; color: #1D2129; margin-bottom: 6px;">${params[0].name}</div>`;
                    params.forEach(item => {
                        // 格式化内存值，保留2位小数
                        const formattedValue = item.value.toFixed(2);
                        result += `<div style="margin: 4px 0;"><span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background-color: ${item.color}; margin-right: 8px;"></span>${item.seriesName}: <span style="font-weight: 600;">${formattedValue} MiB</span></div>`;
                    });
                    return result;
                },
                // 添加阴影效果
                shadowColor: 'rgba(0, 0, 0, 0.1)',
                shadowBlur: 10,
                shadowOffsetX: 0,
                shadowOffsetY: 4
            },
            legend: {
                data: ['实时内存', '系统内存'],
                top: 0,
                left: 'center',
                textStyle: { 
                    color: '#4E5969',
                    fontSize: 12,
                    fontWeight: 500
                },
                itemWidth: 14,
                itemHeight: 14,
                padding: [0, 20]
            },
            grid: {
                left: '3%',
                right: '3%',
                bottom: '15%',
                top: '20%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                data: times,
                axisLine: { 
                    lineStyle: { 
                        color: '#E5E6EB',
                        width: 1
                    } 
                },
                axisLabel: {
                    color: '#86909C',
                    fontSize: 11,
                    rotate: 0,
                    interval: 0, // 显示所有标签，让echarts自动处理间隔
                    padding: [5, 0]
                },
                // 显示刻度线
                axisTick: {
                    show: true,
                    lineStyle: {
                        color: '#E5E6EB'
                    }
                },
                // 显示垂直分割线，提高可读性
                splitLine: {
                    show: true,
                    lineStyle: {
                        color: '#F2F3F5',
                        type: 'dashed'
                    }
                }
            },
            yAxis: {
                name: '内存 (MiB)',
                type: 'value',
                min: 0,
                axisLine: { 
                    show: false
                },
                axisLabel: {
                    color: '#86909C',
                    fontSize: 11,
                    formatter: '{value}'
                },
                axisTick: {
                    show: false
                },
                splitLine: { 
                    lineStyle: { 
                        color: '#F2F3F5',
                        type: 'solid',
                        width: 1
                    } 
                }
            },
            series: [
                {
                    name: '实时内存',
                    type: 'line',
                    data: allocData,
                    symbol: 'circle',
                    symbolSize: 6,
                    symbolHoverSize: 10,
                    smooth: true,
                    smoothMonotone: 'x',
                    lineStyle: { 
                        width: 4, 
                        color: '#36BFFA',
                        shadowColor: 'rgba(54, 191, 250, 0.4)',
                        shadowBlur: 10,
                        shadowOffsetY: 5
                    },
                    itemStyle: { 
                        color: '#36BFFA',
                        borderColor: '#fff',
                        borderWidth: 2,
                        shadowColor: 'rgba(54, 191, 250, 0.5)',
                        shadowBlur: 6
                    },
                    emphasis: {
                        focus: 'series',
                        itemStyle: {
                            shadowBlur: 10,
                            shadowColor: 'rgba(54, 191, 250, 0.6)'
                        }
                    },
                    areaStyle: {
                        color: {
                            type: 'linear',
                            x: 0,
                            y: 0,
                            x2: 0,
                            y2: 1,
                            colorStops: [{
                                offset: 0, color: 'rgba(54, 191, 250, 0.3)'
                            }, {
                                offset: 1, color: 'rgba(54, 191, 250, 0.02)'
                            }]
                        }
                    }
                },
                {
                    name: '系统内存',
                    type: 'line',
                    data: sysData,
                    symbol: 'circle',
                    symbolSize: 6,
                    symbolHoverSize: 10,
                    smooth: true,
                    smoothMonotone: 'x',
                    lineStyle: { 
                        width: 4, 
                        color: '#722ED1',
                        shadowColor: 'rgba(114, 46, 209, 0.4)',
                        shadowBlur: 10,
                        shadowOffsetY: 5
                    },
                    itemStyle: { 
                        color: '#722ED1',
                        borderColor: '#fff',
                        borderWidth: 2,
                        shadowColor: 'rgba(114, 46, 209, 0.5)',
                        shadowBlur: 6
                    },
                    emphasis: {
                        focus: 'series',
                        itemStyle: {
                            shadowBlur: 10,
                            shadowColor: 'rgba(114, 46, 209, 0.6)'
                        }
                    },
                    areaStyle: {
                        color: {
                            type: 'linear',
                            x: 0,
                            y: 0,
                            x2: 0,
                            y2: 1,
                            colorStops: [{
                                offset: 0, color: 'rgba(114, 46, 209, 0.3)'
                            }, {
                                offset: 1, color: 'rgba(114, 46, 209, 0.02)'
                            }]
                        }
                    }
                }
            ],
            dataZoom: [
                {
                    type: 'inside',
                    xAxisIndex: 0,
                    start: calculateInitialZoom(aggregatedData.length),
                    end: 100,
                    zoomOnMouseWheel: true,
                    moveOnMouseMove: true,
                    moveOnMouseWheel: false
                },
                {
                    type: 'slider',
                    xAxisIndex: 0,
                    bottom: 10,
                    start: calculateInitialZoom(aggregatedData.length),
                    end: 100,
                    height: 20,
                    backgroundColor: '#F2F3F5',
                    fillerColor: '#36BFFA',
                    handleStyle: {
                        color: '#36BFFA',
                        width: 14,
                        height: 24,
                        borderRadius: 7,
                        shadowColor: 'rgba(54, 191, 250, 0.4)',
                        shadowBlur: 6
                    },
                    borderColor: '#E5E6EB',
                    borderWidth: 1,
                    zoomLock: false,
                    showDetail: true,
                    showDataShadow: 'auto'
                }
            ],
            // 增强的动画效果
            animation: true,
            animationDuration: 1500,
            animationEasing: 'cubicOut',
            animationDelay: function (idx) {
                return idx * 10;
            },
            animationDurationUpdate: 1000
        };

        chart.setOption(option);
    }

    // 渲染QPS和丢弃数趋势图
    function renderQpsTrendChart() {
        const chartDom = document.getElementById('qpsTrendChart');
        const chart = echarts.init(chartDom);
        charts['qpsTrend'] = chart;

        // 使用分钟聚合后的数据
        const aggregatedData = aggregateDataByMinute();

        // 处理数据
        const times = aggregatedData.map(item => item.formattedTime);
        const qpsData = aggregatedData.map(item => {
            const value = parseFloat(item.qps);
            return isNaN(value) ? 0 : value;
        });
        const dropsData = aggregatedData.map(item => {
            const value = parseInt(item.drops);
            return isNaN(value) ? 0 : value;
        });

        // 图表配置 - 统一样式和增强效果
        const option = {
            backgroundColor: 'transparent',
            tooltip: {
                trigger: 'axis',
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                borderColor: '#E0E6ED',
                borderWidth: 1,
                borderRadius: 8,
                padding: [12, 16],
                textStyle: { 
                    color: '#1D2129',
                    fontSize: 12
                },
                formatter: function(params) {
                    let result = `<div style="font-weight: 600; color: #1D2129; margin-bottom: 6px;">${params[0].name}</div>`;
                    params.forEach(item => {
                        // 格式化数值，根据系列名显示不同单位
                        let formattedValue = item.value;
                        if (item.seriesName.includes('QPS')) {
                            formattedValue = item.value.toFixed(2);
                        } else if (item.seriesName.includes('丢弃数')) {
                            formattedValue = item.value.toLocaleString();
                        }
                         
                        result += `<div style="margin: 4px 0;"><span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background-color: ${item.color}; margin-right: 8px;"></span>${item.seriesName}: <span style="font-weight: 600;">${formattedValue}</span></div>`;
                    });
                    return result;
                },
                // 添加阴影效果
                shadowColor: 'rgba(0, 0, 0, 0.1)',
                shadowBlur: 10,
                shadowOffsetX: 0,
                shadowOffsetY: 4
            },
            legend: {
                data: ['QPS', '丢弃数'],
                top: 0,
                left: 'center',
                textStyle: { 
                    color: '#4E5969',
                    fontSize: 12,
                    fontWeight: 500
                },
                itemWidth: 14,
                itemHeight: 14,
                padding: [0, 20]
            },
            grid: {
                left: '5%',
                right: '10%',
                bottom: '15%',
                top: '15%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                data: times,
                axisLine: { lineStyle: { color: '#E5E6EB' } },
                axisLabel: {
                    color: '#4E5969',
                    rotate: 45,
                    interval: calculateLabelInterval(times.length)
                },
                // 显示刻度线
                axisTick: {
                    show: true,
                    lineStyle: {
                        color: '#E5E6EB'
                    }
                },
                // 显示垂直分割线，提高可读性
                splitLine: {
                    show: true,
                    lineStyle: {
                        color: '#F2F3F5',
                        type: 'dashed'
                    }
                }
            },
            yAxis: [
                {
                    type: 'value',
                    name: 'QPS',
                    min: 0,
                    axisLine: { lineStyle: { color: '#165DFF' } },
                    axisLabel: { color: '#4E5969' },
                    splitLine: { 
                        lineStyle: { 
                            color: '#F2F3F5',
                            type: 'dashed'
                        } 
                    }
                },
                {
                    type: 'value',
                    name: '丢弃数',
                    position: 'right',
                    min: 0,
                    axisLine: { lineStyle: { color: '#FF4D4F' } },
                    axisLabel: { color: '#FF4D4F' },
                    splitLine: { show: false }
                }
            ],
            series: [
                {
                    name: 'QPS',
                    type: 'line',
                    data: qpsData,
                    symbol: 'circle',
                    symbolSize: 6,
                    symbolHoverSize: 8,
                    smooth: true,
                    lineStyle: { 
                        width: 3, 
                        color: '#165DFF',
                        shadowColor: 'rgba(22, 93, 255, 0.3)',
                        shadowBlur: 10
                    },
                    itemStyle: { 
                        color: '#165DFF',
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    areaStyle: {
                        color: {
                            type: 'linear',
                            x: 0,
                            y: 0,
                            x2: 0,
                            y2: 1,
                            colorStops: [{
                                offset: 0, color: 'rgba(22, 93, 255, 0.25)'
                            }, {
                                offset: 1, color: 'rgba(22, 93, 255, 0)'
                            }]
                        }
                    }
                },
                {
                    name: '丢弃数',
                    type: 'bar',
                    yAxisIndex: 1,
                    data: dropsData,
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#FF4D4F' },
                            { offset: 1, color: '#FF7875' }
                        ])
                    },
                    barWidth: '30%',
                    emphasis: {
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: '#F5222D' },
                                { offset: 1, color: '#FF4D4F' }
                            ])
                        }
                    }
                }
            ],
            dataZoom: [
                {
                    type: 'inside',
                    xAxisIndex: 0,
                    start: calculateInitialZoom(aggregatedData.length),
                    end: 100
                },
                {
                    type: 'slider',
                    xAxisIndex: 0,
                    bottom: 5,
                    start: calculateInitialZoom(aggregatedData.length),
                    end: 100,
                    height: 20,
                    handleStyle: {
                        color: '#165DFF'
                    },
                    fillerColor: 'rgba(22, 93, 255, 0.2)'
                }
            ],
            animation: true,
            animationDuration: 1000
        };

        chart.setOption(option);
    }

    // 渲染服务分布图
    function renderServiceDistributionChart() {
        const chartDom = document.getElementById('serviceDistributionChart');
        const chart = echarts.init(chartDom);
        charts['serviceDistribution'] = chart;

        // 使用分钟聚合后的数据
        const aggregatedData = aggregateDataByMinute();
        
        // 准备数据 - 使用聚合数据中的服务统计信息
        const serviceData = {};
        
        // 检查是否有聚合数据
        if (aggregatedData.length > 0) {
            // 获取最后一个时间点的服务统计数据（最完整的）
            const lastDataPoint = aggregatedData[aggregatedData.length - 1];
            if (lastDataPoint.serviceStats) {
                // 从serviceStats中提取数据
                Object.keys(lastDataPoint.serviceStats).forEach(service => {
                    serviceData[service] = lastDataPoint.serviceStats[service].count;
                });
            }
        }
        
        // 如果聚合数据为空，使用原始logData作为后备
        if (Object.keys(serviceData).length === 0) {
            logData.forEach(item => {
                serviceData[item.service] = (serviceData[item.service] || 0) + 1;
            });
        }

        const data = Object.keys(serviceData).map(service => ({
            name: service,
            value: serviceData[service],
            itemStyle: { color: getServiceColor(service) }
        }));

        // 图表配置 - 统一样式和增强效果
        const option = {
            backgroundColor: 'transparent',
            tooltip: {
                trigger: 'item',
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                borderColor: '#E0E6ED',
                borderWidth: 1,
                borderRadius: 8,
                padding: [12, 16],
                textStyle: { 
                    color: '#1D2129',
                    fontSize: 12
                },
                formatter: function(params) {
                    const percentage = params.percent.toFixed(1);
                    return `<div style="font-weight: 600; color: #1D2129; margin-bottom: 6px;">${params.name}</div>
                           <div style="margin: 4px 0;">日志数量: <span style="font-weight: 600;">${params.value.toLocaleString()}</span></div>
                           <div style="margin: 4px 0;">占比: <span style="font-weight: 600;">${percentage}%</span></div>`;
                },
                shadowColor: 'rgba(0, 0, 0, 0.1)',
                shadowBlur: 10,
                shadowOffsetX: 0,
                shadowOffsetY: 4
            },
            legend: {
                orient: 'vertical',
                left: 10,
                textStyle: { color: '#4E5969' },
                formatter: function(name) {
                    const serviceCount = serviceData[name];
                    const totalCount = logData.length;
                    const percentage = ((serviceCount / totalCount) * 100).toFixed(1);
                    
                    if (name.length > 8) {
                        return `${name.substring(0, 8)}... (${percentage}%)`;
                    }
                    return `${name} (${percentage}%)`;
                }
            },
            series: [
                {
                    name: '日志数量',
                    type: 'pie',
                    radius: ['40%', '70%'],
                    avoidLabelOverlap: false,
                    itemStyle: {
                        borderRadius: 6,
                        borderColor: '#fff',
                        borderWidth: 2,
                        shadowBlur: 10,
                        shadowColor: 'rgba(0, 0, 0, 0.1)'
                    },
                    label: {
                        show: false,
                        position: 'center'
                    },
                    emphasis: {
                        label: {
                            show: true,
                            fontSize: 16,
                            fontWeight: 'bold',
                            color: '#333'
                        },
                        itemStyle: {
                            shadowBlur: 20,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.3)'
                        }
                    },
                    labelLine: {
                        show: false
                    },
                    data: data
                }
            ],
            animation: true,
            animationDuration: 1000,
            animationEasing: 'cubicOut'
        };

        chart.setOption(option);
    }

    // 渲染限流趋势图
    function renderSheddingTrendChart() {
        const chartDom = document.getElementById('sheddingTrendChart');
        const chart = echarts.init(chartDom);
        charts['sheddingTrend'] = chart;

        // 使用分钟聚合后的数据
        const aggregatedData = aggregateDataByMinute();

        // 处理数据 - 按时间统计限流情况
        // 1. 从聚合数据中提取时间和限流相关信息
        const times = aggregatedData.map(item => item.formattedTime);
        const normalData = aggregatedData.map(item => item.normalCount);
        const sheddingData = aggregatedData.map(item => item.sheddingCount);
        const totalData = aggregatedData.map(item => item.totalCount);
        
        // 计算限流率
        const sheddingRateData = times.map((time, index) => {
            if (totalData[index] === 0) return 0;
            return (sheddingData[index] / totalData[index] * 100).toFixed(1);
        });

        // 图表配置 - 统一样式和增强效果
        const option = {
            backgroundColor: 'transparent',
            tooltip: {
                trigger: 'axis',
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                borderColor: '#E0E6ED',
                borderWidth: 1,
                borderRadius: 8,
                padding: [12, 16],
                textStyle: {
                    color: '#1D2129',
                    fontSize: 12
                },
                formatter: function(params) {
                    let result = `<div style="font-weight: 600; color: #1D2129; margin-bottom: 6px;">${params[0].name}</div>`;
                    params.forEach(item => {
                        let formattedValue = item.value;
                        if (item.seriesName.includes('限流率')) {
                            formattedValue = `${item.value}%`;
                        } else {
                            formattedValue = item.value.toLocaleString();
                        }
                        
                        result += `<div style="margin: 4px 0;"><span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background-color: ${item.color}; margin-right: 8px;"></span>${item.seriesName}: <span style="font-weight: 600;">${formattedValue}</span></div>`;
                    });
                    return result;
                },
                shadowColor: 'rgba(0, 0, 0, 0.1)',
                shadowBlur: 10,
                shadowOffsetX: 0,
                shadowOffsetY: 4
            },
            legend: {
                data: ['正常请求数', '限流请求数', '总请求数', '限流率'],
                top: 0,
                left: 'center',
                textStyle: {
                    color: '#4E5969',
                    fontSize: 12,
                    fontWeight: 500
                },
                itemWidth: 14,
                itemHeight: 14,
                padding: [0, 20]
            },
            grid: {
                left: '5%',
                right: '10%',
                bottom: '15%',
                top: '15%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                data: times,
                axisLine: { lineStyle: { color: '#E5E6EB' } },
                axisLabel: {
                    color: '#4E5969',
                    rotate: 45,
                    interval: calculateLabelInterval(times.length)
                },
                axisTick: {
                    show: true,
                    lineStyle: { color: '#E5E6EB' }
                },
                splitLine: {
                    show: true,
                    lineStyle: {
                        color: '#F2F3F5',
                        type: 'dashed'
                    }
                }
            },
            yAxis: [
                {
                    name: '请求数',
                    type: 'value',
                    min: 0,
                    axisLine: { lineStyle: { color: '#165DFF' } },
                    axisLabel: { color: '#4E5969' },
                    splitLine: {
                        lineStyle: {
                            color: '#F2F3F5',
                            type: 'dashed'
                        }
                    }
                },
                {
                    name: '限流率(%)',
                    type: 'value',
                    position: 'right',
                    min: 0,
                    max: 100,
                    axisLine: { lineStyle: { color: '#F5222D' } },
                    axisLabel: {
                        color: '#F5222D',
                        formatter: '{value}%'
                    },
                    splitLine: { show: false }
                }
            ],
            series: [
                {
                    name: '正常请求数',
                    type: 'bar',
                    stack: 'total',
                    data: normalData,
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#52C41A' },
                            { offset: 1, color: '#95DE64' }
                        ])
                    },
                    barWidth: '40%'
                },
                {
                    name: '限流请求数',
                    type: 'bar',
                    stack: 'total',
                    data: sheddingData,
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#F5222D' },
                            { offset: 1, color: '#FF7875' }
                        ])
                    },
                    barWidth: '40%'
                },
                {
                    name: '总请求数',
                    type: 'line',
                    data: totalData,
                    symbol: 'circle',
                    symbolSize: 6,
                    symbolHoverSize: 8,
                    smooth: true,
                    lineStyle: {
                        width: 3,
                        color: '#165DFF',
                        shadowColor: 'rgba(22, 93, 255, 0.3)',
                        shadowBlur: 10
                    },
                    itemStyle: {
                        color: '#165DFF',
                        borderColor: '#fff',
                        borderWidth: 2
                    }
                },
                {
                    name: '限流率',
                    type: 'line',
                    yAxisIndex: 1,
                    data: sheddingRateData,
                    symbol: 'circle',
                    symbolSize: 6,
                    symbolHoverSize: 8,
                    smooth: true,
                    lineStyle: {
                        width: 3,
                        color: '#F5222D',
                        type: 'dashed',
                        shadowColor: 'rgba(245, 34, 45, 0.3)',
                        shadowBlur: 10
                    },
                    itemStyle: {
                        color: '#F5222D',
                        borderColor: '#fff',
                        borderWidth: 2
                    }
                }
            ],
            dataZoom: [
                {
                    type: 'inside',
                    xAxisIndex: 0,
                    start: calculateInitialZoom(aggregatedData.length),
                    end: 100
                },
                {
                    type: 'slider',
                    xAxisIndex: 0,
                    bottom: 5,
                    start: calculateInitialZoom(aggregatedData.length),
                    end: 100,
                    height: 20,
                    handleStyle: {
                        color: '#165DFF'
                    },
                    fillerColor: 'rgba(22, 93, 255, 0.2)'
                }
            ],
            animation: true,
            animationDuration: 1000
        };

        chart.setOption(option);
    }

    function renderSystemMetricsChart() {
        const chartDom = document.getElementById('cpuTrendChart');
        const chart = echarts.init(chartDom);
        charts['cpuTrend'] = chart;

        // 使用分钟聚合后的数据
        const aggregatedData = aggregateDataByMinute();

        // 处理数据
        const times = aggregatedData.map(item => item.formattedTime);
        const cpuData = aggregatedData.map(item => {
            const value = parseInt(item.cpu);
            return isNaN(value) ? 0 : value;
        });
        const numGCData = aggregatedData.map(item => {
            const value = parseInt(item.numGC);
            return isNaN(value) ? 0 : value;
        });
        const memData = aggregatedData.map(item => {
            const value = parseFloat(item.alloc);
            return isNaN(value) ? 0 : value;
        });

        // 图表配置 - 统一样式和增强效果
        const option = {
            backgroundColor: 'transparent',
            tooltip: {
                trigger: 'axis',
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                borderColor: '#E0E6ED',
                borderWidth: 1,
                borderRadius: 8,
                padding: [12, 16],
                textStyle: { 
                    color: '#1D2129',
                    fontSize: 12
                },
                formatter: function(params) {
                    let result = `<div style="font-weight: 600; color: #1D2129; margin-bottom: 6px;">${params[0].name}</div>`;
                    params.forEach(item => {
                        // 格式化数值
                        let formattedValue = item.value;
                        if (item.seriesName.includes('CPU')) {
                            formattedValue = `${item.value.toLocaleString()}m`;
                        } else if (item.seriesName.includes('GC')) {
                            formattedValue = item.value.toLocaleString();
                        } else if (item.seriesName.includes('内存')) {
                            formattedValue = `${item.value.toLocaleString()}MB`;
                        }
                         
                        result += `<div style="margin: 4px 0;"><span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background-color: ${item.color}; margin-right: 8px;"></span>${item.seriesName}: <span style="font-weight: 600;">${formattedValue}</span></div>`;
                    });
                    return result;
                },
                shadowColor: 'rgba(0, 0, 0, 0.1)',
                shadowBlur: 10,
                shadowOffsetX: 0,
                shadowOffsetY: 4
            },
            legend: {
                data: ['CPU占用(m)', 'GC次数', '内存占用(MB)'],
                top: 0,
                left: 'center',
                textStyle: { 
                    color: '#4E5969',
                    fontSize: 12,
                    fontWeight: 500
                },
                itemWidth: 14,
                itemHeight: 14,
                padding: [0, 20]
            },
            grid: {
                left: '5%',
                right: '10%',
                bottom: '15%',
                top: '15%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                data: times,
                axisLine: { lineStyle: { color: '#E5E6EB' } },
                axisLabel: {
                    color: '#4E5969',
                    rotate: 45,
                    interval: calculateLabelInterval(times.length)
                },
                splitLine: { show: false }
            },
            yAxis: [
                {
                    name: 'CPU占用(m)',
                    type: 'value',
                    min: 0,
                    axisLine: { lineStyle: { color: '#FAAD14' } },
                    axisLabel: { color: '#4E5969' },
                    splitLine: { 
                        lineStyle: { 
                            color: '#F2F3F5',
                            type: 'dashed'
                        } 
                    }
                },
                {
                    name: 'GC次数',
                    type: 'value',
                    position: 'right',
                    offset: 60,
                    min: 0,
                    axisLine: { lineStyle: { color: '#52C41A' } },
                    axisLabel: { color: '#52C41A' },
                    splitLine: { show: false }
                },
                {
                    name: '内存占用(MB)',
                    type: 'value',
                    position: 'right',
                    min: 0,
                    axisLine: { lineStyle: { color: '#1677FF' } },
                    axisLabel: { color: '#1677FF' },
                    splitLine: { show: false }
                }
            ],
            series: [
                {
                    name: 'CPU占用(m)',
                    type: 'bar',
                    data: cpuData,
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#FAAD14' },
                            { offset: 1, color: '#FFC53D' }
                        ])
                    },
                    barWidth: '30%',
                    emphasis: {
                        itemStyle: {
                            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                                { offset: 0, color: '#FA8C16' },
                                { offset: 1, color: '#FAAD14' }
                            ])
                        }
                    }
                },
                {
                    name: 'GC次数',
                    type: 'line',
                    yAxisIndex: 1,
                    data: numGCData,
                    symbol: 'circle',
                    symbolSize: 6,
                    symbolHoverSize: 8,
                    smooth: true,
                    lineStyle: { 
                        width: 3, 
                        color: '#52C41A',
                        type: 'solid',
                        shadowColor: 'rgba(82, 196, 26, 0.3)',
                        shadowBlur: 10
                    },
                    itemStyle: { 
                        color: '#52C41A',
                        borderColor: '#fff',
                        borderWidth: 2
                    }
                },
                {
                    name: '内存占用(MB)',
                    type: 'line',
                    yAxisIndex: 2,
                    data: memData,
                    symbol: 'circle',
                    symbolSize: 6,
                    symbolHoverSize: 8,
                    smooth: true,
                    lineStyle: { 
                        width: 3,
                        color: '#1677FF',
                        shadowColor: 'rgba(22, 119, 255, 0.3)',
                        shadowBlur: 10
                    },
                    itemStyle: { 
                        color: '#1677FF',
                        borderColor: '#fff',
                        borderWidth: 2
                    },
                    areaStyle: {
                        color: {
                            type: 'linear',
                            x: 0,
                            y: 0,
                            x2: 0,
                            y2: 1,
                            colorStops: [{
                                offset: 0, color: 'rgba(22, 119, 255, 0.15)'
                            }, {
                                offset: 1, color: 'rgba(22, 119, 255, 0)'
                            }]
                        }
                    }
                }
            ],
            dataZoom: [
                {
                    type: 'inside',
                    xAxisIndex: 0,
                    start: calculateInitialZoom(aggregatedData.length),
                    end: 100
                },
                {
                    type: 'slider',
                    xAxisIndex: 0,
                    bottom: 5,
                    start: calculateInitialZoom(aggregatedData.length),
                    end: 100,
                    height: 20,
                    handleStyle: {
                        color: '#FAAD14'
                    },
                    fillerColor: 'rgba(250, 173, 20, 0.2)'
                }
            ],
            animation: true,
            animationDuration: 1000
        };

        chart.setOption(option);
    }

    // 渲染限流状态分析图
    function renderSheddingStatsChart() {
        const chartDom = document.getElementById('sheddingStatsChart');
        const chart = echarts.init(chartDom);
        charts['sheddingStats'] = chart;

        // 使用分钟聚合后的数据
        const aggregatedData = aggregateDataByMinute();

        // 统计限流状态数据
        let totalNormalCount = 0;
        let totalSheddingCount = 0;
        
        // 按服务统计限流状态
        const serviceSheddingData = {};
        
        // 检查是否有聚合数据
        if (aggregatedData.length > 0) {
            // 获取最后一个时间点的服务统计数据（最完整的）
            const lastDataPoint = aggregatedData[aggregatedData.length - 1];
            if (lastDataPoint.serviceStats) {
                // 从serviceStats中提取数据
                Object.keys(lastDataPoint.serviceStats).forEach(service => {
                    const stats = lastDataPoint.serviceStats[service];
                    serviceSheddingData[service] = {
                        normal: stats.normal || 0,
                        shedding: stats.shedding || 0
                    };
                    totalNormalCount += stats.normal || 0;
                    totalSheddingCount += stats.shedding || 0;
                });
            }
        }
        
        // 如果聚合数据的服务统计为空，回退到原始方法
        if (Object.keys(serviceSheddingData).length === 0) {
            aggregatedData.forEach(item => {
                // 对于每个聚合数据点，计算总数
                totalNormalCount += item.normalCount || 0;
                totalSheddingCount += item.sheddingCount || 0;
            });
        }

        const serviceNames = Object.keys(serviceSheddingData);
        const normalData = serviceNames.map(service => serviceSheddingData[service].normal);
        const sheddingData = serviceNames.map(service => serviceSheddingData[service].shedding);

        // 图表配置 - 统一样式和增强效果
        const option = {
            backgroundColor: 'transparent',
            tooltip: {
                trigger: 'axis',
                axisPointer: {
                    type: 'shadow'
                },
                backgroundColor: 'rgba(255, 255, 255, 0.95)',
                borderColor: '#E0E6ED',
                borderWidth: 1,
                borderRadius: 8,
                padding: [12, 16],
                textStyle: { 
                    color: '#1D2129',
                    fontSize: 12
                },
                formatter: function(params) {
                    let result = `<div style="font-weight: 600; color: #1D2129; margin-bottom: 6px;">${params[0].name}</div>`;
                    let total = 0;
                    params.forEach(item => {
                        result += `<div style="margin: 4px 0;"><span style="display: inline-block; width: 10px; height: 10px; border-radius: 50%; background-color: ${item.color}; margin-right: 8px;"></span>${item.seriesName}: <span style="font-weight: 600;">${item.value.toLocaleString()}</span></div>`;
                        total += item.value;
                    });
                    // 计算限流比例
                    const sheddingValue = params.find(p => p.seriesName === '限流')?.value || 0;
                    const sheddingRatio = total > 0 ? ((sheddingValue / total) * 100).toFixed(1) : 0;
                    result += `<div style="margin-top: 6px; padding-top: 6px; border-top: 1px solid #E5E6EB;">
                                <div style="margin: 4px 0;">总日志数: <span style="font-weight: 600;">${total.toLocaleString()}</span></div>
                                <div style="margin: 4px 0;">限流比例: <span style="font-weight: 600;">${sheddingRatio}%</span></div>
                              </div>`;
                    return result;
                },
                shadowColor: 'rgba(0, 0, 0, 0.1)',
                shadowBlur: 10,
                shadowOffsetX: 0,
                shadowOffsetY: 4
            },
            legend: {
                data: ['正常', '限流'],
                top: 0,
                left: 'center',
                textStyle: { 
                    color: '#4E5969',
                    fontSize: 12,
                    fontWeight: 500
                },
                itemWidth: 14,
                itemHeight: 14,
                padding: [0, 20]
            },
            grid: {
                left: '5%',
                right: '5%',
                bottom: '15%',
                top: '15%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                data: serviceNames,
                axisLine: { lineStyle: { color: '#E5E6EB' } },
                axisLabel: {
                    color: '#4E5969',
                    rotate: 45,
                    interval: calculateLabelInterval(serviceNames.length)
                },
                axisTick: {
                    show: true,
                    lineStyle: { color: '#E5E6EB' }
                },
                splitLine: {
                    show: true,
                    lineStyle: {
                        color: '#F2F3F5',
                        type: 'dashed'
                    }
                }
            },
            yAxis: {
                type: 'value',
                min: 0,
                axisLine: { lineStyle: { color: '#E5E6EB' } },
                axisLabel: { color: '#4E5969' },
                splitLine: { 
                    lineStyle: { 
                        color: '#F2F3F5',
                        type: 'dashed'
                    } 
                }
            },
            series: [
                {
                    name: '正常',
                    type: 'bar',
                    stack: 'total',
                    emphasis: {
                        focus: 'series'
                    },
                    data: normalData,
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#52C41A' },
                            { offset: 1, color: '#73D13D' }
                        ])
                    },
                    barWidth: '40%'
                },
                {
                    name: '限流',
                    type: 'bar',
                    stack: 'total',
                    emphasis: {
                        focus: 'series'
                    },
                    data: sheddingData,
                    itemStyle: {
                        color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                            { offset: 0, color: '#FF4D4F' },
                            { offset: 1, color: '#FF7875' }
                        ])
                    },
                    barWidth: '40%'
                }
            ],
            animation: true,
            animationDuration: 1000
        };

        chart.setOption(option);
    }

    // 获取服务对应的颜色
    function getServiceColor(service) {
        const colors = ['#165DFF', '#36CFC9', '#52C41A', '#FAAD14', '#FF4D4F', '#722ED1', '#F5222D', '#FA8C16', '#EB2F96'];
        let hash = 0;
        for (let i = 0; i < service.length; i++) {
            hash = service.charCodeAt(i) + ((hash << 5) - hash);
        }
        return colors[Math.abs(hash) % colors.length];
    }

    // 计算标签显示间隔
    function calculateLabelInterval(dataLength) {
        if (dataLength <= 20) return 0;  // 显示所有标签
        if (dataLength <= 50) return 2;  // 每2个显示一个
        if (dataLength <= 100) return 4; // 每4个显示一个
        return Math.floor(dataLength / 20); // 最多显示20个标签
    }

    // 计算初始缩放比例
    function calculateInitialZoom(dataLength) {
        if (dataLength <= 100) return 0;
        if (dataLength <= 500) return Math.max(0, 100 - 2000 / dataLength);
        return Math.max(0, 100 - 1000 / (dataLength / 20));
    }

    // 处理图表操作
    function handleChartAction(e) {
        const chartId = e.currentTarget.getAttribute('data-chart');
        const action = e.currentTarget.querySelector('i').classList.contains('fa-expand') ? 'expand' : 'refresh';
        
        if (action === 'expand') {
            showFullscreenChart(chartId);
        } else {
            refreshChart(chartId);
        }
    }

    // 刷新图表
    function refreshChart(chartId) {
        const chart = charts[chartId];
        if (chart) {
            chart.resize();
            chart.dispatchAction({ type: 'takeGlobalCursor', key: 'dataZoomSelect', dataZoomSelectActive: true });
        }
    }

    // 显示全屏图表
    function showFullscreenChart(chartId) {
        const chart = charts[chartId];
        if (!chart) return;

        // 获取图表标题
        const chartTitle = document.querySelector(`[data-chart="${chartId}"]`).closest('.chart-container').previousElementSibling.querySelector('h3').textContent;
        modalChartTitle.textContent = chartTitle;

        // 创建新的图表实例
        const fullscreenChart = echarts.init(modalChartContainer);
        
        // 获取原始图表配置并进行深拷贝，避免直接引用导致数据问题
        const originalOption = chart.getOption();
        const fullscreenOption = JSON.parse(JSON.stringify(originalOption));
        
        // 优化全屏图表样式
        fullscreenOption.title = {
            text: chartTitle,
            left: 'center',
            top: 20,
            textStyle: {
                fontSize: 18,
                fontWeight: 'bold',
                color: '#1D2129'
            }
        };
        
        // 优化tooltip样式（统一使用白色半透明背景）
        if (!fullscreenOption.tooltip) {
            fullscreenOption.tooltip = {};
        }
        fullscreenOption.tooltip.backgroundColor = 'rgba(255, 255, 255, 0.95)';
        fullscreenOption.tooltip.borderColor = '#E0E6ED';
        fullscreenOption.tooltip.borderWidth = 1;
        fullscreenOption.tooltip.borderRadius = 8;
        fullscreenOption.tooltip.padding = [12, 16];
        fullscreenOption.tooltip.textStyle = { 
            color: '#1D2129',
            fontSize: 12
        };
        // 添加阴影效果
        fullscreenOption.tooltip.shadowColor = 'rgba(0, 0, 0, 0.1)';
        fullscreenOption.tooltip.shadowBlur = 10;
        fullscreenOption.tooltip.shadowOffsetX = 0;
        fullscreenOption.tooltip.shadowOffsetY = 4;
        
        // 优化图例样式
        if (fullscreenOption.legend) {
            fullscreenOption.legend.top = 60;
            fullscreenOption.legend.left = 'center';
            fullscreenOption.legend.textStyle = {
                color: '#4E5969',
                fontSize: 12,
                fontWeight: 500
            };
            fullscreenOption.legend.itemWidth = 14;
            fullscreenOption.legend.itemHeight = 14;
            fullscreenOption.legend.padding = [0, 20];
        };
        
        // 优化网格布局
        if (fullscreenOption.grid) {
            fullscreenOption.grid.left = '3%';
            fullscreenOption.grid.right = '3%';
            fullscreenOption.grid.bottom = '10%';
            fullscreenOption.grid.top = '15%';
        } else {
            fullscreenOption.grid = {
                left: '3%',
                right: '3%',
                bottom: '10%',
                top: '15%',
                containLabel: true
            };
        };
        
        // 确保数据格式正确，特别是内存图表
        if (chartId === 'memoryTrend') {
            // 确保数据数组不为空
            if (fullscreenOption.series) {
                fullscreenOption.series.forEach(series => {
                    if (series.data && Array.isArray(series.data) && series.data.length > 0) {
                        // 确保数据点是有效数字
                        series.data = series.data.map(point => {
                            if (typeof point === 'number') {
                                return point;
                            } else if (Array.isArray(point)) {
                                // 确保数组中的数值有效
                                return point.map(val => val === null || val === undefined ? 0 : val);
                            }
                            return point;
                        });
                    }
                });
            }
        }
        
        fullscreenChart.setOption(fullscreenOption);
        
        // 保存到临时变量以便关闭时销毁
        modalChartContainer.chartInstance = fullscreenChart;
        
        // 显示模态框并添加关闭事件处理
        chartModal.classList.remove('hidden');
        
        // 确保只添加一个关闭事件监听器
        const existingCloseHandler = chartModal.closeHandler;
        if (existingCloseHandler) {
            chartModal.removeEventListener('click', existingCloseHandler);
        }
        
        // 创建新的关闭处理函数
        const closeHandler = (e) => {
            if (e.target === chartModal) {
                chartModal.classList.add('hidden');
                
                // 销毁全屏图表实例
                if (modalChartContainer.chartInstance) {
                    modalChartContainer.chartInstance.dispose();
                    modalChartContainer.chartInstance = null;
                }
                
                // 移除窗口大小变化监听
                if (modalChartContainer.resizeHandler) {
                    window.removeEventListener('resize', modalChartContainer.resizeHandler);
                    modalChartContainer.resizeHandler = null;
                }
            }
        };
        
        // 保存关闭处理函数引用
        chartModal.closeHandler = closeHandler;
        chartModal.addEventListener('click', closeHandler);
        
        // 调整大小
        setTimeout(() => {
            fullscreenChart.resize();
        }, 100);
        
        // 添加窗口大小变化监听
        const handleModalResize = () => {
            if (modalChartContainer.chartInstance) {
                modalChartContainer.chartInstance.resize();
            }
        };
        
        window.addEventListener('resize', handleModalResize);
        
        // 保存resize处理器引用，以便关闭时移除
        modalChartContainer.resizeHandler = handleModalResize;
    }

    // 处理表头排序
    function handleHeaderClick(e) {
        const header = e.target.closest('[data-field]');
        if (!header) return;
        
        const field = header.dataset.field;
        
        // 如果点击的是当前排序字段，切换排序顺序
        if (field === sortField) {
            sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
        } else {
            // 否则，设置新的排序字段，默认倒序
            sortField = field;
            sortOrder = 'desc';
        }
        
        // 更新排序图标
        updateSortIcons();
        
        // 保存滚动位置
        saveScrollPosition();
        
        // 重新渲染表格
        renderTable();
    }
    
    // 更新排序图标
    function updateSortIcons() {
        // 重置所有图标
        document.querySelectorAll('th[data-field] i').forEach(icon => {
            icon.className = 'fa fa-sort';
            icon.parentElement.className = 'ml-1';
        });
        
        // 设置当前排序字段的图标
        const currentHeader = document.querySelector(`th[data-field="${sortField}"] i`);
        if (currentHeader) {
            currentHeader.className = sortOrder === 'asc' ? 'fa fa-sort-up' : 'fa fa-sort-down';
            currentHeader.parentElement.className = 'ml-1 text-primary';
        }
    }
    
    // 渲染表格
    function renderTable() {
        const filteredData = getFilteredData();
        const pageSizeValue = parseInt(pageSize.value);
        const startIndex = (currentPage - 1) * pageSizeValue;
        const endIndex = Math.min(startIndex + pageSizeValue, filteredData.length);
        const pageData = filteredData.slice(startIndex, endIndex);

        // 显示加载状态
        tableContainer.classList.add('table-loading');

        // 清空表格
        logTableBody.innerHTML = '';

        // 添加300ms延迟，让用户能看到加载动画
        setTimeout(() => {
            // 移除加载状态
            tableContainer.classList.remove('table-loading');

            // 添加数据行
            if (pageData.length > 0) {
                pageData.forEach((item, index) => {
                    const row = document.createElement('tr');
                    // 添加表格行过渡动画和hover效果
                    row.className = 'border-b border-light-1 hover:bg-gray-50 transition-all duration-300 transform hover:-translate-y-1 opacity-0 table-row-animation';
                    
                    // 为有丢弃数的行添加特殊样式
                    if (parseInt(item.drops) > 0) {
                        row.classList.add('bg-danger/5');
                    }
                    
                    row.innerHTML = `
                        <td class="px-6 py-4">${formatDateTime(item.time)}</td>
                        <td class="px-6 py-4 font-medium">${item.service}</td>
                        <td class="px-6 py-4">${item.cpu}</td>
                        <td class="px-6 py-4">${item.alloc}</td>
                        <td class="px-6 py-4">${item.sys}</td>
                        <td class="px-6 py-4">${item.numGC}</td>
                        <td class="px-6 py-4">${item.qps}</td>
                        <td class="px-6 py-4 ${parseInt(item.drops) > 0 ? 'text-danger font-medium' : ''}">${item.drops}</td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${item.shedding === '正常' ? 'bg-success/10 text-success' : 'bg-danger/10 text-danger'}">
                                ${item.shedding}
                            </span>
                        </td>
                    `;
                    
                    logTableBody.appendChild(row);
                    
                    // 为每一行添加延迟动画效果
                    setTimeout(() => {
                        row.style.opacity = '1';
                    }, index * 50);
                });
            } else {
                // 显示空数据提示
                const emptyRow = document.createElement('tr');
                emptyRow.innerHTML = `
                    <td colspan="9" class="px-6 py-10 text-center text-dark-2">
                        <i class="fa fa-inbox text-3xl mb-2"></i>
                        <p>暂无数据</p>
                    </td>
                `;
                logTableBody.appendChild(emptyRow);
            }

            // 更新分页信息
            currentRange.textContent = filteredData.length > 0 ? `${startIndex + 1}-${endIndex}` : '0-0';
            pageInfo.textContent = `第 ${currentPage} 页`;
            
            // 更新分页按钮状态
            prevPage.disabled = currentPage === 1 || filteredData.length === 0;
            nextPage.disabled = endIndex >= filteredData.length || filteredData.length === 0;
            
            // 恢复滚动位置
            restoreScrollPosition();
        }, 300);
    }

    // 排序相关变量
    let sortField = 'time'; // 默认按时间排序
    let sortOrder = 'desc'; // 默认倒序
    let scrollPosition = 0; // 保存滚动位置
    
    // 获取过滤后的数据
    function getFilteredData() {
        const service = serviceFilter.value;
        let filtered = service === 'all' ? logData : logData.filter(item => item.service === service);
        
        // 排序数据
        filtered.sort((a, b) => {
            let valueA = a[sortField];
            let valueB = b[sortField];
            
            // 处理不同类型的数据排序
            if (sortField === 'time') {
                // 时间排序
                const timeA = new Date(valueA).getTime();
                const timeB = new Date(valueB).getTime();
                return sortOrder === 'asc' ? timeA - timeB : timeB - timeA;
            } else if (['cpu', 'alloc', 'sys', 'numGC', 'qps', 'drops'].includes(sortField)) {
                // 数值排序
                const numA = parseFloat(valueA) || 0;
                const numB = parseFloat(valueB) || 0;
                return sortOrder === 'asc' ? numA - numB : numB - numA;
            } else {
                // 字符串排序
                return sortOrder === 'asc' 
                    ? valueA.localeCompare(valueB) 
                    : valueB.localeCompare(valueA);
            }
        });
        
        return filtered;
    }
    
    // 保存当前滚动位置
    function saveScrollPosition() {
        const container = document.getElementById('tableContainer');
        if (container) {
            scrollPosition = container.scrollTop;
        }
    }
    
    // 恢复滚动位置
    function restoreScrollPosition() {
        const container = document.getElementById('tableContainer');
        if (container && scrollPosition > 0) {
            // 使用requestAnimationFrame确保DOM已更新
            requestAnimationFrame(() => {
                container.scrollTop = scrollPosition;
            });
        }
    }

    // 过滤表格数据
    function filterTableData() {
        currentPage = 1;
        saveScrollPosition();
        renderTable();
    }

    // 上一页
    function goToPrevPage() {
        if (currentPage > 1) {
            currentPage--;
            saveScrollPosition();
            renderTable();
        }
    }

    // 下一页
    function goToNextPage() {
        const filteredData = getFilteredData();
        const pageSizeValue = parseInt(pageSize.value);
        const maxPage = Math.ceil(filteredData.length / pageSizeValue);
        if (currentPage < maxPage) {
            currentPage++;
            saveScrollPosition();
            renderTable();
        }
    }

    // 更改每页显示数量
    function changePageSize() {
        currentPage = 1;
        saveScrollPosition();
        renderTable();
    }

    // 显示状态消息
    function showStatus(type, message) {
        statusMessage.classList.remove('hidden');
        
        if (type === 'success') {
            statusMessage.classList.add('bg-success/10', 'text-success');
            statusMessage.classList.remove('bg-danger/10', 'text-danger', 'bg-warning/10', 'text-warning');
            statusIcon.className = 'fa fa-check-circle mr-3 text-xl';
        } else if (type === 'error') {
            statusMessage.classList.add('bg-danger/10', 'text-danger');
            statusMessage.classList.remove('bg-success/10', 'text-success', 'bg-warning/10', 'text-warning');
            statusIcon.className = 'fa fa-exclamation-circle mr-3 text-xl';
        } else if (type === 'warning') {
            statusMessage.classList.add('bg-warning/10', 'text-warning');
            statusMessage.classList.remove('bg-success/10', 'text-success', 'bg-danger/10', 'text-danger');
            statusIcon.className = 'fa fa-exclamation-triangle mr-3 text-xl';
        }
        
        statusText.textContent = message;
        
        // 3秒后自动隐藏
        setTimeout(() => {
            hideStatus();
        }, 5000);
    }

    // 隐藏状态消息
    function hideStatus() {
        statusMessage.classList.add('hidden');
    }

    // 处理窗口大小变化
    function handleResize() {
        // 延迟执行，避免频繁触发
        clearTimeout(window.resizeTimeout);
        window.resizeTimeout = setTimeout(() => {
            Object.values(charts).forEach(chart => chart.resize());
        }, 100);
    }

    // 初始化应用
    init();
</script>
</body>
</html>