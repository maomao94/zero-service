<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Go-Zero Stats 日志分析工具</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3b82f6',
            secondary: '#6366f1',
            success: '#10b981',
            warning: '#f59e0b',
            danger: '#ef4444',
            dark: '#1e293b',
            light: '#f8fafc'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif']
          }
        }
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }
      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }
      .text-shadow {
        text-shadow: 0 1px 2px rgba(0,0,0,0.1);
      }
      .transition-all-300 {
        transition: all 300ms ease-in-out;
      }
    }
  </style>
</head>
<body class="bg-gray-50 font-sans text-gray-800 min-h-screen">
  <div class="container mx-auto px-4 py-8 max-w-7xl">
    <!-- 顶部导航栏 -->
    <header class="mb-8">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div class="flex items-center gap-2">
          <div class="text-primary text-3xl">
            <i class="fa fa-bar-chart"></i>
          </div>
          <h1 class="text-2xl md:text-3xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">
            Go-Zero Stats 日志分析工具
          </h1>
        </div>
        <div class="flex flex-wrap gap-2">
          <button id="clearBtn" class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300 text-gray-700 transition-all-300 flex items-center gap-2">
            <i class="fa fa-trash"></i>
            <span>清空数据</span>
          </button>
          <button id="exportBtn" class="px-4 py-2 rounded-md bg-secondary hover:bg-indigo-600 text-white transition-all-300 flex items-center gap-2">
            <i class="fa fa-download"></i>
            <span>导出结果</span>
          </button>
        </div>
      </div>
    </header>

    <!-- 拖放区域 -->
    <section id="dropZone" class="border-2 border-dashed border-gray-300 rounded-lg p-8 mb-8 text-center hover:border-primary transition-all-300 cursor-pointer bg-white">
      <div class="flex flex-col items-center justify-center">
        <div class="text-5xl text-gray-400 mb-4">
          <i class="fa fa-file-text-o"></i>
        </div>
        <h2 class="text-xl font-semibold mb-2">拖放日志文件到此处</h2>
        <p class="text-gray-500 mb-4">或</p>
        <label class="px-6 py-3 bg-primary hover:bg-blue-600 text-white rounded-md transition-all-300 cursor-pointer flex items-center gap-2">
          <i class="fa fa-upload"></i>
          <span>选择文件</span>
          <input type="file" id="fileInput" class="hidden" accept=".log,.txt" multiple>
        </label>
        <p class="text-gray-400 text-sm mt-4">支持 .log 或 .txt 文件，可多选</p>
      </div>
    </section>

    <!-- 统计概览 -->
    <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
      <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-gray-500 text-sm font-medium">总日志行数</h3>
          <div class="text-primary text-xl">
            <i class="fa fa-list-ol"></i>
          </div>
        </div>
        <div class="text-2xl font-bold" id="totalLinesCount">0</div>
      </div>
      <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-gray-500 text-sm font-medium">系统指标日志</h3>
          <div class="text-blue-500 text-xl">
            <i class="fa fa-server"></i>
          </div>
        </div>
        <div class="text-2xl font-bold" id="systemLogCount">0</div>
      </div>
      <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-gray-500 text-sm font-medium">业务指标日志</h3>
          <div class="text-green-500 text-xl">
            <i class="fa fa-line-chart"></i>
          </div>
        </div>
        <div class="text-2xl font-bold" id="businessLogCount">0</div>
      </div>
      <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
        <div class="flex items-center justify-between mb-2">
          <h3 class="text-gray-500 text-sm font-medium">降载指标日志</h3>
          <div class="text-yellow-500 text-xl">
            <i class="fa fa-exclamation-triangle"></i>
          </div>
        </div>
        <div class="text-2xl font-bold" id="limiterLogCount">0</div>
      </div>
    </section>

    <!-- 主内容区 -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- 左侧：图表区域 -->
      <div class="lg:col-span-2 space-y-6">
        <!-- CPU和内存图表 -->
        <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">CPU & 内存使用率</h2>
            <div class="flex gap-2">
              <span class="inline-flex items-center gap-1 text-sm">
                <span class="w-3 h-3 rounded-full bg-primary"></span>
                <span>CPU</span>
              </span>
              <span class="inline-flex items-center gap-1 text-sm">
                <span class="w-3 h-3 rounded-full bg-secondary"></span>
                <span>内存</span>
              </span>
            </div>
          </div>
          <div class="w-full h-64">
            <div id="cpuMemChart" class="chart-container"></div>
          </div>
        </div>

        <!-- QPS图表 -->
        <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">请求 QPS</h2>
            <div class="flex gap-2">
              <span class="inline-flex items-center gap-1 text-sm">
                <span class="w-3 h-3 rounded-full bg-success"></span>
                <span>总请求</span>
              </span>
              <span class="inline-flex items-center gap-1 text-sm">
                <span class="w-3 h-3 rounded-full bg-danger"></span>
                <span>错误请求</span>
              </span>
            </div>
          </div>
          <div class="w-full h-64">
            <div id="qpsChart" class="chart-container"></div>
          </div>
        </div>

        <!-- 降载指标图表 -->
        <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">自适应降载指标</h2>
            <div class="flex gap-2">
              <span class="inline-flex items-center gap-1 text-sm">
                <span class="w-3 h-3 rounded-full bg-warning"></span>
                <span>阈值</span>
              </span>
              <span class="inline-flex items-center gap-1 text-sm">
                <span class="w-3 h-3 rounded-full bg-purple-500"></span>
                <span>当前值</span>
              </span>
            </div>
          </div>
          <div class="w-full h-64">
            <div id="limiterChart" class="chart-container"></div>
          </div>
        </div>

        <!-- 缓存命中率趋势图 -->
        <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">缓存命中率趋势</h2>
            <div class="flex gap-2">
              <span class="inline-flex items-center gap-1 text-sm">
                <span class="w-3 h-3 rounded-full bg-cyan-500"></span>
                <span>命中率</span>
              </span>
              <span class="inline-flex items-center gap-1 text-sm">
                <span class="w-3 h-3 rounded-full bg-emerald-500"></span>
                <span>缓存数</span>
              </span>
            </div>
          </div>
          <div class="w-full h-64">
            <div id="cacheHitChart" class="chart-container"></div>
          </div>
        </div>

        <!-- 系统指标综合图 -->
        <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold">系统指标综合分析</h2>
          </div>
          <div class="w-full h-80">
            <div id="systemOverviewChart" class="chart-container"></div>
          </div>
        </div>
      </div>

      <!-- 右侧：日志列表 -->
      <div class="lg:col-span-1 space-y-6">
        <!-- 日志类型过滤 -->
        <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
          <h2 class="text-lg font-semibold mb-4">日志类型过滤</h2>
          <div class="space-y-2">
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="filterAll" checked class="form-checkbox rounded text-primary focus:ring-primary">
              <span>全部日志</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="filterSystem" checked class="form-checkbox rounded text-blue-500 focus:ring-blue-500">
              <span>系统内存CPU指标</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="filterLimiter" checked class="form-checkbox rounded text-yellow-500 focus:ring-yellow-500">
              <span>自适应降载指标</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="filterBusiness" checked class="form-checkbox rounded text-green-500 focus:ring-green-500">
              <span>业务QPS指标</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
              <input type="checkbox" id="filterDbCache" checked class="form-checkbox rounded text-purple-500 focus:ring-purple-500">
              <span>数据库缓存指标</span>
            </label>
          </div>
        </div>

        <!-- 日志搜索 -->
        <div class="bg-white rounded-lg shadow-sm p-4 border border-gray-100">
          <div class="relative">
            <input type="text" id="logSearch" placeholder="搜索日志内容..." class="w-full px-4 py-2 pr-10 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary">
            <div class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-400">
              <i class="fa fa-search"></i>
            </div>
          </div>
        </div>

        <!-- 日志列表 -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-100">
          <div class="flex items-center justify-between p-4 border-b border-gray-100">
            <h2 class="text-lg font-semibold">日志详情</h2>
            <div class="text-sm text-gray-500" id="logCount">0 条日志</div>
          </div>
          <div id="logList" class="max-h-[600px] overflow-y-auto scrollbar-hide p-2">
            <div class="text-center text-gray-400 py-12">
              <div class="text-4xl mb-2"><i class="fa fa-file-text-o"></i></div>
              <p>暂无日志数据</p>
              <p class="text-sm mt-1">请上传日志文件开始分析</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 加载动画 -->
    <div id="loadingOverlay" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
      <div class="bg-white rounded-lg p-6 max-w-md w-full text-center">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary mb-4"></div>
        <h3 class="text-lg font-semibold mb-2">正在分析日志</h3>
        <p class="text-gray-500 mb-4" id="loadingMessage">请稍候，正在处理数据...</p>
        <div class="w-full bg-gray-200 rounded-full h-2.5">
          <div id="loadingProgress" class="bg-primary h-2.5 rounded-full" style="width: 0%"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // 图表实例对象 - 移到最前面确保在初始化前已定义
    const charts = {};

    // 全局数据存储
    const logData = {
      allLogs: [],
      filteredLogs: [],
      systemLogs: [],
      limiterLogs: [],
      businessLogs: [],
      dbCacheLogs: [],
      timeSeriesData: {
        timestamps: [],
        cpuUsage: [],
        memoryUsage: [],
        qps: [],
        errorQps: [],
        limiterThreshold: [],
        limiterCurrent: [],
        // 缓存相关指标
        cacheHitRate: [],
        cacheCount: []
      }
    };

    // DOM 元素
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');
    const logList = document.getElementById('logList');
    const logSearch = document.getElementById('logSearch');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingMessage = document.getElementById('loadingMessage');
    const loadingProgress = document.getElementById('loadingProgress');
    const totalLinesCount = document.getElementById('totalLinesCount');
    const systemLogCount = document.getElementById('systemLogCount');
    const businessLogCount = document.getElementById('businessLogCount');
    const limiterLogCount = document.getElementById('limiterLogCount');
    const logCount = document.getElementById('logCount');
    const clearBtn = document.getElementById('clearBtn');
    const exportBtn = document.getElementById('exportBtn');
    const filterAll = document.getElementById('filterAll');
    const filterSystem = document.getElementById('filterSystem');
    const filterLimiter = document.getElementById('filterLimiter');
    const filterBusiness = document.getElementById('filterBusiness');
    const filterDbCache = document.getElementById('filterDbCache');

    // 初始化函数
    function init() {
      // 绑定拖放事件
      dropZone.addEventListener('dragover', handleDragOver);
      dropZone.addEventListener('dragleave', handleDragLeave);
      dropZone.addEventListener('drop', handleDrop);
      dropZone.addEventListener('click', () => fileInput.click());
      fileInput.addEventListener('change', handleFileSelect);

      // 绑定其他事件
      clearBtn.addEventListener('click', clearAllData);
      exportBtn.addEventListener('click', exportAnalysisResults);
      logSearch.addEventListener('input', handleLogSearch);

      // 绑定过滤事件
      filterAll.addEventListener('change', handleFilterChange);
      filterSystem.addEventListener('change', handleFilterChange);
      filterLimiter.addEventListener('change', handleFilterChange);
      filterBusiness.addEventListener('change', handleFilterChange);
      filterDbCache.addEventListener('change', handleFilterChange);
      
      // 添加对通用日志的支持 - 事件委托处理原始日志按钮点击
      logList.addEventListener('click', function(e) {
        if (e.target.closest('.view-raw-btn')) {
          const logEntry = e.target.closest('.log-entry');
          const rawLogElement = logEntry.querySelector('.raw-log');
          
          // 切换原始日志显示状态
          if (rawLogElement.classList.contains('hidden')) {
            rawLogElement.classList.remove('hidden');
          } else {
            rawLogElement.classList.add('hidden');
          }
        }
      });

      // 初始化图表
      initCharts();
    }

    // 拖放事件处理
    function handleDragOver(e) {
      e.preventDefault();
      dropZone.classList.add('border-primary', 'bg-blue-50');
    }

    function handleDragLeave() {
      dropZone.classList.remove('border-primary', 'bg-blue-50');
    }

    function handleDrop(e) {
      e.preventDefault();
      dropZone.classList.remove('border-primary', 'bg-blue-50');
      
      if (e.dataTransfer.files.length) {
        processFiles(Array.from(e.dataTransfer.files));
      }
    }

    function handleFileSelect(e) {
      if (e.target.files.length) {
        processFiles(Array.from(e.target.files));
        // 延迟重置文件输入，避免影响首次上传
        setTimeout(() => {
          fileInput.value = '';
        }, 100);
      }
    }

    // 文件处理
    function processFiles(files) {
      showLoading();
      
      // 清空现有数据
      clearAllData(false);
      
      let processedFiles = 0;
      
      files.forEach(file => {
        const reader = new FileReader();
        
        reader.onload = function(e) {
          try {
            const content = e.target.result;
            processLogContent(content, file.name);
          } catch (error) {
            console.error('处理文件时出错:', error);
            showNotification('处理文件失败: ' + file.name, 'error');
          } finally {
            processedFiles++;
            updateLoadingProgress(processedFiles / files.length);
            
            if (processedFiles === files.length) {
              // 直接处理，不使用setTimeout避免首次上传失败
              finalizeAnalysis();
              hideLoading();
            }
          }
        };
        
        reader.readAsText(file);
      });
    }

    // 日志内容处理
    function processLogContent(content, fileName) {
      const lines = content.split('\n').filter(line => line.trim());
      
      lines.forEach((line, index) => {
        try {
          const logEntry = parseLogLine(line, fileName, index + 1);
          if (logEntry) {
            // 添加到总日志列表
            logData.allLogs.push(logEntry);
            
            // 根据类型分类
            switch (logEntry.type) {
              case 'system':
                logData.systemLogs.push(logEntry);
                break;
              case 'limiter':
                logData.limiterLogs.push(logEntry);
                break;
              case 'business':
                logData.businessLogs.push(logEntry);
                break;
              case 'dbCache':
                logData.dbCacheLogs.push(logEntry);
                break;
            }
            
            // 更新时间序列数据
            updateTimeSeriesData(logEntry);
          }
        } catch (error) {
          console.error('解析日志行时出错:', line, error);
          // 记录解析错误但继续处理其他行
          logData.allLogs.push({
            timestamp: new Date(),
            raw: line,
            type: 'error',
            message: '解析失败',
            fileName: fileName,
            lineNumber: index + 1
          });
        }
      });
    }

    // 解析单条日志行
    function parseLogLine(line, fileName, lineNumber) {
      // 增强版日志类型的正则表达式模式，更加灵活地匹配各种格式
      const patterns = {
        // 系统内存CPU指标日志 - 支持多种格式
        system: [
          /(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3})\s+.*?\[(.*?)\].*?cpu=([\d.]+)%.*?mem=([\d.]+)%/, // 标准格式
          /(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3})\s+.*?\[(.*?)\].*?mem=([\d.]+)%.*?cpu=([\d.]+)%/,  // 内存在前的格式
          /(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}\+08:00).*?CPU: (\d+)m.*?Alloc=(\d+\.\d+)Mi.*?Sys=(\d+\.\d+)Mi/ // Go-Zero特有格式
        ], 
        // 自适应降载指标日志
        limiter: [
          /(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3})\s+.*?\[(.*?)\].*?limiter.*?threshold=([\d.]+).*?current=([\d.]+)/,
          /(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3})\s+.*?\[(.*?)\].*?threshold=([\d.]+).*?current=([\d.]+).*?limiter/,
          /(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}\+08:00).*?shedding_stat \[1m\], cpu: (\d+), total: (\d+), pass: (\d+), drop: (\d+)/ // Go-Zero限流格式
        ], 
        // 业务QPS指标日志
        business: [
          /(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3})\s+.*?\[(.*?)\].*?qps=([\d.]+).*?error_qps=([\d.]+)/,
          /(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3})\s+.*?\[(.*?)\].*?error_qps=([\d.]+).*?qps=([\d.]+)/,
          /(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3})\s+.*?\[(.*?)\].*?request_count=([\d.]+).*?error_count=([\d.]+)/, // 支持请求数和错误数格式
          /(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}\+08:00).*?\(([\w-]+)\) - qps: (\d+\.\d+)\/s, drops: (\d+)/, // Go-Zero QPS格式
          /(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}\+08:00).*?\(([\w-]+)\) - qps: (\d+\.\d+)\/s, drops: (\d+), avg time: (\d+\.\d+)ms/ // Go-Zero QPS带响应时间格式
        ], 
        // 数据库缓存指标日志
        dbCache: [
          /(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3})\s+.*?\[(.*?)\].*?db.*?hit=([\d.]+)%.*?miss=([\d.]+)%/,
          /(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3})\s+.*?\[(.*?)\].*?cache.*?hit=([\d.]+)%.*?miss=([\d.]+)%/,
          /(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3})\s+.*?\[(.*?)\].*?hit_rate=([\d.]+).*?miss_rate=([\d.]+)/, // 支持小数点格式
          /(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}\+08:00).*?dbcache\(([^)]+)\) - qpm: (\d+), hit_ratio: ([\d.]+)%, hit: (\d+), miss: (\d+)/ // Go-Zero缓存格式
        ]
      };

      // 尝试匹配每种日志类型的所有模式
      for (const [type, patternList] of Object.entries(patterns)) {
        for (const pattern of patternList) {
          const match = line.match(pattern);
          if (match) {
            try {
              const timestamp = new Date(match[1]);
              let level = 'INFO'; // 默认级别为INFO
              
              // 提取应用名
              const appMatch = line.match(/app=([\w.]+)/);
              const service = appMatch ? appMatch[1].toLowerCase() : 'unknown';
              
              // 提取级别（如果存在）
              const levelMatch = line.match(/\[(.*?)\]/);
              if (levelMatch) {
                level = levelMatch[1];
              }
              
              const details = extractDetails(line);
              
              const logEntry = {
                timestamp: timestamp,
                raw: line,
                type: type,
                level: level,
                fileName: fileName,
                lineNumber: lineNumber,
                service: service,
                details: details
              };

              // 添加特定类型的指标
              switch (type) {
                case 'system':
                  // 处理Go-Zero特有系统日志格式
                  if (line.includes('CPU:') && line.includes('Alloc=')) {
                    logEntry.cpuUsage = parseFloat(match[2]) / 1000; // 从毫秒转换为秒
                    logEntry.memoryUsage = parseFloat(match[3]);
                    logEntry.systemMemory = parseFloat(match[4]);
                    
                    // 提取其他内存指标
                    const totalAllocMatch = line.match(/TotalAlloc=(\d+\.\d+)Mi/);
                    const numGCMatch = line.match(/NumGC=(\d+)/);
                    if (totalAllocMatch) logEntry.totalAlloc = parseFloat(totalAllocMatch[1]);
                    if (numGCMatch) logEntry.numGC = parseInt(numGCMatch[1]);
                  } else {
                    // 处理标准格式
                    logEntry.cpuUsage = parseFloat(match[3]);
                    logEntry.memoryUsage = parseFloat(match[4]);
                  }
                  break;
                case 'limiter':
                  // 处理Go-Zero特有限流日志格式
                  if (line.includes('shedding_stat')) {
                    logEntry.cpu = parseInt(match[2]);
                    logEntry.totalRequests = parseInt(match[3]);
                    logEntry.passRequests = parseInt(match[4]);
                    logEntry.dropRequests = parseInt(match[5]);
                    logEntry.sheddingStatus = logEntry.dropRequests > 0 ? `丢弃: ${logEntry.dropRequests}` : '正常';
                  } else {
                    // 处理标准格式
                    logEntry.threshold = parseFloat(match[3]);
                    logEntry.current = parseFloat(match[4]);
                  }
                  break;
                case 'business':
                  // 处理Go-Zero特有QPS日志格式
                  if (line.includes('qps:') && line.includes('/s')) {
                    logEntry.qpsType = match[2].toLowerCase();
                    logEntry.qps = parseFloat(match[3]);
                    logEntry.drops = parseInt(match[4]);
                    
                    // 提取响应时间指标
                    const avgTimeMatch = line.match(/avg time: (\d+\.\d+)ms/);
                    const medTimeMatch = line.match(/med: (\d+\.\d+)ms/);
                    const p90TimeMatch = line.match(/90th: (\d+\.\d+)ms/);
                    const p99TimeMatch = line.match(/99th: (\d+\.\d+)ms/);
                    const p999TimeMatch = line.match(/99\.9th: (\d+\.\d+)ms/);
                    
                    if (avgTimeMatch) logEntry.avgTime = parseFloat(avgTimeMatch[1]);
                    if (medTimeMatch) logEntry.medTime = parseFloat(medTimeMatch[1]);
                    if (p90TimeMatch) logEntry.p90Time = parseFloat(p90TimeMatch[1]);
                    if (p99TimeMatch) logEntry.p99Time = parseFloat(p99TimeMatch[1]);
                    if (p999TimeMatch) logEntry.p999Time = parseFloat(p999TimeMatch[1]);
                  } else {
                    // 处理标准格式
                    logEntry.qps = parseFloat(match[3]);
                    logEntry.errorQps = parseFloat(match[4]);
                    // 对于请求数和错误数格式，我们将其除以60以近似QPS
                    if (line.includes('request_count') && !line.includes('qps')) {
                      logEntry.qps = parseFloat(match[3]) / 60;
                      logEntry.errorQps = parseFloat(match[4]) / 60;
                    }
                  }
                  break;
                case 'dbCache':
                  // 处理Go-Zero特有缓存日志格式
                  if (line.includes('dbcache')) {
                    logEntry.cacheType = match[2];
                    logEntry.cacheQpm = parseInt(match[3]);
                    logEntry.cacheHitRatio = parseFloat(match[4]);
                    logEntry.cacheHits = parseInt(match[5]);
                    logEntry.cacheMisses = parseInt(match[6]);
                  } else {
                    // 处理标准格式
                    logEntry.hitRate = parseFloat(match[3]);
                    logEntry.missRate = parseFloat(match[4]);
                  }
                  break;
              }

              return logEntry;
            } catch (error) {
              console.warn('解析日志时出错但继续处理:', error);
              continue;
            }
          }
        }
      }

      // 提取应用名
      const appMatch = line.match(/app=([\w.]+)/);
      const service = appMatch ? appMatch[1].toLowerCase() : 'unknown';
      
      // 如果没有匹配特定类型，尝试解析为通用日志
      const timestampMatch1 = line.match(/(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3})/);
      const timestampMatch2 = line.match(/(\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}\.\d{3}\+08:00)/);
      const levelMatch = line.match(/\[(.*?)\]/);
      
      let timestamp;
      if (timestampMatch1) {
        timestamp = new Date(timestampMatch1[1]);
      } else if (timestampMatch2) {
        timestamp = new Date(timestampMatch2[1]);
      }
      
      if (timestamp) {
        return {
          timestamp: timestamp,
          raw: line,
          type: 'general',
          level: levelMatch ? levelMatch[1] : 'INFO',
          service: service,
          fileName: fileName,
          lineNumber: lineNumber,
          details: extractDetails(line)
        };
      }

      // 无法识别的日志格式，标记为未知
      return {
        timestamp: new Date(),
        raw: line,
        type: 'unknown',
        level: 'INFO',
        service: service,
        fileName: fileName,
        lineNumber: lineNumber,
        details: line.substring(0, 100) + (line.length > 100 ? '...' : '')
      };
    }

    // 从日志行中提取详细信息
    function extractDetails(line) {
      // 尝试提取所有key=value格式的信息
      const keyValuePairs = [];
      const matches = line.matchAll(/([\w_]+)=([^\s,]+)/g);
      
      for (const match of matches) {
        keyValuePairs.push(`${match[1]}=${match[2]}`);
      }
      
      if (keyValuePairs.length > 0) {
        return keyValuePairs.join(', ');
      }
      
      // 如果没有key=value格式，返回行的后半部分
      const timestampEnd = line.indexOf(']') + 1;
      if (timestampEnd > 0 && timestampEnd < line.length) {
        return line.substring(timestampEnd).trim().substring(0, 200) + (line.length - timestampEnd > 200 ? '...' : '');
      }
      
      return line.substring(0, 200) + (line.length > 200 ? '...' : '');
    }

    // 更新时间序列数据
    function updateTimeSeriesData(logEntry) {
      try {
        // 确保logData和timeSeriesData对象存在
        if (!logData) {
          logData = { allLogs: [], filteredLogs: [], systemLogs: [], limiterLogs: [], businessLogs: [], dbCacheLogs: [] };
        }
        
        if (!logData.timeSeriesData) {
          logData.timeSeriesData = {
            timestamps: [],
            cpuUsage: [],
            memoryUsage: [],
            qps: [],
            errorQps: [],
            limiterThreshold: [],
            limiterCurrent: [],
            cacheHitRate: [],
            cacheCount: []
          };
        }
      
      // 确保所有需要的数组都已初始化
      const requiredArrays = ['timestamps', 'cpuUsage', 'memoryUsage', 'qps', 'errorQps', 'limiterThreshold', 'limiterCurrent', 'cacheHitRate', 'cacheCount'];
      for (const key of requiredArrays) {
        if (!Array.isArray(logData.timeSeriesData[key])) {
          logData.timeSeriesData[key] = [];
        }
      }
      
        // 简化数据处理，直接添加新数据点，确保所有数组长度一致
        const timestamp = logEntry.timestamp.toLocaleTimeString();
        logData.timeSeriesData.timestamps.push(timestamp);
        
        // 先初始化所有数据为null，确保数组长度一致
        logData.timeSeriesData.cpuUsage.push(null);
        logData.timeSeriesData.memoryUsage.push(null);
        logData.timeSeriesData.qps.push(null);
        logData.timeSeriesData.errorQps.push(null);
        logData.timeSeriesData.limiterThreshold.push(null);
        logData.timeSeriesData.limiterCurrent.push(null);
        logData.timeSeriesData.cacheHitRate.push(null);
        logData.timeSeriesData.cacheCount.push(null);
        
        // 获取当前索引位置
        const currentIndex = logData.timeSeriesData.timestamps.length - 1;
        
        // 根据日志类型设置相应数据
        switch (logEntry.type) {
          case 'system':
            // 使用正确的字段名，添加多种格式支持
            if (logEntry.cpuUsage !== undefined) {
              logData.timeSeriesData.cpuUsage[currentIndex] = parseFloat(logEntry.cpuUsage);
            } else if (logEntry.cpu !== undefined) {
              logData.timeSeriesData.cpuUsage[currentIndex] = parseFloat(logEntry.cpu);
            }
            if (logEntry.memoryUsage !== undefined) {
              logData.timeSeriesData.memoryUsage[currentIndex] = parseFloat(logEntry.memoryUsage);
            } else if (logEntry.memory !== undefined) {
              logData.timeSeriesData.memoryUsage[currentIndex] = parseFloat(logEntry.memory);
            }
            break;
          case 'business':
            // 处理不同格式的QPS数据
            if (logEntry.qps !== undefined) {
              logData.timeSeriesData.qps[currentIndex] = parseFloat(logEntry.qps);
            } else if (logEntry.request_count !== undefined) {
              logData.timeSeriesData.qps[currentIndex] = parseFloat(logEntry.request_count);
            }
            // 处理不同格式的错误率数据
            if (logEntry.errorQps !== undefined) {
              logData.timeSeriesData.errorQps[currentIndex] = parseFloat(logEntry.errorQps);
            } else if (logEntry.error_count !== undefined) {
              logData.timeSeriesData.errorQps[currentIndex] = parseFloat(logEntry.error_count);
            } else if (logEntry.drops !== undefined) {
              logData.timeSeriesData.errorQps[currentIndex] = parseFloat(logEntry.drops);
            }
            break;
          case 'limiter':
            // 处理不同格式的限流数据
            if (logEntry.threshold !== undefined) {
              logData.timeSeriesData.limiterThreshold[currentIndex] = parseFloat(logEntry.threshold);
            } else if (logEntry.total !== undefined) {
              logData.timeSeriesData.limiterThreshold[currentIndex] = parseFloat(logEntry.total);
            }
            if (logEntry.current !== undefined) {
              logData.timeSeriesData.limiterCurrent[currentIndex] = parseFloat(logEntry.current);
            } else if (logEntry.pass !== undefined) {
              logData.timeSeriesData.limiterCurrent[currentIndex] = parseFloat(logEntry.pass);
            } else if (logEntry.cpu !== undefined) {
              // Go-Zero格式的CPU负载数据
              logData.timeSeriesData.limiterCurrent[currentIndex] = parseFloat(logEntry.cpu);
            }
            break;
          case 'dbCache':
            // 处理不同格式的缓存命中率数据
            if (logEntry.cacheHitRatio !== undefined) {
              logData.timeSeriesData.cacheHitRate[currentIndex] = parseFloat(logEntry.cacheHitRatio);
            } else if (logEntry.hit_rate !== undefined) {
              logData.timeSeriesData.cacheHitRate[currentIndex] = parseFloat(logEntry.hit_rate);
            } else if (logEntry.hitRate !== undefined) {
              logData.timeSeriesData.cacheHitRate[currentIndex] = parseFloat(logEntry.hitRate);
            }
            // 处理缓存计数数据
            if (logEntry.cacheQpm !== undefined) {
              logData.timeSeriesData.cacheCount[currentIndex] = parseFloat(logEntry.cacheQpm);
            } else if (logEntry.qpm !== undefined) {
              logData.timeSeriesData.cacheCount[currentIndex] = parseFloat(logEntry.qpm);
            }
            break;
        }
        
        // 限制数据点数
        limitTimeSeriesData();
      } catch (error) {
        console.error('更新时间序列数据时出错:', error, '日志条目:', logEntry);
        // 即使出错也尝试确保数据一致性
        if (logData && logData.timeSeriesData) {
          const requiredArrays = ['timestamps', 'cpuUsage', 'memoryUsage', 'qps', 'errorQps', 'limiterThreshold', 'limiterCurrent', 'cacheHitRate', 'cacheCount'];
          const maxLength = Math.max(...requiredArrays.map(key => logData.timeSeriesData[key]?.length || 0));
          requiredArrays.forEach(key => {
            if (!Array.isArray(logData.timeSeriesData[key])) {
              logData.timeSeriesData[key] = [];
            }
            while (logData.timeSeriesData[key].length < maxLength) {
              logData.timeSeriesData[key].push(null);
            }
          });
        }
      }
    }

    // 限制时间序列数据点数
    function limitTimeSeriesData(maxPoints = 100) {
      // 确保logData.timeSeriesData存在
      if (!logData.timeSeriesData) {
        logData.timeSeriesData = { timestamps: [] };
        return;
      }
      
      // 确保所有数组属性存在且为数组类型
      const requiredArrays = ['timestamps', 'cpuUsage', 'memoryUsage', 'qps', 'errorQps', 'limiterThreshold', 'limiterCurrent', 'cacheHitRate', 'cacheCount'];
      requiredArrays.forEach(key => {
        if (!Array.isArray(logData.timeSeriesData[key])) {
          logData.timeSeriesData[key] = [];
        }
      });
      
      if (logData.timeSeriesData.timestamps.length > maxPoints) {
        requiredArrays.forEach(key => {
          if (Array.isArray(logData.timeSeriesData[key])) {
            logData.timeSeriesData[key] = logData.timeSeriesData[key].slice(-maxPoints);
          }
        });
      }
    }


    
    // 计算时间标签间隔
    function calculateTimeLabelInterval(times) {
      if (!times || times.length <= 10) return 0; // 10个以下数据点时不跳过
      const interval = Math.ceil(times.length / 10); // 确保最多显示10个标签
      return interval > 1 ? interval : 0;
    }

    // 计算初始缩放比例
    function calculateInitialZoom(dataLength) {
      if (dataLength <= 100) return 0;
      if (dataLength <= 500) return Math.max(0, 100 - 2000 / dataLength);
      return Math.max(0, 100 - 1000 / (dataLength / 20));
    }

    // 初始化图表
    function initCharts() {
      // 初始化CPU和内存图表
      const cpuMemChartDom = document.getElementById('cpuMemChart');
      charts['cpuMem'] = echarts.init(cpuMemChartDom);
      
      // 初始化QPS图表
      const qpsChartDom = document.getElementById('qpsChart');
      charts['qps'] = echarts.init(qpsChartDom);
      
      // 初始化降载指标图表
      const limiterChartDom = document.getElementById('limiterChart');
      charts['limiter'] = echarts.init(limiterChartDom);
      
      // 初始化缓存命中率趋势图
      const cacheHitChartDom = document.getElementById('cacheHitChart');
      charts['cacheHit'] = echarts.init(cacheHitChartDom);
      
      // 初始化系统指标综合图
      const systemOverviewChartDom = document.getElementById('systemOverviewChart');
      charts['systemOverview'] = echarts.init(systemOverviewChartDom);
      
      // 添加窗口大小变化监听
      window.addEventListener('resize', function() {
        for (const chart of Object.values(charts)) {
          chart.resize();
        }
      });
    }

    // 获取通用图表配置
    function getChartOptions(title) {
      return {
        backgroundColor: 'transparent',
        tooltip: {
          trigger: 'axis',
          backgroundColor: 'rgba(255, 255, 255, 0.95)',
          borderColor: '#E0E6ED',
          borderWidth: 1,
          borderRadius: 8,
          padding: [12, 16],
          textStyle: {
            color: '#1D2129',
            fontSize: 12
          },
          // 添加阴影效果
          shadowColor: 'rgba(0, 0, 0, 0.1)',
          shadowBlur: 10,
          shadowOffsetX: 0,
          shadowOffsetY: 4
        },
        legend: {
          data: [],
          top: 0,
          left: 'center',
          textStyle: {
            color: '#4E5969',
            fontSize: 12,
            fontWeight: 500
          },
          itemWidth: 14,
          itemHeight: 14,
          padding: [0, 20]
        },
        grid: {
          left: '5%',
          right: '5%',
          bottom: '15%',
          top: '20%',
          containLabel: true
        },
        xAxis: {
          type: 'category',
          data: [],
          axisLine: {
            lineStyle: {
              color: '#E5E6EB'
            }
          },
          axisLabel: {
            color: '#4E5969',
            rotate: 45,
            interval: 0
          },
          // 显示刻度线
          axisTick: {
            show: true,
            lineStyle: {
              color: '#E5E6EB'
            }
          },
          // 显示垂直分割线，提高可读性
          splitLine: {
            show: true,
            lineStyle: {
              color: '#F2F3F5',
              type: 'dashed'
            }
          }
        },
        yAxis: {
          type: 'value',
          min: 0,
          axisLine: {
            lineStyle: {
              color: '#E5E6EB'
            }
          },
          axisLabel: {
            color: '#4E5969'
          },
          splitLine: {
            lineStyle: {
              color: '#F2F3F5',
              type: 'dashed'
            }
          }
        },
        // 时间滑动块
        dataZoom: [
          {
            type: 'inside',
            xAxisIndex: 0,
            start: 0,
            end: 100,
            zoomOnMouseWheel: true,
            moveOnMouseMove: true,
            moveOnMouseWheel: false
          },
          {
            type: 'slider',
            xAxisIndex: 0,
            bottom: 5,
            start: 0,
            end: 100,
            height: 20,
            backgroundColor: '#F2F3F5',
            fillerColor: 'rgba(59, 130, 246, 0.2)',
            handleStyle: {
              color: '#3b82f6',
              width: 14,
              height: 24,
              borderRadius: 7,
              shadowColor: 'rgba(59, 130, 246, 0.4)',
              shadowBlur: 6
            },
            borderColor: '#E5E6EB',
            borderWidth: 1,
            zoomLock: false,
            showDetail: true,
            showDataShadow: 'auto'
          }
        ],
        // 增强的动画效果
        animation: true,
        animationDuration: 1500,
        animationEasing: 'cubicOut',
        animationDelay: function (idx) {
          return idx * 10;
        },
        animationDurationUpdate: 1000
      };
    }

    // 更新CPU和内存图表
    function updateCpuMemChart() {
      const chart = charts['cpuMem'];
      if (!chart) return;

      // 确保logData和timeSeriesData对象存在
      if (!logData || !logData.timeSeriesData) {
        console.error('logData或timeSeriesData未定义');
        return;
      }

      // 确保所有需要的数组都存在且为数组类型
      const timestamps = Array.isArray(logData.timeSeriesData.timestamps) ? logData.timeSeriesData.timestamps : [];
      const cpuData = Array.isArray(logData.timeSeriesData.cpuUsage) ? logData.timeSeriesData.cpuUsage : [];
      const memoryData = Array.isArray(logData.timeSeriesData.memoryUsage) ? logData.timeSeriesData.memoryUsage : [];

      // 处理数据，确保不会出现索引越界问题
      const validData = [];
      for (let i = 0; i < timestamps.length; i++) {
        const timestamp = timestamps[i];
        const cpu = i < cpuData.length && cpuData[i] !== undefined && cpuData[i] !== null ? cpuData[i] : null;
        const memory = i < memoryData.length && memoryData[i] !== undefined && memoryData[i] !== null ? memoryData[i] : null;
        
        if (timestamp !== undefined && timestamp !== null && (cpu !== null || memory !== null)) {
          validData.push({ timestamp, cpu, memory });
        }
      }

      // 如果没有有效数据，不更新图表
      if (validData.length === 0) {
        console.warn('没有找到有效的CPU和内存使用率数据');
        return;
      }

      const filteredTimestamps = validData.map(item => item.timestamp);
      const filteredCpuData = validData.map(item => item.cpu);
      const filteredMemoryData = validData.map(item => item.memory);

      const option = getChartOptions('CPU & 内存使用率');
      
      option.legend.data = ['CPU使用率(%)', '内存使用率(%)'];
      option.xAxis.data = filteredTimestamps;
      option.xAxis.axisLabel.interval = calculateTimeLabelInterval(filteredTimestamps);
      option.dataZoom[0].start = calculateInitialZoom(filteredTimestamps.length);
      option.dataZoom[1].start = calculateInitialZoom(filteredTimestamps.length);
      
      option.series = [
        {
          name: 'CPU使用率(%)',
          type: 'line',
          data: filteredCpuData,
          symbol: 'circle',
          symbolSize: 6,
          symbolHoverSize: 10,
          smooth: true,
          smoothMonotone: 'x',
          lineStyle: {
            width: 4,
            color: '#3b82f6',
            shadowColor: 'rgba(59, 130, 246, 0.4)',
            shadowBlur: 10,
            shadowOffsetY: 5
          },
          itemStyle: {
            color: '#3b82f6',
            borderColor: '#fff',
            borderWidth: 2,
            shadowColor: 'rgba(59, 130, 246, 0.5)',
            shadowBlur: 6
          },
          emphasis: {
            focus: 'series',
            itemStyle: {
              shadowBlur: 10,
              shadowColor: 'rgba(59, 130, 246, 0.6)'
            }
          },
          areaStyle: {
            color: {
              type: 'linear',
              x: 0,
              y: 0,
              x2: 0,
              y2: 1,
              colorStops: [{
                offset: 0, color: 'rgba(59, 130, 246, 0.3)'
              }, {
                offset: 1, color: 'rgba(59, 130, 246, 0.02)'
              }]
            }
          },
          markLine: {
            silent: true,
            lineStyle: {
              color: '#FF4D4F',
              type: 'dashed'
            },
            data: [
              {
                yAxis: 80,
                label: {
                  formatter: '警告阈值',
                  position: 'insideEndTop'
                }
              }
            ]
          }
        },
        {
          name: '内存使用率(%)',
          type: 'line',
          data: filteredMemoryData,
          symbol: 'circle',
          symbolSize: 6,
          symbolHoverSize: 10,
          smooth: true,
          smoothMonotone: 'x',
          lineStyle: {
            width: 4,
            color: '#6366f1',
            shadowColor: 'rgba(99, 102, 241, 0.4)',
            shadowBlur: 10,
            shadowOffsetY: 5
          },
          itemStyle: {
            color: '#6366f1',
            borderColor: '#fff',
            borderWidth: 2,
            shadowColor: 'rgba(99, 102, 241, 0.5)',
            shadowBlur: 6
          },
          emphasis: {
            focus: 'series',
            itemStyle: {
              shadowBlur: 10,
              shadowColor: 'rgba(99, 102, 241, 0.6)'
            }
          },
          areaStyle: {
            color: {
              type: 'linear',
              x: 0,
              y: 0,
              x2: 0,
              y2: 1,
              colorStops: [{
                offset: 0, color: 'rgba(99, 102, 241, 0.3)'
              }, {
                offset: 1, color: 'rgba(99, 102, 241, 0.02)'
              }]
            }
          },
          markLine: {
            silent: true,
            lineStyle: {
              color: '#FF4D4F',
              type: 'dashed'
            },
            data: [
              {
                yAxis: 80,
                label: {
                  formatter: '警告阈值',
                  position: 'insideEndTop'
                }
              }
            ]
          }
        }
      ];

      chart.setOption(option);
    }

    // 更新QPS图表
    function updateQpsChart() {
      const chart = charts['qps'];
      if (!chart) return;

      // 确保logData和timeSeriesData对象存在
      if (!logData || !logData.timeSeriesData) {
        console.error('logData或timeSeriesData未定义');
        return;
      }

      // 确保所有需要的数组都存在且为数组类型
      const timestamps = Array.isArray(logData.timeSeriesData.timestamps) ? logData.timeSeriesData.timestamps : [];
      const qpsData = Array.isArray(logData.timeSeriesData.qps) ? logData.timeSeriesData.qps : [];
      const errorQpsData = Array.isArray(logData.timeSeriesData.errorQps) ? logData.timeSeriesData.errorQps : [];

      // 处理数据，确保不会出现索引越界问题
      const validData = [];
      for (let i = 0; i < timestamps.length; i++) {
        const timestamp = timestamps[i];
        const qps = i < qpsData.length && qpsData[i] !== undefined && qpsData[i] !== null ? qpsData[i] : null;
        const errorQps = i < errorQpsData.length && errorQpsData[i] !== undefined && errorQpsData[i] !== null ? errorQpsData[i] : null;
        
        if (timestamp !== undefined && timestamp !== null && (qps !== null || errorQps !== null)) {
          validData.push({ timestamp, qps, errorQps });
        }
      }

      // 如果没有有效数据，不更新图表
      if (validData.length === 0) {
        console.warn('没有找到有效的QPS数据');
        return;
      }

      const filteredTimestamps = validData.map(item => item.timestamp);
      const filteredQpsData = validData.map(item => item.qps);
      const filteredErrorQpsData = validData.map(item => item.errorQps);

      const option = getChartOptions('请求 QPS');
      
      option.legend.data = ['总请求QPS', '错误请求QPS'];
      option.xAxis.data = filteredTimestamps;
      option.xAxis.axisLabel.interval = calculateTimeLabelInterval(filteredTimestamps);
      option.dataZoom[0].start = calculateInitialZoom(filteredTimestamps.length);
      option.dataZoom[1].start = calculateInitialZoom(filteredTimestamps.length);
      
      // 双Y轴配置
      option.yAxis = [
        {
          type: 'value',
          name: 'QPS',
          min: 0,
          axisLine: { lineStyle: { color: '#10b981' } },
          axisLabel: { color: '#4E5969' },
          splitLine: {
            lineStyle: {
              color: '#F2F3F5',
              type: 'dashed'
            }
          }
        },
        {
          type: 'value',
          name: '错误QPS',
          position: 'right',
          min: 0,
          axisLine: { lineStyle: { color: '#ef4444' } },
          axisLabel: { color: '#ef4444' },
          splitLine: { show: false }
        }
      ];
      
      option.series = [
        {
          name: '总请求QPS',
          type: 'line',
          data: filteredQpsData,
          symbol: 'circle',
          symbolSize: 6,
          symbolHoverSize: 10,
          smooth: true,
          smoothMonotone: 'x',
          lineStyle: {
            width: 4,
            color: '#10b981',
            shadowColor: 'rgba(16, 185, 129, 0.4)',
            shadowBlur: 10,
            shadowOffsetY: 5
          },
          itemStyle: {
            color: '#10b981',
            borderColor: '#fff',
            borderWidth: 2,
            shadowColor: 'rgba(16, 185, 129, 0.5)',
            shadowBlur: 6
          },
          emphasis: {
            focus: 'series',
            itemStyle: {
              shadowBlur: 10,
              shadowColor: 'rgba(16, 185, 129, 0.6)'
            }
          },
          areaStyle: {
            color: {
              type: 'linear',
              x: 0,
              y: 0,
              x2: 0,
              y2: 1,
              colorStops: [{
                offset: 0, color: 'rgba(16, 185, 129, 0.3)'
              }, {
                offset: 1, color: 'rgba(16, 185, 129, 0.02)'
              }]
            }
          }
        },
        {
          name: '错误请求QPS',
          type: 'bar',
          yAxisIndex: 1,
          data: filteredErrorQpsData,
          itemStyle: {
            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
              { offset: 0, color: '#ef4444' },
              { offset: 1, color: '#f87171' }
            ])
          },
          barWidth: '40%',
          emphasis: {
            focus: 'series',
            itemStyle: {
              color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                { offset: 0, color: '#dc2626' },
                { offset: 1, color: '#ef4444' }
              ])
            }
          }
        }
      ];

      chart.setOption(option);
    }

    // 更新降载指标图表
    function updateLimiterChart() {
      const chart = charts['limiter'];
      if (!chart) return;

      // 确保logData和timeSeriesData对象存在
      if (!logData || !logData.timeSeriesData) {
        console.error('logData或timeSeriesData未定义');
        return;
      }

      // 确保所有需要的数组都存在且为数组类型
      const timestamps = Array.isArray(logData.timeSeriesData.timestamps) ? logData.timeSeriesData.timestamps : [];
      const thresholdData = Array.isArray(logData.timeSeriesData.limiterThreshold) ? logData.timeSeriesData.limiterThreshold : [];
      const currentData = Array.isArray(logData.timeSeriesData.limiterCurrent) ? logData.timeSeriesData.limiterCurrent : [];

      // 处理数据，确保不会出现索引越界问题
      const validData = [];
      for (let i = 0; i < timestamps.length; i++) {
        const timestamp = timestamps[i];
        const threshold = i < thresholdData.length && thresholdData[i] !== undefined && thresholdData[i] !== null ? thresholdData[i] : null;
        const current = i < currentData.length && currentData[i] !== undefined && currentData[i] !== null ? currentData[i] : null;
        
        if (timestamp !== undefined && timestamp !== null && (threshold !== null || current !== null)) {
          validData.push({ timestamp, threshold, current });
        }
      }

      // 如果没有有效数据，不更新图表
      if (validData.length === 0) {
        console.warn('没有找到有效的降载指标数据');
        return;
      }

      const filteredTimestamps = validData.map(item => item.timestamp);
      const filteredThresholdData = validData.map(item => item.threshold);
      const filteredCurrentData = validData.map(item => item.current);

      const option = getChartOptions('自适应降载指标');
      
      option.legend.data = ['降载阈值', '当前值'];
      option.xAxis.data = filteredTimestamps;
      option.xAxis.axisLabel.interval = calculateTimeLabelInterval(filteredTimestamps);
      option.dataZoom[0].start = calculateInitialZoom(filteredTimestamps.length);
      option.dataZoom[1].start = calculateInitialZoom(filteredTimestamps.length);
      
      option.series = [
        {
          name: '降载阈值',
          type: 'line',
          data: filteredThresholdData,
          symbol: 'circle',
          symbolSize: 6,
          symbolHoverSize: 10,
          smooth: true,
          smoothMonotone: 'x',
          lineStyle: {
            width: 4,
            color: '#f59e0b',
            shadowColor: 'rgba(245, 158, 11, 0.4)',
            shadowBlur: 10,
            shadowOffsetY: 5,
            type: 'dashed'
          },
          itemStyle: {
            color: '#f59e0b',
            borderColor: '#fff',
            borderWidth: 2,
            shadowColor: 'rgba(245, 158, 11, 0.5)',
            shadowBlur: 6
          },
          emphasis: {
            focus: 'series',
            itemStyle: {
              shadowBlur: 10,
              shadowColor: 'rgba(245, 158, 11, 0.6)'
            }
          },
          areaStyle: {
            color: {
              type: 'linear',
              x: 0,
              y: 0,
              x2: 0,
              y2: 1,
              colorStops: [{
                offset: 0, color: 'rgba(245, 158, 11, 0.1)'
              }, {
                offset: 1, color: 'rgba(245, 158, 11, 0.01)'
              }]
            }
          }
        },
        {
          name: '当前值',
          type: 'line',
          data: filteredCurrentData,
          symbol: 'circle',
          symbolSize: 6,
          symbolHoverSize: 10,
          smooth: true,
          smoothMonotone: 'x',
          lineStyle: {
            width: 4,
            color: '#8b5cf6',
            shadowColor: 'rgba(139, 92, 246, 0.4)',
            shadowBlur: 10,
            shadowOffsetY: 5
          },
          itemStyle: {
            color: '#8b5cf6',
            borderColor: '#fff',
            borderWidth: 2,
            shadowColor: 'rgba(139, 92, 246, 0.5)',
            shadowBlur: 6
          },
          emphasis: {
            focus: 'series',
            itemStyle: {
              shadowBlur: 10,
              shadowColor: 'rgba(139, 92, 246, 0.6)'
            }
          },
          areaStyle: {
            color: {
              type: 'linear',
              x: 0,
              y: 0,
              x2: 0,
              y2: 1,
              colorStops: [{
                offset: 0, color: 'rgba(139, 92, 246, 0.3)'
              }, {
                offset: 1, color: 'rgba(139, 92, 246, 0.02)'
              }]
            }
          },
          markArea: {
            silent: true,
            itemStyle: {
              color: 'rgba(239, 68, 68, 0.1)'
            },
            data: [
              [
                {
                  name: '超过阈值',
                  xAxis: 'min',
                  yAxis: 'threshold'
                },
                {
                  xAxis: 'max',
                  yAxis: 'max'
                }
              ]
            ]
          }
        }
      ];

      chart.setOption(option);
    }

    // 更新缓存命中率趋势图
    function updateCacheHitChart() {
      const chart = charts['cacheHit'];
      if (!chart) return;

      // 确保logData和timeSeriesData对象存在
      if (!logData || !logData.timeSeriesData) {
        console.error('logData或timeSeriesData未定义');
        return;
      }

      // 确保所有需要的数组都存在且为数组类型
      const timestamps = Array.isArray(logData.timeSeriesData.timestamps) ? logData.timeSeriesData.timestamps : [];
      const cacheHitRateData = Array.isArray(logData.timeSeriesData.cacheHitRate) ? logData.timeSeriesData.cacheHitRate : [];
      const cacheCountData = Array.isArray(logData.timeSeriesData.cacheCount) ? logData.timeSeriesData.cacheCount : [];

      // 处理数据，确保不会出现索引越界问题
      const validData = [];
      for (let i = 0; i < timestamps.length; i++) {
        const timestamp = timestamps[i];
        const hitRate = i < cacheHitRateData.length && cacheHitRateData[i] !== undefined && cacheHitRateData[i] !== null ? cacheHitRateData[i] : null;
        const count = i < cacheCountData.length && cacheCountData[i] !== undefined && cacheCountData[i] !== null ? cacheCountData[i] : null;
        
        if (timestamp !== undefined && timestamp !== null && (hitRate !== null || count !== null)) {
          validData.push({ timestamp, hitRate, count });
        }
      }

      // 如果没有有效数据，不更新图表
      if (validData.length === 0) {
        console.warn('没有找到有效的缓存命中率数据');
        return;
      }

      const filteredTimestamps = validData.map(item => item.timestamp);
      const filteredHitRateData = validData.map(item => item.hitRate);
      const filteredCountData = validData.map(item => item.count);

      const option = getChartOptions('缓存命中率趋势');
      
      option.legend.data = ['缓存命中率(%)', '缓存操作次数'];
      option.xAxis.data = filteredTimestamps;
      option.xAxis.axisLabel.interval = calculateTimeLabelInterval(filteredTimestamps);
      option.dataZoom[0].start = calculateInitialZoom(filteredTimestamps.length);
      option.dataZoom[1].start = calculateInitialZoom(filteredTimestamps.length);
      
      // 双Y轴配置
      option.yAxis = [
        {
          type: 'value',
          name: '命中率(%)',
          min: 0,
          max: 100,
          axisLine: { lineStyle: { color: '#14b8a6' } },
          axisLabel: { color: '#4E5969', formatter: '{value}%' },
          splitLine: {
            lineStyle: {
              color: '#F2F3F5',
              type: 'dashed'
            }
          }
        },
        {
          type: 'value',
          name: '操作次数',
          position: 'right',
          min: 0,
          axisLine: { lineStyle: { color: '#f59e0b' } },
          axisLabel: { color: '#f59e0b' },
          splitLine: { show: false }
        }
      ];
      
      option.series = [
        {
          name: '缓存命中率(%)',
          type: 'line',
          data: filteredHitRateData,
          symbol: 'circle',
          symbolSize: 6,
          symbolHoverSize: 10,
          smooth: true,
          smoothMonotone: 'x',
          lineStyle: {
            width: 4,
            color: '#14b8a6',
            shadowColor: 'rgba(20, 184, 166, 0.4)',
            shadowBlur: 10,
            shadowOffsetY: 5
          },
          itemStyle: {
            color: '#14b8a6',
            borderColor: '#fff',
            borderWidth: 2,
            shadowColor: 'rgba(20, 184, 166, 0.5)',
            shadowBlur: 6
          },
          emphasis: {
            focus: 'series',
            itemStyle: {
              shadowBlur: 10,
              shadowColor: 'rgba(20, 184, 166, 0.6)'
            }
          },
          areaStyle: {
            color: {
              type: 'linear',
              x: 0,
              y: 0,
              x2: 0,
              y2: 1,
              colorStops: [{
                offset: 0, color: 'rgba(20, 184, 166, 0.3)'
              }, {
                offset: 1, color: 'rgba(20, 184, 166, 0.02)'
              }]
            }
          },
          markLine: {
            silent: true,
            lineStyle: {
              color: '#FF4D4F',
              type: 'dashed'
            },
            data: [
              {
                yAxis: 70,
                label: {
                  formatter: '低命中率阈值',
                  position: 'insideEndTop'
                }
              }
            ]
          }
        },
        {
          name: '缓存操作次数',
          type: 'bar',
          yAxisIndex: 1,
          data: filteredCountData,
          itemStyle: {
            color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
              { offset: 0, color: '#f59e0b' },
              { offset: 1, color: '#fbbf24' }
            ])
          },
          barWidth: '40%',
          emphasis: {
            focus: 'series',
            itemStyle: {
              color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                { offset: 0, color: '#d97706' },
                { offset: 1, color: '#f59e0b' }
              ])
            }
          }
        }
      ];

      chart.setOption(option);
    }

    // 更新系统指标综合图
    function updateSystemOverviewChart() {
      const chart = charts['systemOverview'];
      if (!chart) return;

      // 确保logData和timeSeriesData对象存在
      if (!logData || !logData.timeSeriesData) {
        console.error('logData或timeSeriesData未定义');
        return;
      }

      // 确保所有需要的数组都存在且为数组类型
      const timestamps = Array.isArray(logData.timeSeriesData.timestamps) ? logData.timeSeriesData.timestamps : [];
      const cpuData = Array.isArray(logData.timeSeriesData.cpuUsage) ? logData.timeSeriesData.cpuUsage : [];
      const memoryData = Array.isArray(logData.timeSeriesData.memoryUsage) ? logData.timeSeriesData.memoryUsage : [];
      const systemLogs = Array.isArray(logData.systemLogs) ? logData.systemLogs : [];

      // 从日志中提取其他系统指标
      let totalAllocData = [];
      let gcCountData = [];
      let systemMemoryData = [];
      
      // 同步时间戳，确保数据点对应
      for (let i = 0; i < timestamps.length; i++) {
        const timestamp = timestamps[i];
        if (timestamp === undefined || timestamp === null) {
          totalAllocData.push(null);
          gcCountData.push(null);
          systemMemoryData.push(null);
          continue;
        }
        
        // 查找对应时间戳的系统日志
        const systemLog = systemLogs.find(log => 
          log && log.timestamp && log.timestamp.toLocaleTimeString() === timestamp && 
          log.totalAlloc !== undefined
        );
        
        if (systemLog) {
          totalAllocData.push(systemLog.totalAlloc);
          gcCountData.push(systemLog.numGC || 0);
          systemMemoryData.push(systemLog.systemMemory || 0);
        } else {
          totalAllocData.push(null);
          gcCountData.push(null);
          systemMemoryData.push(null);
        }
      }

      // 处理数据，确保不会出现索引越界问题
      const validData = [];
      for (let i = 0; i < timestamps.length; i++) {
        const timestamp = timestamps[i];
        const cpu = i < cpuData.length && cpuData[i] !== undefined && cpuData[i] !== null ? cpuData[i] : null;
        const memory = i < memoryData.length && memoryData[i] !== undefined && memoryData[i] !== null ? memoryData[i] : null;
        const totalAlloc = i < totalAllocData.length && totalAllocData[i] !== undefined && totalAllocData[i] !== null ? totalAllocData[i] : null;
        const gcCount = i < gcCountData.length && gcCountData[i] !== undefined && gcCountData[i] !== null ? gcCountData[i] : null;
        
        if (timestamp !== undefined && timestamp !== null && (cpu !== null || memory !== null || totalAlloc !== null || gcCount !== null)) {
          validData.push({ timestamp, cpu, memory, totalAlloc, gcCount });
        }
      }

      // 如果没有有效数据，不更新图表
      if (validData.length === 0) {
        console.warn('没有找到有效的系统指标数据');
        return;
      }

      const filteredTimestamps = validData.map(item => item.timestamp);
      const filteredCpuData = validData.map(item => item.cpu);
      const filteredMemoryData = validData.map(item => item.memory);
      const filteredTotalAllocData = validData.map(item => item.totalAlloc);
      const filteredGcCountData = validData.map(item => item.gcCount);

      const option = getChartOptions('系统指标综合');
      
      option.legend.data = ['CPU使用率(%)', '内存使用率(%)', '总内存分配(MiB)', 'GC次数'];
      option.xAxis.data = filteredTimestamps;
      option.xAxis.axisLabel.interval = calculateTimeLabelInterval(filteredTimestamps);
      option.dataZoom[0].start = calculateInitialZoom(filteredTimestamps.length);
      option.dataZoom[1].start = calculateInitialZoom(filteredTimestamps.length);
      
      // 多Y轴配置
      option.yAxis = [
        {
          type: 'value',
          name: '使用率(%)',
          min: 0,
          max: 100,
          axisLine: { lineStyle: { color: '#3b82f6' } },
          axisLabel: { color: '#4E5969', formatter: '{value}%' },
          splitLine: {
            lineStyle: {
              color: '#F2F3F5',
              type: 'dashed'
            }
          }
        },
        {
          type: 'value',
          name: '内存(MiB)',
          position: 'right',
          min: 0,
          axisLine: { lineStyle: { color: '#6366f1' } },
          axisLabel: { color: '#6366f1' },
          splitLine: { show: false }
        },
        {
          type: 'value',
          name: 'GC次数',
          position: 'right',
          min: 0,
          offset: 80,
          axisLine: { lineStyle: { color: '#8b5cf6' } },
          axisLabel: { color: '#8b5cf6' },
          splitLine: { show: false }
        }
      ];
      
      option.series = [
        {
          name: 'CPU使用率(%)',
          type: 'line',
          data: filteredCpuData,
          symbol: 'circle',
          symbolSize: 4,
          symbolHoverSize: 8,
          smooth: true,
          lineStyle: {
            width: 3,
            color: '#3b82f6'
          },
          itemStyle: {
            color: '#3b82f6'
          }
        },
        {
          name: '内存使用率(%)',
          type: 'line',
          data: filteredMemoryData,
          symbol: 'circle',
          symbolSize: 4,
          symbolHoverSize: 8,
          smooth: true,
          lineStyle: {
            width: 3,
            color: '#6366f1'
          },
          itemStyle: {
            color: '#6366f1'
          }
        },
        {
          name: '总内存分配(MiB)',
          type: 'line',
          yAxisIndex: 1,
          data: filteredTotalAllocData,
          symbol: 'circle',
          symbolSize: 4,
          symbolHoverSize: 8,
          smooth: true,
          lineStyle: {
            width: 3,
            color: '#ec4899'
          },
          itemStyle: {
            color: '#ec4899'
          }
        },
        {
          name: 'GC次数',
          type: 'line',
          yAxisIndex: 2,
          data: filteredGcCountData,
          symbol: 'circle',
          symbolSize: 4,
          symbolHoverSize: 8,
          smooth: true,
          lineStyle: {
            width: 3,
            color: '#8b5cf6'
          },
          itemStyle: {
            color: '#8b5cf6'
          }
        }
      ];

      chart.setOption(option);
    }

    // 更新所有图表
    function updateCharts() {
      updateCpuMemChart();
      updateQpsChart();
      updateLimiterChart();
      updateCacheHitChart();
      updateSystemOverviewChart();
    }

    // 渲染日志列表
    function renderLogList() {
      if (logData.filteredLogs.length === 0) {
        logList.innerHTML = `
          <div class="text-center text-gray-400 py-12">
            <div class="text-4xl mb-2"><i class="fa fa-file-text-o"></i></div>
            <p>暂无符合条件的日志</p>
          </div>
        `;
        return;
      }

      // 按时间倒序排序
      const sortedLogs = [...logData.filteredLogs].sort((a, b) => b.timestamp - a.timestamp);
      
      logList.innerHTML = sortedLogs.map(log => createLogEntryHTML(log)).join('');
    }

    // 创建日志条目HTML
    function createLogEntryHTML(log) {
      // 根据日志类型获取颜色和图标
      const logTypeInfo = getLogTypeInfo(log.type);
      const typeColor = logTypeInfo.color || 'bg-gray-400';
      const typeIcon = logTypeInfo.icon || 'fa-question-circle';
      const typeLabel = logTypeInfo.label || '未知类型';
      
      // 格式化时间
      const formattedTime = log.timestamp.toLocaleString('zh-CN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      
      // 构建详情HTML
      let detailsHTML = '';
      
      // 系统指标 - 支持标准格式和Go-Zero特有格式
      if (log.type === 'system') {
        if (log.cpuUsage !== undefined) {
          detailsHTML = `
            <div class="mt-2 text-sm text-gray-600 space-y-1">
              <div class="flex justify-between">
                <span>CPU使用率:</span>
                <span class="font-medium ${log.cpuUsage > 80 ? 'text-red-500' : log.cpuUsage > 60 ? 'text-yellow-500' : 'text-green-500'}">${log.cpuUsage}%</span>
              </div>
              <div class="flex justify-between">
                <span>内存使用率:</span>
                <span class="font-medium ${log.memoryUsage > 80 ? 'text-red-500' : log.memoryUsage > 60 ? 'text-yellow-500' : 'text-green-500'}">${log.memoryUsage}%</span>
              </div>`;
          
          // Go-Zero特有系统指标
          if (log.totalAlloc !== undefined) {
            detailsHTML += `
              <div class="flex justify-between">
                <span>总内存分配:</span>
                <span class="font-medium">${log.totalAlloc}Mi</span>
              </div>
              <div class="flex justify-between">
                <span>系统内存:</span>
                <span class="font-medium">${log.systemMemory}Mi</span>
              </div>`;
          }
          
          if (log.numGC !== undefined) {
            detailsHTML += `
              <div class="flex justify-between">
                <span>GC次数:</span>
                <span class="font-medium">${log.numGC}</span>
              </div>`;
          }
          
          detailsHTML += `
            </div>`;
        }
      }
      
      // 业务指标 - 支持标准格式和Go-Zero特有格式
      else if (log.type === 'business') {
        if (log.qps !== undefined) {
          detailsHTML = `
            <div class="mt-2 text-sm text-gray-600 space-y-1">`;
          
          // Go-Zero特有QPS格式
          if (log.qpsType !== undefined) {
            detailsHTML += `
              <div class="flex justify-between">
                <span>QPS类型:</span>
                <span class="font-medium">${log.qpsType}</span>
              </div>`;
          }
          
          detailsHTML += `
              <div class="flex justify-between">
                <span>QPS:</span>
                <span class="font-medium">${log.qps}</span>
              </div>`;
          
          if (log.drops !== undefined) {
            detailsHTML += `
              <div class="flex justify-between">
                <span>丢弃数:</span>
                <span class="font-medium ${log.drops > 0 ? 'text-red-500' : 'text-green-500'}">${log.drops}</span>
              </div>`;
          }
          
          // 显示响应时间指标（如果有）
          if (log.avgTime !== undefined) {
            detailsHTML += `
              <div class="flex justify-between">
                <span>平均响应时间:</span>
                <span class="font-medium">${log.avgTime}ms</span>
              </div>`;
          }
          
          if (log.p90Time !== undefined) {
            detailsHTML += `
              <div class="flex justify-between">
                <span>90%响应时间:</span>
                <span class="font-medium">${log.p90Time}ms</span>
              </div>`;
          }
          
          if (log.p99Time !== undefined) {
            detailsHTML += `
              <div class="flex justify-between">
                <span>99%响应时间:</span>
                <span class="font-medium">${log.p99Time}ms</span>
              </div>`;
          }
          
          if (log.p999Time !== undefined) {
            detailsHTML += `
              <div class="flex justify-between">
                <span>99.9%响应时间:</span>
                <span class="font-medium">${log.p999Time}ms</span>
              </div>`;
          }
          
          // 标准格式的错误QPS
          if (log.errorQps !== undefined && log.drops === undefined) {
            detailsHTML += `
              <div class="flex justify-between">
                <span>错误QPS:</span>
                <span class="font-medium ${log.errorQps > 0 ? 'text-red-500' : 'text-green-500'}">${log.errorQps}</span>
              </div>`;
          }
          
          detailsHTML += `
            </div>`;
        }
      }
      
      // 降载指标 - 支持标准格式和Go-Zero特有格式
      else if (log.type === 'limiter') {
        if (log.sheddingStatus !== undefined) {
          // Go-Zero特有限流格式
          detailsHTML = `
            <div class="mt-2 text-sm text-gray-600 space-y-1">
              <div class="flex justify-between">
                <span>CPU负载:</span>
                <span class="font-medium ${log.cpu > 80 ? 'text-red-500' : log.cpu > 60 ? 'text-yellow-500' : 'text-green-500'}">${log.cpu}%</span>
              </div>
              <div class="flex justify-between">
                <span>总请求数:</span>
                <span class="font-medium">${log.totalRequests}</span>
              </div>
              <div class="flex justify-between">
                <span>通过请求:</span>
                <span class="font-medium">${log.passRequests}</span>
              </div>
              <div class="flex justify-between">
                <span>丢弃请求:</span>
                <span class="font-medium ${log.dropRequests > 0 ? 'text-red-500' : 'text-green-500'}">${log.dropRequests}</span>
              </div>
              <div class="flex justify-between">
                <span>降载状态:</span>
                <span class="font-medium ${log.dropRequests > 0 ? 'text-red-500' : 'text-green-500'}">${log.sheddingStatus}</span>
              </div>
            </div>`;
        } else if (log.threshold !== undefined) {
          // 标准降载格式
          detailsHTML = `
            <div class="mt-2 text-sm text-gray-600 space-y-1">
              <div class="flex justify-between">
                <span>降载阈值:</span>
                <span class="font-medium">${log.threshold}</span>
              </div>
              <div class="flex justify-between">
                <span>当前值:</span>
                <span class="font-medium ${log.current > log.threshold ? 'text-red-500' : 'text-green-500'}">${log.current}</span>
              </div>
            </div>`;
        }
      }
      
      // 数据库缓存指标 - 支持标准格式和Go-Zero特有格式
      else if (log.type === 'dbCache') {
        if (log.cacheType !== undefined) {
          // Go-Zero特有缓存格式
          detailsHTML = `
            <div class="mt-2 text-sm text-gray-600 space-y-1">
              <div class="flex justify-between">
                <span>缓存类型:</span>
                <span class="font-medium">${log.cacheType}</span>
              </div>
              <div class="flex justify-between">
                <span>每分钟查询:</span>
                <span class="font-medium">${log.cacheQpm}</span>
              </div>
              <div class="flex justify-between">
                <span>缓存命中率:</span>
                <span class="font-medium ${log.cacheHitRatio < 90 ? 'text-yellow-500' : 'text-green-500'}">${log.cacheHitRatio}%</span>
              </div>
              <div class="flex justify-between">
                <span>命中次数:</span>
                <span class="font-medium">${log.cacheHits}</span>
              </div>
              <div class="flex justify-between">
                <span>未命中次数:</span>
                <span class="font-medium">${log.cacheMisses}</span>
              </div>
            </div>`;
        } else if (log.hitRate !== undefined) {
          // 标准缓存格式
          detailsHTML = `
            <div class="mt-2 text-sm text-gray-600 space-y-1">
              <div class="flex justify-between">
                <span>缓存命中率:</span>
                <span class="font-medium ${log.hitRate < 90 ? 'text-yellow-500' : 'text-green-500'}">${log.hitRate}%</span>
              </div>
              <div class="flex justify-between">
                <span>缓存未命中率:</span>
                <span class="font-medium ${log.missRate > 10 ? 'text-yellow-500' : 'text-gray-500'}">${log.missRate}%</span>
              </div>
            </div>`;
        }
      }
      
      // 所有日志类型都显示服务名
      if (log.service && log.service !== 'unknown') {
        // 在详情信息顶部添加服务名
        if (detailsHTML) {
          // 如果已经有详情，在第一个</div>前插入服务名信息
          detailsHTML = detailsHTML.replace('<div class="mt-2 text-sm text-gray-600 space-y-1">', 
            '<div class="mt-2 text-sm text-gray-600 space-y-1">\n              <div class="flex justify-between">\n                <span>服务名:</span>\n                <span class="font-medium">' + log.service + '</span>\n              </div>');
        } else {
          // 如果没有详情，创建包含服务名的详情
          detailsHTML = `
            <div class="mt-2 text-sm text-gray-600 space-y-1">
              <div class="flex justify-between">
                <span>服务名:</span>
                <span class="font-medium">${log.service}</span>
              </div>
            </div>`;
        }
      }
      
      // 应用详情信息（如果有）
      if (log.details && log.details.trim() && !detailsHTML) {
        detailsHTML = `
          <div class="mt-2 text-sm text-gray-600">
            <p>${log.details}</p>
          </div>
        `;
      }
      
      return `
        <div class="log-entry mb-2 p-3 rounded-md border border-gray-100 hover:border-gray-200 transition-all-300 bg-white">
          <div class="flex items-start justify-between gap-2">
            <div class="flex items-center gap-2 flex-1">
              <span class="inline-flex items-center justify-center w-8 h-8 rounded-full ${typeColor} text-white">
                <i class="fa ${typeIcon}"></i>
              </span>
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2">
                  <span class="font-medium text-sm truncate">${typeLabel}</span>
                  <span class="inline-block px-2 py-0.5 text-xs font-medium rounded-full bg-gray-100 text-gray-600">${log.level}</span>
                </div>
                <div class="text-xs text-gray-500 mt-0.5">${formattedTime} · ${log.fileName}:${log.lineNumber}</div>
                ${detailsHTML}
              </div>
            </div>
            <button class="text-gray-400 hover:text-primary transition-colors text-sm view-raw-btn" title="查看原始日志">
              <i class="fa fa-code"></i>
            </button>
          </div>
          <div class="raw-log hidden mt-2 p-2 bg-gray-50 rounded-md text-xs text-gray-600 font-mono overflow-x-auto">${escapeHtml(log.raw)}</div>
        </div>
      `;
    }

    // 获取日志类型信息
    function getLogTypeInfo(type) {
      const typeMap = {
        system: {
          color: 'bg-blue-500',
          icon: 'fa-server',
          label: '系统指标'
        },
        limiter: {
          color: 'bg-yellow-500',
          icon: 'fa-exclamation-triangle',
          label: '降载指标'
        },
        business: {
          color: 'bg-green-500',
          icon: 'fa-line-chart',
          label: '业务指标'
        },
        dbCache: {
          color: 'bg-purple-500',
          icon: 'fa-database',
          label: '数据库缓存'
        },
        general: {
          color: 'bg-gray-500',
          icon: 'fa-info-circle',
          label: '通用日志'
        },
        error: {
          color: 'bg-red-500',
          icon: 'fa-exclamation-circle',
          label: '解析错误'
        },
        unknown: {
          color: 'bg-gray-400',
          icon: 'fa-question-circle',
          label: '未知类型'
        }
      };
      
      return typeMap[type] || typeMap.unknown;
    }

    // HTML转义
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // 处理过滤变更
    function handleFilterChange() {
      // 如果全选被点击，同步其他复选框状态
      if (event.target === filterAll) {
        const isChecked = filterAll.checked;
        filterSystem.checked = isChecked;
        filterLimiter.checked = isChecked;
        filterBusiness.checked = isChecked;
        filterDbCache.checked = isChecked;
      } else {
        // 如果其他复选框被点击，检查是否需要更新全选状态
        const allChecked = filterSystem.checked && filterLimiter.checked && filterBusiness.checked && filterDbCache.checked;
        filterAll.checked = allChecked;
      }
      
      // 应用过滤
      applyFilters();
    }

    // 应用过滤器
    function applyFilters() {
      const searchTerm = logSearch.value.toLowerCase();
      
      logData.filteredLogs = logData.allLogs.filter(log => {
        // 类型过滤 - 包括通用日志类型
        let typeMatch = filterAll.checked;
        if (!typeMatch) {
          typeMatch = 
            (filterSystem.checked && ['system'].includes(log.type)) ||
            (filterLimiter.checked && ['limiter'].includes(log.type)) ||
            (filterBusiness.checked && ['business'].includes(log.type)) ||
            (filterDbCache.checked && ['dbCache'].includes(log.type)) ||
            ['general', 'error', 'unknown'].includes(log.type); // 通用日志、错误和未知类型总是显示
        }
        
        // 搜索过滤
        const searchMatch = searchTerm === '' || 
          log.raw.toLowerCase().includes(searchTerm) ||
          (log.details && log.details.toLowerCase().includes(searchTerm)) ||
          log.fileName.toLowerCase().includes(searchTerm);
        
        return typeMatch && searchMatch;
      });
      
      // 重新渲染日志列表
      renderLogList();
      
      // 更新日志计数
      logCount.textContent = `${logData.filteredLogs.length} 条日志`;
    }

    // 处理日志搜索
    function handleLogSearch() {
      applyFilters();
    }

    // 清空所有数据
    function clearAllData(showNotification = true) {
      // 重置数据存储
      logData.allLogs = [];
      logData.filteredLogs = [];
      logData.systemLogs = [];
      logData.limiterLogs = [];
      logData.businessLogs = [];
      logData.dbCacheLogs = [];
      
      // 重置时间序列数据
      logData.timeSeriesData = {
        timestamps: [],
        cpuUsage: [],
        memoryUsage: [],
        qps: [],
        errorQps: [],
        limiterThreshold: [],
        limiterCurrent: []
      };
      
      // 重置UI
      renderLogList();
      updateCharts();
      updateCounters();
      logSearch.value = '';
      
      // 重置过滤器
      filterAll.checked = true;
      filterSystem.checked = true;
      filterLimiter.checked = true;
      filterBusiness.checked = true;
      filterDbCache.checked = true;
      
      if (showNotification) {
        showNotification('所有数据已清空', 'success');
      }
    }

    // 导出分析结果
    function exportAnalysisResults() {
      if (logData.allLogs.length === 0) {
        showNotification('没有数据可导出', 'warning');
        return;
      }
      
      const exportData = {
        analysisTime: new Date().toISOString(),
        totalLogs: logData.allLogs.length,
        systemLogs: logData.systemLogs.length,
        limiterLogs: logData.limiterLogs.length,
        businessLogs: logData.businessLogs.length,
        dbCacheLogs: logData.dbCacheLogs.length,
        timeSeriesData: logData.timeSeriesData
      };
      
      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `gozero-stats-analysis-${new Date().toISOString().slice(0, 19).replace(/[:.]/g, '-')}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      showNotification('分析结果已导出', 'success');
    }

    // 分析完成后的最终处理
    function finalizeAnalysis() {
      // 应用当前过滤器
      applyFilters();
      
      // 更新图表
      updateCharts();
      
      // 更新计数器
      updateCounters();
      
      // 事件委托已在init函数中设置，无需在此添加事件监听器
      
      showNotification(`成功处理 ${logData.allLogs.length} 条日志`, 'success');
    }

    // 更新计数器
    function updateCounters() {
      totalLinesCount.textContent = logData.allLogs.length;
      systemLogCount.textContent = logData.systemLogs.length;
      businessLogCount.textContent = logData.businessLogs.length;
      limiterLogCount.textContent = logData.limiterLogs.length;
      logCount.textContent = `${logData.filteredLogs.length} 条日志`;
    }

    // 显示加载动画
    function showLoading() {
      loadingOverlay.classList.remove('hidden');
      loadingProgress.style.width = '0%';
    }

    // 隐藏加载动画
    function hideLoading() {
      loadingOverlay.classList.add('hidden');
    }

    // 更新加载进度
    function updateLoadingProgress(progress) {
      const percentage = Math.min(100, Math.max(0, progress * 100));
      loadingProgress.style.width = `${percentage}%`;
      
      if (percentage < 100) {
        loadingMessage.textContent = `正在处理数据... ${Math.round(percentage)}%`;
      } else {
        loadingMessage.textContent = '正在生成图表...';
      }
    }

    // 显示通知
    function showNotification(message, type = 'info') {
      // 创建通知元素
      const notification = document.createElement('div');
      
      // 设置样式和内容
      let bgColor = 'bg-blue-500';
      let icon = 'fa-info-circle';
      
      switch (type) {
        case 'success':
          bgColor = 'bg-green-500';
          icon = 'fa-check-circle';
          break;
        case 'error':
          bgColor = 'bg-red-500';
          icon = 'fa-exclamation-circle';
          break;
        case 'warning':
          bgColor = 'bg-yellow-500';
          icon = 'fa-exclamation-triangle';
          break;
      }
      
      notification.className = `fixed top-4 right-4 ${bgColor} text-white px-4 py-3 rounded-md shadow-lg transform transition-all duration-300 ease-in-out translate-x-full z-50`;
      notification.innerHTML = `
        <div class="flex items-center gap-3">
          <i class="fa ${icon} text-xl"></i>
          <span>${message}</span>
        </div>
      `;
      
      // 添加到文档
      document.body.appendChild(notification);
      
      // 显示通知
      setTimeout(() => {
        notification.classList.remove('translate-x-full');
      }, 10);
      
      // 3秒后隐藏通知
      setTimeout(() => {
        notification.classList.add('translate-x-full');
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>